(globalThis.webpackChunk_croquet_microverse=globalThis.webpackChunk_croquet_microverse||[]).push([[128],{3128:(e,t,s)=>{"use strict";s.d(t,{q:()=>MultiBlaster});t=s(4200),s=s(3654);class MultiBlaster extends s.Z4{get pawn(){return MultiBlasterDisplay}init(e){super.init(e),this.beWellKnownAs("multiBlaster"),this.ships=new Map,this.asteroids=new Set,this.blasts=new Set,this.subscribe(this.sessionId,"view-join",this.viewJoined),this.subscribe(this.sessionId,"view-exit",this.viewExited),this.subscribe(this.sessionId,"switch-pause",this.switchPause),Asteroid.create({}),this.active=!0,this.mainLoop()}switchPause(){console.log("switchPaused!!!!"),this.active=!this.active}viewJoined(e){var t=Ship.create({viewId:e});this.ships.set(e,t)}viewExited(e){const t=this.ships.get(e);this.ships.delete(e),t.destroy()}checkCollisions(){for(const r of this.asteroids)if(!r.wasHit){var e=r.x-r.size,t=r.x+r.size,s=r.y-r.size,i=r.y+r.size;for(const a of this.blasts)if(a.x>e&&a.x<t&&a.y>s&&a.y<i){r.hitBy(a);break}for(const o of this.ships.values())if(!o.wasHit&&o.x+10>e&&o.x-10<t&&o.y+10>s&&o.y-10<i&&(o.score||!(Math.abs(o.x-512)+Math.abs(o.y-512)<40))){o.hitBy(r);break}}}mainLoop(){if(this.active){for(const e of this.ships.values())e.move();for(const t of this.asteroids)t.move();for(const s of this.blasts)s.move();this.checkCollisions()}this.future(50).mainLoop()}}MultiBlaster.register("MultiBlaster");class Ship extends t.Actor{init({viewId:e}){super.init(),this.viewId=e,this.reset(),this.subscribe(e,"left-thruster",this.leftThruster),this.subscribe(e,"right-thruster",this.rightThruster),this.subscribe(e,"forward-thruster",this.forwardThruster),this.subscribe(e,"fire-blaster",this.fireBlaster)}reset(){this.x=512,this.y=512,this.a=-Math.PI/2,this.dx=0,this.dy=0,this.left=!1,this.right=!1,this.forward=!1,this.score=0,this.wasHit=0}leftThruster(e){this.wasHit||(this.left=e)}rightThruster(e){this.wasHit||(this.right=e)}forwardThruster(e){this.wasHit||(this.forward=e)}fireBlaster(){var e,t,s,i;this.wasHit||(e=20*Math.cos(this.a),t=20*Math.sin(this.a),s=this.x+e,i=this.y+t,Blast.create({x:s,y:i,dx:e,dy:t,ship:this}))}move(){this.wasHit?60<++this.wasHit&&this.reset():(this.forward&&(this.dx+=.5*Math.cos(this.a),this.dy+=.5*Math.sin(this.a),10<this.dx&&(this.dx=10),this.dx<-10&&(this.dx=-10),10<this.dy&&(this.dy=10),this.dy<-10&&(this.dy=-10)),this.left&&(this.a-=.2),this.right&&(this.a+=.2),this.a<0&&(this.a+=2*Math.PI),this.a>2*Math.PI&&(this.a-=2*Math.PI)),this.x+=this.dx,this.y+=this.dy,this.x<0&&(this.x+=1024),1024<this.x&&(this.x-=1024),this.y<0&&(this.y+=1024),1024<this.y&&(this.y-=1024)}hitBy(e){this.wasHit=1,e.wasHit=1}}Ship.register("Ship");class Asteroid extends t.Actor{init({size:e,x:t,y:s,a:i,dx:r,dy:a,da:o}){super.init(),e?(this.size=e,this.x=t,this.y=s,this.a=i,this.dx=r,this.dy=a,this.da=o):(this.size=40,this.x=400*Math.random()-200,this.y=400*Math.random()-200,this.a=Math.random()*Math.PI*2,e=4*Math.random()+1,this.dx=Math.cos(this.a)*e,this.dy=Math.sin(this.a)*e,this.da=(.02+.03*Math.random())*(Math.random()<.5?1:-1),this.wasHit=0,this.move()),this.wellKnownModel("multiBlaster").asteroids.add(this)}move(){this.wasHit&&++this.wasHit>this.size&&this.destroy(),this.x+=this.dx,this.y+=this.dy,this.x<0&&(this.x+=1024),1024<this.x&&(this.x-=1024),this.y<0&&(this.y+=1024),1024<this.y&&(this.y-=1024),this.wasHit||(this.a+=this.da,this.a<0&&(this.a+=2*Math.PI),this.a>2*Math.PI&&(this.a-=2*Math.PI))}hitBy(e){e.ship.wasHit||e.ship.score++,20<this.size?(this.size*=.7,this.da*=1.5,this.dx=10*-e.dy/this.size,this.dy=10*e.dx/this.size,Asteroid.create({size:this.size,x:this.x,y:this.y,a:this.a,dx:-this.dx,dy:-this.dy,da:this.da})):this.wasHit=1,e.destroy()}destroy(){const e=this.wellKnownModel("multiBlaster").asteroids;e.delete(this),super.destroy(),e.size<5&&Asteroid.create({})}}Asteroid.register("Asteroid");class Blast extends t.Actor{init({x:e,y:t,dx:s,dy:i,ship:r}){super.init(),this.ship=r,this.x=e,this.y=t,this.dx=s,this.dy=i,this.t=0,this.wellKnownModel("multiBlaster").blasts.add(this)}move(){++this.t<30?(this.x+=this.dx,this.y+=this.dy,this.x<0&&(this.x+=1024),1024<this.x&&(this.x-=1024),this.y<0&&(this.y+=1024),1024<this.y&&(this.y-=1024)):this.destroy()}destroy(){this.wellKnownModel("multiBlaster").blasts.delete(this),super.destroy()}}Blast.register("Blast");class MultiBlasterDisplay extends s.Df{constructor(e){super(e),this.addEventListener("pointerDown","onPointerDown"),this.addEventListener("pointerMove","onPointerMove"),this.addEventListener("pointerUp","onPointerUp"),this.addEventListener("keyDown","onKeyDown"),this.addEventListener("keyUp","onKeyUp"),this.smoothing=new WeakMap,this.context=this.canvas.getContext("2d"),this.future(50).doUpdate()}onPointerDown(e){e.uv&&(this.joystick=this.uv2xy(e.uv),this.knob=this.joystick)}onPointerMove(e){var t;e.uv&&(this.knob=this.uv2xy(e.uv),e=this.knob[0]-this.joystick[0],t=this.knob[1]-this.joystick[1],30<e?this.right||(this.publish(this.viewId,"right-thruster",!0),this.right=!0):this.right&&(this.publish(this.viewId,"right-thruster",!1),this.right=!1),e<-30?this.left||(this.publish(this.viewId,"left-thruster",!0),this.left=!0):this.left&&(this.publish(this.viewId,"left-thruster",!1),this.left=!1),t<-30?this.forward||(this.publish(this.viewId,"forward-thruster",!0),this.forward=!0):this.forward&&(this.publish(this.viewId,"forward-thruster",!1),this.forward=!1))}onPointerUp(e){e.uv&&(this.right||this.left||this.forward||this.publish(this.viewId,"fire-blaster"),this.right&&(this.publish(this.viewId,"right-thruster",this.false),this.right=!1),this.left&&(this.publish(this.viewId,"left-thruster",!1),this.left=!1),this.forward&&(this.publish(this.viewId,"forward-thruster",!1),this.forward=!1),this.joystick=null,this.knob=null)}onPointerCancel(e){this.onPointerUp(e)}onKeyDown(e){if(!e.repeat)switch(e.key){case"a":case"A":case"ArrowLeft":this.publish(this.viewId,"left-thruster",!0);break;case"d":case"D":case"ArrowRight":this.publish(this.viewId,"right-thruster",!0);break;case"w":case"W":case"ArrowUp":this.publish(this.viewId,"forward-thruster",!0);break;case" ":this.publish(this.viewId,"fire-blaster");break;case"p":case"P":this.publish(this.actor.sessionId,"switch-pause")}}onKeyUp(e){if(!e.repeat)switch(e.key){case"a":case"A":case"ArrowLeft":this.publish(this.viewId,"left-thruster",!1);break;case"d":case"D":case"ArrowRight":this.publish(this.viewId,"right-thruster",!1);break;case"w":case"W":case"ArrowUp":this.publish(this.viewId,"forward-thruster",!1)}}setup(){}doUpdate(){if(this.actor.active){this.context.clearRect(0,0,1024,1024),this.context.font="40px sans-serif",this.context.fillStyle="rgba(255, 255, 255, 0.5)",this.context.lineWidth=3,this.context.strokeStyle="white";for(const l of this.actor.ships.values()){var{x:e,y:t,a:s}=this.smoothPosAndAngle(l);this.context.save(),this.context.translate(e,t),l.score&&this.context.fillText(l.score,30,15),this.context.rotate(s),l.wasHit?this.drawShipDebris(l.wasHit):this.drawShip(l.forward,l.viewId===this.viewId),this.context.restore()}for(const h of this.actor.asteroids){var{x:i,y:r,a}=this.smoothPosAndAngle(h);this.context.save(),this.context.translate(i,r),this.context.rotate(a),h.wasHit?this.drawAsteroidDebris(h.size,2*h.wasHit):this.drawAsteroid(h.size),this.context.restore()}for(const d of this.actor.blasts){var{x:o,y:n}=this.smoothPos(d);this.context.save(),this.context.translate(o,n),this.drawBlast(),this.context.restore()}this.joystick&&this.drawJoystick(),this.texture.needsUpdate=!0}this.future(50).doUpdate()}smoothPos(e){this.smoothing.has(e)||this.smoothing.set(e,{x:e.x,y:e.y,a:e.a});const t=this.smoothing.get(e);var s=e.x-t.x,i=e.y-t.y;return Math.abs(s)<50?t.x+=.3*s:t.x=e.x,Math.abs(i)<50?t.y+=.3*i:t.y=e.y,t}smoothPosAndAngle(e){const t=this.smoothPos(e);var s=e.a-t.a;return Math.abs(s)<1?t.a+=.3*s:t.a=e.a,t}drawJoystick(){this.drawCircle(this.joystick,50,!1),this.drawCircle(this.knob,25,!0)}drawCircle(e,t,s){this.context.fillStyle="#ffffff",this.context.beginPath(),this.context.arc(e[0],e[1],t,0,2*Math.PI,!0),s?this.context.fill():this.context.stroke()}drawShip(e,t){this.context.beginPath(),this.context.moveTo(20,0),this.context.lineTo(-20,10),this.context.lineTo(-20,-10),this.context.closePath(),this.context.stroke(),t&&this.context.fill(),e&&(this.context.beginPath(),this.context.moveTo(-20,5),this.context.lineTo(-30,0),this.context.lineTo(-20,-5),this.context.stroke())}drawShipDebris(e){this.context.beginPath(),this.context.moveTo(20+e,0+e),this.context.lineTo(-20+e,10+e),this.context.moveTo(-20-1.4*e,10),this.context.lineTo(-20-1.4*e,-10),this.context.moveTo(-20+e,-10-e),this.context.lineTo(20+e,0-e),this.context.stroke()}drawAsteroid(e){this.context.beginPath(),this.context.moveTo(+e,0),this.context.lineTo(0,+e),this.context.lineTo(-e,0),this.context.lineTo(0,-e),this.context.closePath(),this.context.stroke()}drawAsteroidDebris(e,t){this.context.beginPath(),this.context.moveTo(+e+t,0+t),this.context.lineTo(0+t,+e+t),this.context.moveTo(-e-t,0-t),this.context.lineTo(0-t,-e-t),this.context.moveTo(-e-t,0+t),this.context.lineTo(0-t,+e+t),this.context.moveTo(+e+t,0-t),this.context.lineTo(0+t,-e-t),this.context.stroke()}drawBlast(){this.context.beginPath(),this.context.ellipse(0,0,2,2,0,0,2*Math.PI),this.context.closePath(),this.context.stroke()}}},2691:(e,t,s)=>{"use strict";s.d(t,{CN:()=>o,vJ:()=>a,w9:()=>r});var i=s(4200);const r=e=>class extends e{init(e){super.init(e),this.eventListeners=new Map,this.listen("dispatchEvent",this.dispatchEvent)}dispatchEvent(e){let{eventName:t,evt:i}=e,s=this.eventListeners.get(t);s&&s.forEach(e=>{var{moduleName:e,behaviorName:t,listener:s}=e;e&&t?this.call(e+"$"+t,s,i):this[s](i)})}addEventListener(t,s){var e=s;"function"==typeof s&&(s=s.name);let i,r;var a=s.indexOf("$"),a=(1<=a&&(r=s.slice(0,a),s=s.slice(a+1)),s.indexOf(".")),a=(1<=a&&(i=s.slice(0,a),s=s.slice(a+1)),this._behavior);!r&&a&&(r=a.module.externalName),!i&&a&&(i=a.$behaviorName);let o=this.eventListeners.get(t);o||(o=[],this.eventListeners.set(t,o)),0<=o.findIndex(e=>e.eventName===t&&e.listener===s&&e.moduleName===r&&e.behaviorName===i)&&this.removeEventListener(t,e,!0),o.push({moduleName:r,behaviorName:i,eventName:t,listener:s}),this.say("registerEventListener",{eventName:t,listener:s})}removeEventListener(e,t,s){"function"==typeof t&&(t=t.name);let i=this._behavior.$behaviorName,r=this._behavior.module.externalName,a=this.eventListeners.get(e);var o;!a||(o=a.findIndex(e=>e.behaviorName===i&&e.moduleName===r&&e.listener===t))<0||(a.splice(o,1),0===a.length&&(s||this.eventListeners.delete(e),this.say("unregisterEventListener",{eventName:e,listener:t})))}},a=((0,i.RegisterMixin)(r),e=>class extends e{constructor(e){super(e),this.eventListeners=new Map,this.modelListeners=new Map,this.listen("registerEventListener","registerEventListener"),this.listen("unregisterEventListener","unregisterEventListener"),this.registerAllEventListeners()}destroy(){var e=this.actor.service("PlayerManager").players.get(this.viewId);const t=(0,i.GetPawn)(e.id);t&&(t.hoverPawn===this&&(t.hoverPawn=null),t.focusPawn===this&&(t.focusPawn=null)),super.destroy()}addEventListener(t,e,s){var i=e;"string"==typeof e?(s=e,e=e=>this[s](e)):s=s||e.name;let r=this.eventListeners.get(t);r||(r=[],this.eventListeners.set(t,r)),r.find(e=>e.name===s&&e.eventName===t)&&this.removeEventListener(t,i,s),r.push({name:s,eventName:t,listener:e})}removeEventListener(t,e,s){s="string"==typeof e?e:s||e.name;let i=this.eventListeners.get(t);!i||(e=i.findIndex(e=>e.name===s&&e.eventName===t))<0||i.splice(e,1)}registerEventListener(e){let t=e["eventName"];e=e=>this.say("dispatchEvent",{eventName:t,evt:e});this.modelListeners.set(t,e),this.addEventListener(t,e,"dispatch_"+t)}unregisterEventListener(e){var e=e["eventName"],t=this.modelListeners.get(e);t&&this.removeEventListener(e,t,"dispatch_"+e)}registerAllEventListeners(){if(this.actor.eventListeners)for(var e of this.actor.eventListeners.keys())this.registerEventListener({eventName:e})}}),o=e=>class extends e{constructor(e){super(e),this.isMyPlayerPawn&&(this.subscribe("input","pointerDown",this.doPointerDown),this.subscribe("input","pointerUp",this.doPointerUp),this.subscribe("input","pointerMove",this.doPointerMove),this.subscribe("input","click",this.doPointerClick),this.subscribe("input","wheel",this.doPointerWheel),this.subscribe("input","doubleDown",this.doPointerDoubleDown),this.subscribe("input","tap",this.doPointerTap),this.subscribe("input","keyDown",this.doKeyDown),this.subscribe("input","keyUp",this.doKeyUp),this.firstResponders=new Map,this.lastResponders=new Map)}modifierEqual(e,t){return!!e.altKey==!!t.altKey&&!!e.ctrlKey==!!t.ctrlKey&&!!e.metaKey==!!t.metaKey&&!!e.shiftKey==!!t.shiftKey}addResponder(e,s,i,r){r._target&&(r=r._target);let a=["altKey","shiftKey","ctrlKey","metaKey"],o=e.get(s);o||(o=[],e.set(s,o)),function has(){for(let e=0;e<o.length;e++){var s=o[e];let t=!0;for(let e=0;e<a.length;e++)t=t&&s.eventMask[a[e]]===i[a[e]];if(s.pawn===r&&t)return 1}}()||(o.forEach(t=>{for(let e=0;e<a.length;e++)if(t.eventMask[a[e]]&&i[a[e]])throw new Error(a[e]+" is already handled for "+s)}),o.unshift({eventMask:i,pawn:r}))}removeResponder(e,t,r,s){s._target&&(s=s._target);let i=e.get(t);!i||0<=(e=i.findIndex(t=>{var s=["altKey","shiftKey","ctrlKey","metaKey"];let i=!0;for(let e=0;e<s.length;e++)t.eventMask[s[e]]&&(i=i&&r[s[e]]);return i}))&&i[e].pawn===s&&i.splice(e,1)}findResponder(e,a,t,o){let s=e.get(t);if(!s)return null;e=s.findIndex(t=>{var s=["altKey","shiftKey","ctrlKey","metaKey"];let i=!0,r=!1;for(let e=0;e<s.length;e++)a[s[e]]&&(r=!0,i=i&&t.eventMask[s[e]]);return!(!o||0!==Object.keys(t.eventMask).length||r)||!(o&&!r)&&i});return 0<=e?s[e].pawn:null}addFirstResponder(e,t,s){return this.addResponder(this.firstResponders,e,t,s)}removeFirstResponder(e,t,s){return this.removeResponder(this.firstResponders,e,t,s)}findFirstResponder(e,t){return this.findResponder(this.firstResponders,e,t,!0)}addLastResponder(e,t,s){return this.addResponder(this.lastResponders,e,t,s)}removeLastResponder(e,t,s){return this.removeResponder(this.lastResponders,e,t,s)}findLastResponder(e,t){return this.findResponder(this.lastResponders,e,t,!1)}destroy(){super.destroy()}getTargets(t,e){const s=this.service("ThreeRenderManager");let i=e?s.threeLayerUnion("pointer","walk"):s.threeLayer("pointer");return i.filter(e=>{e=e.wcPawn.eventListeners.get(t);return e&&0!==e.length})}invokeListeners(e,t,s,i){let r=t.eventListeners.get(e),a;a=s?this.pointerEvent(s,i):i,r&&r.forEach(e=>e.listener.call(t,a))}pointerCapture(e){this.focusPawn=e}doPointerDown(e){var t="pointerDown",s=this.pointerRaycast(e.xy,this.getTargets(t)),i=this.findFirstResponder(e,t);if(i)return this.invokeListeners(t,i,s,e);if(0===e.button&&(this.isPointerDown=!0,this.focusPawn!==s.pawn&&(this.focusPawn=s.pawn)),this.focusPawn)this.invokeListeners(t,this.focusPawn,s,e);else{i=this.findLastResponder(e,t);if(i)return this.invokeListeners(t,i,s,e)}}doPointerUp(e){var t="pointerUp",s=this.pointerRaycast(e.xy,this.getTargets(t)),i=(this.isPointerDown=!1,this.findFirstResponder(e,t));if(i)return this.invokeListeners(t,i,s,e);this.focusPawn&&this.invokeListeners(t,this.focusPawn,s,e);i=this.findLastResponder(e,t);return i?this.invokeListeners(t,i,s,e):void 0}doPointerMove(e){var t="pointerMove",s=this.pointerRaycast(e.xy,this.getTargets(t)),i=this.findFirstResponder(e,t);if(i)return this.invokeListeners(t,i,s,e);if(this.hoverPawn!==s.pawn&&(this.hoverPawn&&this.invokeListeners("pointerLeave",this.hoverPawn,s,e),this.hoverPawn=s.pawn,this.hoverPawn&&this.invokeListeners("pointerEnter",this.hoverPawn,s,e)),this.isPointerDown&&this.focusPawn&&this.focusPawn===s.pawn)this.invokeListeners(t,this.focusPawn,s,e);else{i=this.findLastResponder(e,t);if(i)return this.invokeListeners(t,i,s,e)}}doPointerClick(e){var t="click",s=this.pointerRaycast(e.xy,this.getTargets(t)),i=this.findFirstResponder(e,t);if(i)return this.invokeListeners(t,i,s,e);if(s.pawn)this.invokeListeners(t,s.pawn,s,e);else{i=this.findLastResponder(e,t);if(i)return this.invokeListeners(t,i,s,e)}}doPointerDoubleDown(e){var t="pointerDoubleDown",s=this.pointerRaycast(e.xy,this.getTargets(t,!0),!0),i=this.findFirstResponder(e,t);if(i)return this.invokeListeners(t,i,s,e);s.pawn&&this.invokeListeners(t,s.pawn,s,e)}doPointerWheel(e){var t="pointerWheel",s=this.pointerRaycast(e.xy,this.getTargets(t,!0),!0),i=this.findFirstResponder(e,t);if(i)return this.invokeListeners(t,i,s,e);if(s.pawn)this.invokeListeners(t,s.pawn,s,e);else{i=this.findLastResponder(e,t);if(i)return this.invokeListeners(t,i,s,e)}}doPointerTap(e){var t="pointerTap",s=this.pointerRaycast(e.xy,this.getTargets(t)),i=this.findFirstResponder(e,t);if(i)return this.invokeListeners(t,i,s,e);if(s.pawn)this.invokeListeners(t,s.pawn,s,e);else{i=this.findLastResponder(e,t);if(i)return this.invokeListeners(t,i,s,e)}}doKeyDown(e){var t="keyDown",s=this.findFirstResponder(e,t);if(s)return this.invokeListeners(t,s,null,e);if(this.focusPawn)this.invokeListeners(t,this.focusPawn,null,e);else{s=this.findLastResponder(e,t);if(s)return this.invokeListeners(t,s,null,e)}}doKeyUp(e){var t="keyUp",s=this.findFirstResponder(e,t);if(s)return this.invokeListeners(t,s,null,e);this.focusPawn&&this.invokeListeners(t,this.focusPawn,null,e);s=this.findLastResponder(e,t);return s?this.invokeListeners(t,s,null,e):void 0}pointerEvent(e,t){const s={avatarId:this.actor.id};return e.pawn&&(s.targetId=e.pawn.actor.id,s.xyz=e.xyz,s.uv=e.uv,s.normal=e.normal,s.distance=e.distance),s.ctrlKey=t.ctrlKey,s.altKey=t.altKey,s.shiftKey=t.shiftKey,s.metaKey=t.metaKey,s.xy=t.xy,s.id=t.id,s.button=t.button,s.buttons=t.buttons,void 0!==t.deltaY&&(s.deltaY=t.deltaY),s}}},5679:(e,t,s)=>{"use strict";s.r(t),s.d(t,{PM_ThreeCamera:()=>E,PM_ThreeVisible:()=>M,THREE:()=>b,THREE_MESH_BVH:()=>i,ThreeRenderManager:()=>ThreeRenderManager});var t=s(9477),i=s(5919),r=s(2108),a=s(4458),o=s(8304),n=s(1154),l=s(3194),h=s(8025),d=s(9778),c=s(7011),u=s(6023),p=s(1217),f=s(452),m=s(2854),y=s(1367),g=s(1259),v=s(140),w=s(7157),_=s(1711),x=s(4200);const M=e=>class extends(0,x.PM_Visible)(e){constructor(...e){super(...e),this.listen("viewGlobalChanged",this.refreshDrawTransform)}destroy(){super.destroy();const e=this.service("ThreeRenderManager");e&&e.scene&&(this.renderObject&&e.scene.remove(this.renderObject),this.colliderObject&&e.scene.remove(this.colliderObject))}refreshDrawTransform(){this.renderObject&&(this.renderObject.matrix.fromArray(this.global),this.renderObject.matrixWorldNeedsUpdate=!0),this.colliderObject&&(this.colliderObject.matrix.fromArray(this.global),this.colliderObject.matrixWorldNeedsUpdate=!0)}setRenderObject(e){const t=this.service("ThreeRenderManager");t&&t.dirtyAllLayers(),(e.wcPawn=this).renderObject=e,this.renderObject.matrixAutoUpdate=!1,this.renderObject.matrix.fromArray(this.global),this.renderObject.matrixWorldNeedsUpdate=!0,t&&t.scene&&t.scene.add(this.renderObject),this.onSetRenderObject&&this.onSetRenderObject(e)}setColliderObject(e){const t=this.service("ThreeRenderManager");t&&t.dirtyAllLayers(),(e.wcPawn=this).colliderObject=e,this.colliderObject.matrixAutoUpdate=!1,this.colliderObject.matrix.fromArray(this.global),this.colliderObject.matrixWorldNeedsUpdate=!0,t&&t.scene&&t.scene.add(this.colliderObject)}},E=e=>class extends(0,x.PM_Camera)(e){constructor(...e){if(super(...e),this.isMyPlayerPawn){const t=this.service("ThreeRenderManager");t.camera.matrix.fromArray(this.lookGlobal),t.camera.matrixAutoUpdate=!1,t.camera.matrixWorldNeedsUpdate=!0,this.listen("lookGlobalChanged",this.refreshCameraTransform),this.listen("viewGlobalChanged",this.refreshCameraTransform)}}refreshCameraTransform(){const e=this.service("ThreeRenderManager");e.camera.matrix.fromArray(this.lookGlobal),e.camera.matrixWorldNeedsUpdate=!0}setRayCast(e){var t=e[0]/window.innerWidth*2-1,e=2*-(e[1]/window.innerHeight)+1,s=this.service("ThreeRenderManager");return this.raycaster||(this.raycaster=new b.Raycaster),this.raycaster.setFromCamera({x:t,y:e},s.camera),this.raycaster}pointerRaycast(e,t,s){this.setRayCast(e);const i=this.service("ThreeRenderManager");var r=this.raycaster.intersectObjects(t||i.threeLayer("pointer"));if(0===r.length)return{};let a,o;if(s)for(let s=0;s<r.length;s++){let e=r[s].object,t=e.wcPawn;for(;!t&&e;)e=e.parent,t=e.wcPawn;if(t){o=t.hitNormal,Array.isArray(o)&&(o=new b.Vector3(...o)),a=r[s];break}}return a=a||r[0],(o=a.face&&!o?a.face.normal:o)&&(e=(new b.Matrix3).getNormalMatrix(a.object.matrixWorld),o=o.clone().applyMatrix3(e).normalize()),{pawn:this.getPawn(a.object),xyz:a.point.toArray(),uv:a.uv?a.uv.toArray():void 0,normal:o?o.toArray():void 0,distance:a.distance}}getPawn(e){let t=e;for(;!t.wcPawn;){if(!t.parent)return null;t=t.parent}return t.wcPawn}};class ThreeRenderManager extends x.RenderManager{constructor(e={},t){super(e,t||"ThreeRenderManager"),this.threeLayers={},this.scene=new b.Scene,this.camera=new b.PerspectiveCamera(60,window.innerWidth/window.innerHeight,.1,1e4),e.canvas||(this.canvas=document.createElement("canvas"),this.canvas.id="ThreeCanvas",this.canvas.style.cssText="position: absolute; left: 0; top: 0; z-index: 0",document.body.insertBefore(this.canvas,null),e.canvas=this.canvas),this.renderer=new b.WebGLRenderer(e),this.renderer.shadowMap.enabled=!0,this.composer=new r.xC(this.renderer),this.renderPass=new a.C(this.scene,this.camera),this.composer.addPass(this.renderPass),this.resize(),this.subscribe("input","resize",()=>this.resize()),this.setRender(!0)}setRender(e){this.doRender=e}destroy(){super.destroy(),this.renderer.dispose(),this.canvas&&this.canvas.remove()}resize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight),this.composer.setSize(window.innerWidth,window.innerHeight)}dirtyLayer(e){this.threeLayers[e]=null}dirtyAllLayers(){this.threeLayers={}}threeLayer(e){return this.layers[e]?(this.threeLayers[e]||(this.threeLayers[e]=Array.from(this.layers[e]).map(e=>e.colliderObject||e.renderObject)),this.threeLayers[e]):[]}threeLayerUnion(...e){let t=[];for(;0<e.length;){const s=this.threeLayer(e.pop());t=t.concat(s.filter(e=>t.indexOf(e)<0))}return t}update(){this.doRender&&this.composer.render()}}const b={...t,Pass:o.w,CopyShader:n.C,CSMFrustum:l.$,CSMShader:h.G,CSM:d.j,OBJLoader:c.L,MTLLoader:u.v,GLTFLoader:p.E,FBXLoader:f.y,DRACOLoader:m._,SVGLoader:y.u,EXRLoader:g.I,BufferGeometryUtils:v,FontLoader:w.J,Font:w.Z,TextGeometry:_.M}},3782:(e,t,s)=>{"use strict";s.d(t,{bR:()=>function addShadows(e,t,s,i){e.traverse(e=>{e.material&&(s&&(e.material.side=i.FrontSide),e.material.format=i.RGBAFormat,t&&(e.castShadow=!0,e.receiveShadow=!0))})},bp:()=>function normalizeSVG(e,t,s,i){h=i;let r=boundingBox(e),a=function extent3D(e,t){let s=new h.Vector3;t=t||boundingBox(e);t&&(s.copy(t.max),s.sub(t.min));return s}(e,r),o=function center3D(e,t){let s=new h.Vector3;t=t||boundingBox(e);t&&(s.copy(t.max),s.add(t.min),s.multiplyScalar(.5));return s}(e,r),n=(e.scale.y*=-1,o.y*=-1,Math.max(a.x,a.y));{var l;0<n&&(a.y&&(e.aspect=a.x/a.y),e.position.set(-o.x,-o.y,-o.z),i=1/n,e.position.multiplyScalar(i),l=e.scale,t?e.scale.set(l.x*i,l.y*i,t):e.scale.multiplyScale(i))}e.traverse(e=>{e.material&&(!function normalizeUV(t,s,e){let i=[e.max.x-e.min.x,e.max.y-e.min.y],r=(i[0]=0<i[0]?1/i[0]:1,i[1]=0<i[1]?1/i[1]:1,[e.min.x,e.min.y]),a=0,o=0;for(let e=0;e<t.length;e++)o+=a,2+!s[3*o]&&(t[e]=(t[e]-r[a])*i[a],a&&(t[e]=1-t[e])),a=0===a?1:0}(e.geometry.attributes.uv.array,e.geometry.attributes.normal.array,r),s&&(e.castShadow=!0,e.receiveShadow=!0))})},iF:()=>function addTexture(e,t){e.traverse(e=>{e.material&&(Array.isArray(e.material)?e.material[0].map=t:e.material.map=t)})},me:()=>AssetManager});let h;function isZip(e){return 80===e[0]&&75===e[1]&&3===e[2]&&4===e[3]}class ImportChecker{constructor(){this.totalSize=0}addItem(e){return!!this.withinLimits&&(this.totalSize+=e.buffer.byteLength,this.withinLimits)}get withinLimits(){return this.totalSize<=104857600}get totalBytes(){return this.totalSize}}class AssetManager{constructor(){this.assetCache={},this.supportedFileTypes=new Set(["zip","glb","obj","fbx","svg","png","jpeg","jpg","gif","exr","pdf","vrse"])}fetchFile(e){e=e.getAsFile();const t=this.getFileType(e.name);if(e&&t)return this.fetchSpecForDroppedFile(e,t).then(e=>{if(this.supportedFileTypes.has(t))return{type:t,buffer:e.buffer};throw new Error("unsupported file type")});throw new Error("could not read a file")}async handlePasteText(e){for(const t of e)if("string"===t.kind&&"text/plain"===t.type)return new Promise(e=>t.getAsString(e))}async handleFiles(e){var t=new ImportChecker;1<e.length&&console.warn("multiple files or dirs dropped");const s=e[0];e=s.getAsEntry?s.getAsEntry():s.webkitGetAsEntry?s.webkitGetAsEntry():null;if(e&&e.isDirectory)try{return this.analyzeDirectory(e,t)}catch(e){throw Error("directory could not be zipped")}let i=await this.fetchFile(s);return e&&(i.fileName=e.fullPath),i}async analyzeDirectory(e,n){const i=[{path:e.fullPath,entry:e,depth:0}];let l=new JSZip,h;const s=()=>{const{path:r,entry:a,depth:o}=i.pop();return a.isDirectory?new Promise((s,e)=>{a.createReader().readEntries(e=>{for(const t of e)i.push({path:t.fullPath,entry:t,depth:o+1});s(!0)})}):new Promise((i,t)=>{a.file(async e=>{var t=this.getFileType(e.name);const s=await this.fetchSpecForDroppedFile(e,t);if("obj"===s.type&&(h="obj"),s.path=r,s.depth=o,n.addItem(s),!n.withinLimits)throw new Error("directory too large");l.file(r,s.buffer),i(!0)},e=>{t(e)})})};return new Promise(async(e,t)=>{for(;0<i.length;)await s();e(!0)}).then(()=>({zip:l,type:h}))}getFileType(e){var t=e.lastIndexOf(".");return 0<=t?e.slice(t+1).toLowerCase():null}async fetchSpecForDroppedFile(s,t){const i=new FileReader;return new Promise((e,t)=>{i.onload=()=>e(i.result),i.onerror=t,i.readAsArrayBuffer(s)}).then(e=>({name:s.name,type:t,blob:s,buffer:e})).catch(e=>{throw console.error(e),new Error("reading a file failed")})}async drop(r){if([...r.types].includes("Files")){let{zip:e,buffer:t,type:s,fileName:i}=await this.handleFiles(r.items);return e?e.generateAsync({type:"uint8array"}):{fileName:i,type:s,buffer:t}}r=await this.handlePasteText(r.items);return r?{type:"pastedtext",buffer:r}:null}setupHandlersOn(e,i){const t=async e=>{var t,s,e=await this.drop(e);e?({buffer:e,fileName:t,type:s}=e,i&&i(e,t,s)):console.log("not a file")};e.ondragover=e=>e.preventDefault(),e.ondrop=e=>{e.preventDefault(),t(e.dataTransfer)},e.onpaste=e=>{e.preventDefault(),t(e.clipboardData||window.clipboardData)}}setCache(e,t,s){this.assetCache[e]?(this.assetCache[e].ids.delete("0"),this.assetCache[e].ids.add(s)):this.assetCache[e]={data:t,ids:new Set([s])}}getCache(e){e=this.assetCache[e];return e?e.data:null}fillCacheIfAbsent(e,t,s){let i=this.assetCache[e];return i?(this.assetCache[e].ids.add(s),i.data):(i=t(),this.setCache(e,i,s),i)}revoke(e,t){let s=this.assetCache[e];s&&(s.ids.delete(t),0===s.ids.size&&delete this.assetCache[e])}async load(i,e,r,a){var o={glb:"importGLB",obj:"importOBJ",fbx:"importFBX",svg:"importSVG",png:"importIMG",jpg:"importIMG",jpeg:"importIMG",gif:"importIMG",exr:"importEXR"};if(isZip(i)){let e=new JSZip;var t=await e.loadAsync(i);let s=Object.keys(t.files);for(let t in o)if(s.find(e=>e.endsWith("."+t))){let e=new Loader;return e[o[t]](i,a,r)}}else for(var s in o)if(e===s){let e=new Loader;return e[o[s]](i,a,r)}throw new Error("unknown file type")}}class Loader{localName(e){var t=e.lastIndexOf("/");return 0<=t?e.slice(t+1):e}imgType(e){return e.endsWith(".png")?"png":e.endsWith(".jpeg")||e.endsWith(".jpg")?"jpeg":null}async setupFilesInZip(e,i){let t=new JSZip,o=await t.loadAsync(e),n={},r=Object.keys(o.files);e=Object.keys(i).map(t=>{var e=i[t],s=r.find(e=>e.endsWith("."+t));return o.file(s).async(e).then(e=>({type:t,blob:URL.createObjectURL(new Blob([e]))}))});let s={},a=(await Promise.all(e).then(e=>{e.forEach(e=>{s[e.type]=e.blob})}),r.map(e=>({name:e,type:this.imgType(e)})).filter(e=>e.type));e=a.map(e=>{let{name:t,type:r}=e,a=this.localName(t);return o.file(t).async("uint8array").then(e=>{let s=new Blob([e],{type:"image/"+r}),i=new FileReader;return new Promise((e,t)=>(i.addEventListener("load",()=>{n[a]=i.result,e(i.result)}),i.readAsDataURL(s)))})});return await Promise.all(e),{...s,imgContents:n}}setURLModifierFor(e,s){s&&e.setURLModifier(e=>{var t;return this.imgType(e)?(t=this.localName(e),s[t]||""):e})}async importOBJ(e,t,s){let i;let r=await(isZip(e)?this.setupFilesInZip(e,{obj:"string",mtl:"string"}):(e={obj:URL.createObjectURL(new Blob([e]))},Promise.resolve(e)));e=new s.LoadingManager;if(this.setURLModifierFor(e,r.imgContents),r.mtl){const o=new s.MTLLoader(e);i=await new Promise((e,t)=>{o.load(r.mtl,e,null,t)})}const a=new s.OBJLoader(e);s=await new Promise((e,t)=>{i&&a.setMaterials(i),a.load(r.obj,e,null,t)});return Object.keys(r).forEach(e=>{r[e]&&"imgContents"!==e&&URL.revokeObjectURL(r[e])}),s}async importFBX(e,t,s){let i=await(isZip(e)?this.setupFilesInZip(e,{fbx:"ArrayBuffer"}):(e={fbx:URL.createObjectURL(new Blob([e]))},Promise.resolve(e)));e=new s.LoadingManager;this.setURLModifierFor(e,i.imgContents);const r=new s.FBXLoader(e);e=await new Promise((e,t)=>r.load(i.fbx,e,null,t)).then(e=>{var t;return 0<e.animations.length&&(t=new s.AnimationMixer(e),e._croquetAnimation={lastTime:0,mixer:t,animations:e.animations}),e});return Object.keys(i).forEach(e=>{i[e]&&"imgContents"!==e&&URL.revokeObjectURL(i[e])}),e}async importGLB(r,e,a){return(async()=>{if(isZip(r)){let e=new JSZip,t=await e.loadAsync(r),s=Object.keys(t.files);var i=s.find(e=>e.endsWith(".glb"));return t.files[i].async("ArrayBuffer")}return Promise.resolve(r.buffer)})().then(i=>{let r=new a.GLTFLoader;return new Promise((t,e)=>{let s=new a.DRACOLoader;return s.setDecoderConfig({type:"wasm"}),s.setDecoderPath("https://www.gstatic.com/draco/v1/decoders/"),r.setDRACOLoader(s),r.parse(i,null,e=>t(e))}).then(e=>{let{scene:t,animations:s}=e;return 0<s.length&&(e=new a.AnimationMixer(t),t._croquetAnimation={lastTime:0,mixer:e,animations:s}),t})})}async importSVG(e,i,g){e={svg:URL.createObjectURL(new Blob([e]))};let r=await Promise.resolve(e);e=await new Promise((c,e)=>{const{fullBright:t,color:u,frameColor:p,depth:f}=i,m=t?g.MeshBasicMaterial:g.MeshStandardMaterial,s=new g.SVGLoader;let y=0;s.load(r.svg,e=>{var t=e.paths;const i=new g.Group;for(let e=0;e<t.length;e++){var r=t[e],a=r.userData.style.fill;if(void 0!==a&&"none"!==a){let s=new m({color:(new g.Color).setStyle(a),opacity:r.userData.style.fillOpacity,side:f?g.FrontSide:g.DoubleSide});u&&(s.color=new g.Color(u)),f&&(s=[s,new g.MeshStandardMaterial({color:p,metalness:1})]);var o=g.SVGLoader.createShapes(r);for(let t=0;t<o.length;t++){var n=o[t];let e;e=f?new g.ExtrudeGeometry(n,{depth:1+y,bevelEnabled:!1}):new g.ShapeGeometry(n);const h=new g.Mesh(e,s);h.position.z+=f,y+=.002,i.add(h)}}a=r.userData.style.stroke;if(void 0!==a&&"none"!==a){var s=new m({color:(new g.Color).setStyle(a),opacity:r.userData.style.strokeOpacity,side:g.DoubleSide});for(let e=0,t=r.subPaths.length;e<t;e++){const d=r.subPaths[e];var l=g.SVGLoader.pointsToStroke(d.getPoints(),r.userData.style);l&&(l=new g.Mesh(l,s),i.add(l))}}}c(i)})});return Object.keys(r).forEach(e=>{r[e]&&"imgContents"!==e&&URL.revokeObjectURL(r[e])}),e}async importIMG(e,t,s){let i=URL.createObjectURL(new Blob([e])),r=new s.TextureLoader,a=new Promise((t,e)=>{r.load(i,e=>{e.width=e.image.width,e.height=e.image.height,t(e)},null,e)});return a.then(()=>(URL.revokeObjectURL(i),a))}async importEXR(e,t,s){let i=await(isZip(e)?this.setupFilesInZip(e,{exr:"ArrayBuffer"}):(e={exr:URL.createObjectURL(new Blob([e]))},Promise.resolve(e)));e=new Promise((e,t)=>{(new s.EXRLoader).load(i.exr,e,null,t)});return Object.keys(i).forEach(e=>{i[e]&&"imgContents"!==e&&URL.revokeObjectURL(i[e])}),e}}function boundingBox(e,t,s){if(t||(t=new h.Box3,s=0),e.geometry){e.geometry.boundingBox||e.geometry.computeBoundingBox();const i=e.geometry.boundingBox.clone();i.applyMatrix4(e.matrixWorld),t.union(i)}return e.children&&e.children.forEach(e=>boundingBox(e,t,s+1)),t}},6830:(e,t,s)=>{"use strict";s.d(t,{b:()=>AvatarActor});var y=s(4200),g=s(5679),c=s(3917),t=s(2691),s=s(3654);let a=null,o=!1,i=null,r=!!("ontouchstart"in window);function toggleMenu(t){if(o)return a.classList.remove("menuVisible"),void(o=!1);if("worldMenu-forceStop"===a.lastChild.id&&a.lastChild.remove(),t.actor.service("PlayerManager").presentationMode){var s=`
<div id="worldMenu-forceStop" class="menu-label menu-item">
    <span class="menu-label-text">Stop Presentation</span>
</div>`.trim();let e=document.createElement("div");e.innerHTML=s,a.appendChild(e.firstChild)}let e;return(e=a.querySelector("#worldMenu-qr")).onclick=e=>{e.preventDefault(),e.stopPropagation(),e.shiftKey||r?function switchQRView(){let e=a.querySelector("#qrDiv"),t=a.querySelector("#statsDiv");var s="statsHidden";e.classList.contains(s)?(e.classList.toggle(s,!1),t.classList.toggle(s,!0)):(e.classList.toggle(s,!0),t.classList.toggle(s,!1))}():function qrPressed(e,t){let s=document.createElement("div"),i=(s.innerHTML=`<a id="link" target="_blank" rel="noopener noreferrer" href="${t}"></a>`,document.getElementById("hud").appendChild(s),s.querySelector("#link"));i.click(),s.remove()}(0,window.location)},(e=a.querySelector("#worldMenu-save")).onclick=e=>{e.preventDefault(),e.stopPropagation(),function savePressed(e){let t=e.actor.wellKnownModel("ModelRoot"),s=document.createElement("a");e="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(t.saveData(),null,4)),s.setAttribute("href",e),s.setAttribute("download","scene.vrse"),s.click(),o&&toggleMenu()}(t)},(e=a.querySelector("#worldMenu-load")).onclick=e=>{e.preventDefault(),e.stopPropagation(),function loadPressed(t){if(!i){let e=document.createElement("div");e.innerHTML='<input id="imageinput" type="file" accept="application/json;">',(i=e.firstChild).onchange=()=>{for(const s of i.files)new Promise(e=>{let t=new FileReader;t.onload=()=>e(t.result),t.readAsBinaryString(s)}).then(e=>{t.loadFromFile(e)});i.value=""}}document.getElementById("hud").appendChild(i),i.click(),o&&toggleMenu()}(t)},(e=a.querySelector("#worldMenu-connect")).onclick=()=>function connectPressed(){window.BehaviorViewManager.setURL("ws://localhost:9011"),o&&toggleMenu()}(),(e=a.querySelector("#worldMenu-forceStop"))&&(e.onclick=()=>function forceStop(e){e.say("stopPresentation"),o&&toggleMenu()}(t)),o=!0,a.classList.add("menuVisible"),a}function setupWorldMenuButton(e,i,r){if(!a){let e=document.createElement("div"),t=document.createElement("div"),s=(t.id="statsDiv",document.createElement("div"));s.id="qrDiv",t.classList.add("statsHidden"),e.appendChild(s),e.appendChild(t),i.root=e,i.badge=!1,i.qrcode=s,i.stats=t,i.makeSessionWidgets(r),s.onclick=null,!function initWorldMenu(e){let t=document.createElement("div"),s=(t.id="worldMenu",t.classList.add("worldMenu"),t.appendChild(e),e.id="worldMenu-qr",e.classList.add("menu-qr","menu-item"),e=`
<div id="worldMenu-save" class="menu-label menu-item">
    <span class="menu-label-text">Save</span>
    <div class="menu-icon save-icon"></div>
</div>
<div id="worldMenu-load" class="menu-label menu-item">
    <span class="menu-label-text">Load</span>
    <div class="menu-icon load-icon"></div>
</div>
<div id="worldMenu-connect" class="menu-label menu-item">
    <span class="menu-label-text">Connect</span>
    <div class="menu-icon connect-icon"></div>
</div>`.trim(),document.createElement("div"));s.innerHTML=e;var e=s.querySelector("#worldMenu-save"),i=s.querySelector("#worldMenu-load"),r=s.querySelector("#worldMenu-connect");t.appendChild(e),t.appendChild(i),t.appendChild(r),filterDomEventsOn(a=t),o=!1,document.getElementById("hud").appendChild(a)}(e)}let t=document.querySelector("#worldMenuBttn");t.onclick=()=>toggleMenu(e),filterDomEventsOn(t)}function filterDomEventsOn(e){e.onpointerdown=e=>e.stopPropagation(),e.onpointerup=e=>e.stopPropagation(),e.onpointermove=e=>e.stopPropagation()}const n=1.676;n;const l=.0075,h=(0,y.m4_rotationY)(Math.PI),d=(0,y.q_euler)(0,Math.PI,0);let u;class AvatarActor extends(0,y.mix)(s.Z4).with(y.AM_Player){init(e){var t=e.playerId;delete e.playerId,super.init(e),this._playerId=t,this._layers=e.layers,this.addLayer("avatar"),this.lookPitch=0,this.lookYaw=0,this.lookOffset=(0,y.v3_zero)(),this.fall=!1,this.tug=.05,this.set({tickStep:30}),this.listen("goHome",this.goHome),this.listen("goThere",this.goThere),this.listen("startFalling",this.startFalling),this.listen("avatarLookTo",this.onLookTo),this.listen("comeToMe",this.comeToMe),this.listen("followMeToWorld",this.followMeToWorld),this.listen("continuePresenting",this.continuePresenting),this.listen("continueFollowing",this.continueFollowing),this.listen("stopPresentation",this.stopPresentation),this.listen("inWorldSet",this.inWorldSet),this.listen("fileUploaded","fileUploaded"),this.listen("addSticky",this.addSticky),this.listen("textPasted",this.textPasted),this.listen("resetStartPosition",this.resetStartPosition),this.subscribe("playerManager","presentationStarted",this.presentationStarted),this.subscribe("playerManager","presentationStopped",this.presentationStopped),this.listen("leavePresentation",this.leavePresentation),this.future(0).tick()}get pawn(){return AvatarPawnFactory}get lookNormal(){return(0,y.v3_rotate)([0,0,-1],this.rotation)}get collisionRadius(){return this._cardData.collisionRadius||.8}get fallDistance(){return this._fallDistance||.13966666666666666}get inWorld(){return!!this._inWorld}leavePresentation(){if(this.follow){let e=this.service("PlayerManager");e.presentationMode&&this.follow!==this.playerId&&(this.presentationStopped(),this.say("setLookAngles",{lookOffset:[0,0,0]}),e.leavePresentation(this.playerId))}}stopPresentation(){this.service("PlayerManager").stopPresentation()}inWorldSet({o:e,v:t}){!e!=!t&&this.service("PlayerManager").playerInWorldChanged(this)}startFalling(){this.fall=!0}resetStartPosition(){this.goTo(this.translation,this.rotation,!1)}onLookTo(e){var[e,t,s]=e;void 0!==e&&(this.lookPitch=e),void 0!==t&&(this.lookYaw=t),void 0!==s&&(this.lookOffset=s),this.rotateTo((0,y.q_euler)(0,this.lookYaw,0)),this.restoreTargetId=void 0}goHome(){let e,t;t=this._anchor?(e=this._anchor.translation,this._anchor.rotation):(e=(0,y.v3_zero)(),(0,y.q_identity)()),this.goTo(e,t,!1),this.lookOffset=(0,y.v3_zero)(),this.lookPitch=0,this.lookYaw=0,this.say("setLookAngles",{pitch:0,yaw:0,lookOffset:this.lookOffset})}goTo(e,t,s){this.leavePresentation(),this.vStart=[...this.translation],this.qStart=[...this.rotation],this.vEnd=e,this.qEnd=t,this.fall=s,this.goToStep(.1)}goThere(t){if(this.leavePresentation(),this.vStart=[...this.translation],this.qStart=[...this.rotation],this.fall||t.targetId!==this.restoreTargetId){this.fall=!1,this.restoreRotation=[...this.rotation],this.restoreTranslation=[...this.translation],this.restoreTargetId=t.targetId;let e=[...t.normal||this.lookNormal];var s=t.xyz,s=(this.vEnd=(0,y.v3_add)(s,(0,y.v3_scale)(e,t.offset||n)),(e[1]=0,y.v3_sqrMag)(e));s<1e-4?this.qEnd=this.rotation:(e=(0,y.v3_normalize)(e),s=Math.atan2(e[0],e[2]),this.qEnd=(0,y.q_euler)(0,s,0)),t.look&&(s=(0,y.q_pitch)(this.qEnd),t=(0,y.q_yaw)(this.qEnd),this.lookPitch=s,this.lookYaw=t,this.say("setLookAngles",{pitch:s,yaw:t}))}else this.vEnd=this.restoreTranslation,this.qEnd=this.restoreRotation,this.restoreRotation=void 0,this.restoreTranslation=void 0,this.restoreTargetId=void 0;this.goToStep(.1)}comeToMe(){this.service("PlayerManager").startPresentation(this.playerId)}followMeToWorld(e){const t=this.service("PlayerManager");if(t.presentationMode===this.playerId){const s={...e};s.following=s.presenting,delete s.presenting;for(const i of t.followers)if(i!==this.playerId){const r=t.player(i);r.followToWorld(s)}}}followToWorld(e){this.say("followToWorld",{followerTransferData:e})}presentationStarted(){const{presenter:e,followers:t}=this.service("PlayerManager");e.playerId!==this.playerId&&t.has(this.playerId)&&(this._translation=[...e.translation],this._rotation=[...e.rotation],this.say("forceOnPosition"),this.follow=e.playerId,this.fall=!1,this._anchor=e._anchor)}presentationStopped(){this.follow=null}continuePresenting(e){this.service("PlayerManager").continuePresenting(this,e)}continueFollowing(e){this.service("PlayerManager").continueFollowing(this,e)}goToStep(e,t){var s=(0,y.v3_lerp)(this.vStart,this.vEnd,t=1<=(t=t||e)?1:t),i=(0,y.q_slerp)(this.qStart,this.qEnd,t);this.positionTo({v:s,q:i}),this.say("forceOnPosition"),t<1&&this.future(50).goToStep(e,t+e)}tick(e){var t;this.follow&&((t=this.service("PlayerManager").players.get(this.follow))?(this.positionTo({v:t._translation,q:t._rotation}),this.lookOffset=t.lookOffset,this.lookPitch=t.lookPitch,this.lookYaw=t.lookYaw,this.say("setLookAngles",{pitch:t.lookPitch,yaw:t.lookYaw,lookOffset:t.lookOffset})):this.presentationStopped()),this.doomed||this.future(this._tickStep).tick(this._tickStep)}dropPose(e,t){var s=this.lookNormal,i=this.translation,r=this.rotation;if(!t)return{translation:(0,y.v3_add)((0,y.v3_scale)(s,e),i),rotation:r};var a=(0,y.q_euler)(0,-Math.PI/2,0),a=(0,y.v3_rotate)(s,a),t=(0,y.v3_multiply)(t,a);return{translation:(0,y.v3_add)((0,y.v3_add)((0,y.v3_scale)(s,e),i),t),rotation:r}}fileUploaded(t){var{dataId:t,fileName:e,type:s,translation:i,rotation:r,animationClipIndex:a,dataScale:o}=t,n="exr"===s?"lighting":"svg"===s||"img"===s||"pdf"===s?"2d":"3d";let l={name:e,translation:i,rotation:r,type:n,fileName:e,modelType:s,shadow:!0,singleSided:!0};if(void 0!==a&&(l.animationClipIndex=a),"3d"==n&&o&&(l.dataScale=o),l="img"===s?{...l,textureLocation:t,textureType:"image",scale:[4,4,4],cornerRadius:.02,fullBright:!1}:"pdf"===s?{...l,behaviorModules:["PDFView"],scale:[4,4,4],layers:["pointer"],type:"2d",frameColor:16777215,color:8947848,depth:.05,fullBright:!0,pdfLocation:t}:{...l,dataLocation:t},"exr"!==s)this.createCard(l);else{let e=[...this.service("ActorManager").actors.values()].find(e=>"lighting"===e._cardData.type);e&&e.updateOptions({...e._cardData,dataLocation:t,dataType:"exr"})}this.publish(this.sessionId,"triggerPersist")}textPasted({string:e,translation:t,rotation:s}){e.startsWith("http://")||e.startsWith("https://")?this.createPortal(t,s,e):this.createStickyNote(t,s,e)}addSticky(e){let t=(0,y.v3_add)(e.xyz,(0,y.v3_scale)(e.normal,.1)),s=[...e.normal],i;1e-4<(s[1]=0,y.v3_sqrMag)(s)?(s=(0,y.v3_normalize)(s),e=Math.atan2(s[0],s[2]),i=(0,y.q_euler)(0,e,0)):(i=this.rotation,t[1]+=2),this.createStickyNote(t,i)}createStickyNote(e,t,s){let i=[];s=s||"",i.push({text:s});s={name:"sticky note",className:"TextFieldActor",behaviorModules:["StickyNote"],translation:e,rotation:t,type:"text",depth:.05,margins:{left:20,top:20,right:20,bottom:20},backgroundColor:16048214,frameColor:16439570,runs:i,width:1,height:1,textScale:.002};this.createCard(s),this.publish(this.sessionId,"triggerPersist")}createPortal(e,t,s){t=(0,y.q_multiply)(d,t),this.createCard({name:"portal",className:"PortalActor",translation:e,rotation:t,type:"2d",layers:["pointer"],color:16737996,frameColor:8947848,width:3,height:3,depth:.2,cornerRadius:.05,portalURL:s,sparkle:!1}),this.publish(this.sessionId,"triggerPersist")}}AvatarActor.register("AvatarActor");class AvatarPawnFactory extends y.View{constructor(e){return super(e),new(this.viewId===e.playerId?AvatarPawn:RemoteAvatarPawn)(e)}}class RemoteAvatarPawn extends(0,y.mix)(s.Df).with(y.PM_Player,g.PM_ThreeVisible){constructor(e){super(e),this.lastUpdateTime=0,this.opacity=1,this.spin=(0,y.q_identity)(),this.velocity=[0,0,0],this.lookPitch=this.actor.lookPitch,this.lookYaw=this.actor.lookYaw,this.lookOffset=[0,0,0],this.tug=.06}setOpacity(s){if(this.shape){let t=1!==s;this.shape.visible=this.actor.inWorld&&0!==s,this.shape.traverse(e=>{e.material&&(e.material.opacity=s,e.material.transparent=t,e.material.side=g.THREE.DoubleSide,e.material.needsUpdate=!0)})}}}class AvatarPawn extends(0,y.mix)(s.Df).with(y.PM_Player,e=>class extends e{constructor(e){super(e),this.throttle=125,this.ignore("scaleSet"),this.ignore("rotationSet"),this.ignore("translationSet"),this.ignore("positionSet")}globalChanged(){this._global||!this.renderObject||this.renderObject.matrixWorldNeedsUpdate||(this.refreshDrawTransform(),this.children&&this.children.forEach(e=>e.onGlobalChanged()))}positionTo(e,t,s){if(!this.actor.follow){if(s=s||this.throttle,(0,y.v3_equals)(this.actor.translation,e,0)&&(0,y.q_equals)(this.actor.rotation,t,0))return;this._translation=e,this._rotation=t,this.onLocalChanged(),this.isTranslating=!1,this.isRotating=!1}super.positionTo(e,t,s),this.globalChanged()}scaleTo(e,t){this.actor.follow||(t=t||this.throttle,this._scale=e,this.onLocalChanged(),this.isScaling=!1),super.scaleTo(e,t),this.globalChanged()}rotateTo(e,t){this.actor.follow||(t=t||this.throttle,this._rotation=e,this.onLocalChanged(),this.isRotating=!1),super.rotateTo(e,t),this.globalChanged()}translateTo(e,t){this.actor.follow||(t=t||this.throttle,this._translation=e,this.isTranslating=!1,this.onLocalChanged()),super.translateTo(e,t),this.globalChanged()}},g.PM_ThreeVisible,g.PM_ThreeCamera,t.CN){constructor(e){super(e),this.lastUpdateTime=0,this.lastCollideTime=0,this.lastCollideTranslation=this.actor.translation,this.opacity=1,this.spin=(0,y.q_identity)(),this.velocity=(0,y.v3_zero)(),this.lookPitch=this.actor.lookPitch,this.lookYaw=this.actor.lookYaw,this.lookOffset=(0,y.v3_zero)(),this._rotation=(0,y.q_euler)(0,this.lookYaw,0),this.portalLookExternal=u,this.isMobile=!!("ontouchstart"in window),this.isFalling=!1;const l=this.service("ThreeRenderManager");this.camera=l.camera,this.scene=l.scene,this.lastHeight=n,this.yawDirection=-1,this.walkCamera=new g.THREE.Object3D,this.walkcaster=new g.THREE.Raycaster(new g.THREE.Vector3,new g.THREE.Vector3(0,-1,0)),this.portalcaster=new g.THREE.Raycaster(new g.THREE.Vector3,new g.THREE.Vector3,0,.4),this.future(100).fadeNearby(),document.getElementById("homeBttn").onclick=()=>this.goHome(),filterDomEventsOn(document.getElementById("homeBttn")),document.getElementById("usersComeHereBttn").onclick=()=>this.comeToMe(),filterDomEventsOn(document.getElementById("usersComeHereBttn")),document.getElementById("editModeBttn").setAttribute("mobile",this.isMobile),document.getElementById("editModeBttn").setAttribute("pressed",!1);let t=document.getElementById("editModeBttn");t.onpointerdown=e=>this.setEditMode(e),t.onpointerup=e=>this.clearEditMode(e),setupWorldMenuButton(this,y.App,this.sessionId),this.service("AssetManager").assetManager.setupHandlersOn(document,(e,t,s)=>{"pastedtext"===s?this.pasteText(e):"vrse"===s?this.loadvrse(e):this.analyzeAndUploadFile(new Uint8Array(e),t,s)}),this.isPrimary=c.lp,this.portalClip=new g.THREE.Plane(new g.THREE.Vector3(0,0,-1),0),this.setPortalClipping(),this.shellListener=(e,{frameType:t,spec:s,cameraMatrix:i,dx:r,dy:a,acknowledgeReceipt:o})=>{switch(e){case"frame-type":var n="primary"===t;s&&this.setWorldSwitchFreeze(!0),n!==this.isPrimary&&this.frameTypeChanged(n,s),i&&this.portalCameraUpdate(i),(0,c.Rx)("avatar-ready",{frameType:t});break;case"release-freeze":this.setWorldSwitchFreeze(!1),this.refreshCameraTransform(),this.updatePortalRender(!0);break;case"sync-render-now":if(this.frozenForWorldSwitch)return void console.log((0,c.QI)(),"ignoring sync-render while frozen");this.refreshCameraTransform(),l.composer.render(),o&&(0,c.Rx)("primary-rendered");break;case"portal-camera-update":this.setWorldSwitchFreeze(!1),this.portalCameraUpdate(i);break;case"motion-start":this.call("AvatarEventHandler$AvatarPawn","startMotion",r,a);break;case"motion-end":this.call("AvatarEventHandler$AvatarPawn","endMotion",r,a);break;case"motion-update":this.call("AvatarEventHandler$AvatarPawn","updateMotion",r,a)}},(0,c.G8)(this.shellListener);const s={inWorld:this.isPrimary};e=this.anchorFromURL(window.location,!this.isPrimary);e&&(s.anchor=e,s.translation=e.translation,s.rotation=e.rotation),this.say("_set",s),this.say("resetStartPosition"),this.subscribe("playerManager","playerCountChanged",this.showNumbers),this.listen("setLookAngles",this.setLookAngles),this.listenImmediate("followToWorld",this.followToWorld),this.showNumbers(),this.listen("forceOnPosition",this.onPosition),this.listen("goThere",this.stopFalling),console.log((0,c.QI)(),"MyPlayerPawn created",this,"primary:",this.isPrimary),this.wasdVelocity=[0,0,0],this.wasdMap={w:!1,a:!1,d:!1,s:!1}}get presenting(){return this.actor.service("PlayerManager").presentationMode===this.viewId}setWorldSwitchFreeze(e){this.frozenForWorldSwitch=e}onPosition(){this._rotation=this.actor.rotation,this._translation=this.actor.translation,this.onLocalChanged()}setLookAngles(e){var{pitch:e,yaw:t,lookOffset:s}=e;void 0!==e&&(this.lookPitch=e),void 0!==t&&(this.lookYaw=t),void 0!==s&&(this.lookOffset=s)}async analyzeAndUploadFile(e,t,s){var i=await y.Data.store(this.sessionId,e,!0),i=y.Data.toId(i);let r=this.service("AssetManager").assetManager,a,o,n;try{"pdf"!==s&&(a=await r.load(e,s,g.THREE,{}))}catch(e){return void console.warn("dropped file could not be processed",e)}a&&a.isObject3D&&(r.setCache(i,e,"0"),a._croquetAnimation&&(o=0),e=new g.THREE.Vector3(0,0,0),(new g.THREE.Box3).setFromObject(a).getSize(e),e=4/Math.max(e.x,e.y,e.z),n=[e,e,e]);e=this.dropPose(6);this.say("fileUploaded",{dataId:i,fileName:t,type:/^(jpe?g|png|gif)$/.test(s)?"img":s,translation:e.translation,rotation:e.rotation,animationClipIndex:o,dataScale:n})}async uploadFile(e,t,s){var e=await y.Data.store(this.sessionId,e),e=y.Data.toId(e),i=this.dropPose(6);this.say("fileUploaded",{dataId:e,fileName:t,type:/^(jpe?g|png|gif)$/.test(s)?"img":s,translation:i.translation,rotation:i.rotation})}async pasteText(e){2e3<e.length&&(console.warn("Paste too long, truncating"),e=e.substr(0,2e3));var t=this.dropPose(6);this.say("textPasted",{string:e,translation:t.translation,rotation:t.rotation})}loadvrse(e){e=new TextDecoder("utf-8").decode(e);this.loadFromFile(e,!1,!0)}dropPose(e,t){return this.actor.dropPose(e,t)}anchorFromURL(e,t){const s=this.actor.service("ActorManager")["actors"],i=new URL(e)["searchParams"],r=i.get("anchor");if(!r){if(t)for(const c of s.values())if(c.isPortal)return c;for(const u of s.values())if("default"===u._cardData.spawn)return u;return null}for(const p of s.values())if(p.name===r)return p;const a=r.split(",").map(e=>parseFloat(e));if(7!==a.length||a.some(e=>isNaN(e)))return null;var[e,t,o,n,l,h,d]=a;return{translation:[e,t,o],rotation:[n,l,h,d]}}showNumbers(){let s=this.actor.service("PlayerManager"),i=document.getElementById("usersComeHereBttn"),r=i.querySelector("#userCountReadout");if(r){let e=s.players.size;var a,o=s.playersInWorld().length;let t=o+` ${1===o?"user is":"users are"} in this world`;o!==e&&(a=e-o,t+=`, ${a} ${1==a?"user has":"users have"} not entered yet`,e=o+"+"+a),s.presentationMode?(o=s.followers.size,r.textContent=o+"/"+e,t=o+` ${1===o?"user":"users"} in guided tour, `+t):r.textContent=""+e,i.setAttribute("title",t)}i.setAttribute("presenting",this.presenting)}setEditMode(e){e.target.setAttribute("pressed",!0),e.target.setPointerCapture(e.pointerId),e.stopPropagation(),this.service("InputManager").setModifierKeys({ctrlKey:!0})}clearEditMode(e){e.target.setAttribute("pressed",!1),e.target.releasePointerCapture(e.pointerId),e.stopPropagation(),this.service("InputManager").setModifierKeys({ctrlKey:!1})}maybeLeavePresentation(){this.actor.follow&&this.say("leavePresentation")}lookTo(e,t,s){this.maybeLeavePresentation(),this.setLookAngles({pitch:e,yaw:t,lookOffset:s}),this.say("avatarLookTo",[e,t,s],30);e=(0,y.q_euler)(0,this.lookYaw,0);this._rotation=e,this.onLocalChanged(),this.isRotating=!1}destroy(){(0,c.bq)(this.shellListener),super.destroy()}get lookGlobal(){return this.lookOffset?!this.isPrimary&&this.portalLookExternal?this.portalLook:this.walkLook():this.global}walkLook(){let e=this.actor.behaviorManager;var t=e.lookup("AvatarEventHandler","AvatarPawn");if(t&&t.$behavior.walkLook)return this.call("AvatarEventHandler$AvatarPawn","walkLook");var t=(0,y.q_axisAngle)([1,0,0],this.lookPitch),s=(0,y.m4_translation)(this.lookOffset),t=(0,y.m4_rotationQ)(t),t=(0,y.m4_multiply)(t,s);return(0,y.m4_multiply)(t,this.global)}get portalLook(){var e=this.anchor||this.actor._anchor||{translation:[0,0,0],rotation:[0,0,0,1]},t=(0,y.m4_translation)(e.translation),s=(0,y.m4_rotationQ)(e.rotation),i=(0,y.m4_multiply)(s,h),i=(0,y.m4_multiply)(i,t),t=(0,y.m4_multiply)(this.portalLookExternal,i);this.portalClip.normal.set(0,0,-1),this.portalClip.constant=0;const r=new g.THREE.Matrix4;r.set(...s),r.invert(),this.portalClip.applyMatrix4(r);i=new g.THREE.Vector3(...e.translation);return this.portalClip.constant=-this.portalClip.distanceToPoint(i),t}specForPortal(e,t,s){var t=(0,y.m4_translation)(t),t=(0,y.m4_multiply)(this.global,t),i=(0,y.m4_invert)(e.global),t=(0,y.m4_multiply)(t,i);const r={translation:(0,y.m4_getTranslation)(t),rotation:(0,y.m4_getRotation)(t),lookPitch:this.lookPitch,lookYaw:this.lookYaw,lookOffset:this.lookOffset,cardData:this.actor._cardData,name:this.actor._name,url:e.resolvePortalURL(),crossingBackwards:s};return this.presenting&&(r.presenting=y.Data.hash(this.viewId)),r}frameTypeChanged(e,s){var t=this.isPrimary=e,e=!e;const i={inWorld:t};if(t&&s?.translation){let{translation:e,rotation:t}=s;var r,a,o,n=this.anchorFromURL(s.url,!0);n&&(o=(0,y.m4_translation)(e),r=(0,y.m4_rotationQ)(t),r=(0,y.m4_multiply)(r,o),o=(0,y.m4_translation)(n.translation),a=(0,y.m4_rotationQ)(n.rotation),a=(0,y.m4_multiply)(a,h),a=(0,y.m4_multiply)(a,o),o=(0,y.m4_multiply)(r,a),e=(0,y.m4_getTranslation)(o),t=(0,y.m4_getRotation)(o),i.anchor=n,this.anchor=n),i.translation=e,i.rotation=t,this._translation=e,this._rotation=t,this.onLocalChanged(),s.lookPitch&&(this.lookPitch=s.lookPitch),s.lookYaw&&(this.lookYaw=s.lookYaw),s.lookOffset&&(this.lookOffset=s.lookOffset)}s?.cardData&&(i.cardData=s.cardData),s?.name&&(i.name=s.name),e&&this.call("AvatarEventHandler$AvatarPawn","endMotion"),console.log((0,c.QI)()+" setting actor",i),this.say("_set",i),t&&(s?.presenting?this.actor.service("PlayerManager").presentationMode||this.say("continuePresenting",s.presenting):s?.following&&this.say("continueFollowing",s.following)),this.setPortalClipping()}followToWorld({followerTransferData:e}){var{url:t,following:s}=e;this.isPrimary?(console.log((0,c.QI)()+` sending world-enter to ${t} following: `+s),this.setWorldSwitchFreeze(!0),e.cardData=this.actor._cardData,(0,c.Rx)("world-enter",{portalURL:t,transferData:e})):console.log((0,c.QI)()+" not sending world-enter to "+t)}update(t,s){if(!this.frozenForWorldSwitch){if(this.actor.follow||this.actor.remoteControlled)this.tug=.06,super.update(t,s);else{this.tug=.2;var e=this.actor.service("PlayerManager");if(this.throttle=e.presentationMode===this.actor.playerId?60:125,this.actor.inWorld){let e=this.updatePose(s);if(this.collidePortal(e))return;this.checkFloor(e)?this.lastCollideTranslation=e.v:e.v=(0,y.v3_lerp)(this.lastCollideTranslation,e.v,-1),this.actor.fall&&15<t-this.lastUpdateTime&&(50<t-this.lastCollideTime&&(this.lastCollideTime=t,e=this.collide(e)),this.lastUpdateTime=t,this.positionTo(e.v,e.q)),this.refreshCameraTransform()}}this.updatePortalRender()}}updatePose(e){let t,s,i=this.tug;return e&&(i=Math.min(1,i*e/15)),t=(0,y.q_isZero)(this.spin)?this.rotation:(0,y.q_normalize)((0,y.q_slerp)(this.rotation,(0,y.q_multiply)(this.rotation,this.spin),i)),{v:s=(0,y.v3_isZero)(this.velocity)?this.translation:(e=(0,y.v3_scale)(this.velocity,e),e=(0,y.v3_transform)(e,(0,y.m4_rotationQ)(this.rotation)),(0,y.v3_add)(this.translation,e)),q:t}}setPortalClipping(){let e=this.service("ThreeRenderManager").renderer["clippingPlanes"];var t;this.isPrimary?0<=(t=e.indexOf(this.portalClip))&&e.splice(t,1):e.includes(this.portalClip)||e.push(this.portalClip)}updatePortalRender(e=!1){if(this.isPrimary){const s=[];let t=!1;this.publish("avatar","gatherPortalSpecs",{callback:e=>{s.push(e),t|=!!e.cameraMatrix},force:e});const i=this.service("ThreeRenderManager");s.length?(0,c.Rx)("portal-update",{portalSpecs:s}):i.setRender(!0),e&&!t&&(console.log((0,c.QI)(),"no portals in sight; rendering immediately"),i.composer.render(),(0,c.Rx)("primary-rendered"))}else this.actor._anchor&&this.refreshCameraTransform()}portalCameraUpdate(e){this.lastCameraMatrix=e;const t=this.service("ThreeRenderManager");t.setRender(!1),e&&(this.endMovementTimeout&&clearTimeout(this.endMovementTimeout),this.endMovementTimeout=setTimeout(()=>{var e=!!this.lastCameraMatrix&&!this.frozenForWorldSwitch;t.setRender(e)},50),this.portalLookExternal=e,u=e,this.isPrimary||this.frozenForWorldSwitch||(this.refreshCameraTransform(),t.composer.render(),(0,c.Rx)("portal-world-rendered")))}checkFloor(r){let e=this.service("ThreeRenderManager").threeLayer("walk");var a=e.filter(e=>e.collider);let o=!1;for(let i=0;i<a.length;i++){let e=a[i],t=new g.THREE.Matrix4;t.copy(e.matrixWorld).invert();var n=new g.THREE.Vector3(0,-1,0);let s=new g.THREE.Ray(new g.THREE.Vector3(...r.v),n);s.applyMatrix4(t);n=e.children[0].geometry.boundsTree.raycastFirst(s);o=o||n}return o}collideBVH(l,e){let h=new g.THREE.Vector3,d=new g.THREE.Vector3;const c=this.actor.collisionRadius;let u=!1;var p=(0,y.v3_sub)(e.v,this.translation);let f=e.v,m=!1;for(let n=0;n<l.length;n++){let e=l[n],t=e.children[0].matrixWorld.clone(),r=(t.invert(),new g.THREE.Line3(new g.THREE.Vector3(f[0],f[1],f[2]),new g.THREE.Vector3(f[0],f[1]-.838,f[2]))),s=new g.THREE.Box3,a=(s.makeEmpty(),s.expandByPoint(r.start),s.expandByPoint(r.end),s.min.addScaledVector(new g.THREE.Vector3(-1,-1,-1),c),s.max.addScaledVector(new g.THREE.Vector3(1,1,1),c),r.applyMatrix4(t),s.applyMatrix4(t),[]),o,i=(e.children[0].geometry.boundsTree.shapecast({intersectsBounds:e=>e.intersectsBox(s),intersectsTriangle:e=>{var t,s,i=e.closestPointToSegment(r,d,h);i<c&&(i=c-i,s=h.sub(d).normalize(),t=Math.sqrt(s.x**2+s.z**2),s=s.y,t<.1&&.9<s&&(!o||i>o.depth)?(o=e.clone(),a.unshift(o)):a.push(e.clone()))}}),a.forEach(e=>{var t,e=e.closestPointToSegment(r,d,h);e<c&&(e=c-e,t=h.sub(d).normalize(),r.start.addScaledVector(t,e),r.end.addScaledVector(t,e),u=!0)}),r.start.clone());i.applyMatrix4(e.children[0].matrixWorld),f=i.toArray(),m=m||u&&p[1]<-.1&&Math.abs(p[0])<.001&&Math.abs(p[2])<.001}return this.checkFloor({v:f,q:e.q})?m?(this.isFalling=!1,{v:this.translation,q:e.q}):u?(this.isFalling=!0,{v:f,q:e.q}):(this.isFalling=!0,e):{v:(0,y.v3_lerp)(this.lastCollideTranslation,e.v,-1),q:e.q}}pawnFrom3D(e){for(;e;){if(e.wcPawn)return e.wcPawn;e=e.parent}}collidePortal(t){if(!this.frozenForWorldSwitch){const o=this.service("ThreeRenderManager");var s=o.threeLayer("portal");if(s){var i=(0,y.v3_sub)(t.v,this.translation),r=(0,y.v3_magnitude)(i);if(0!==r){i=(0,y.v3_normalize)(i),this.portalcaster.far=5,this.portalcaster.ray.direction.set(...i),this.portalcaster.ray.origin.set(...this.translation);s=this.portalcaster.intersectObjects(s,!0)[0];if(s){var a=this.pawnFrom3D(s.object);if(!a)return!1;const n=a.globalPlane;if(!(0<n.normal.dot(new g.THREE.Vector3(...i))))return!1;let e=s.distance<=r;if(e||(r=n.distanceToPoint(new g.THREE.Vector3(...t.v)),e=-.4<=r),!e)return!1;const l=o["camera"];t=l.getWorldDirection(new g.THREE.Vector3),r=n.normal.dot(t)<0,t=(this.anchor=a.actor,console.log((0,c.QI)(),"player",this.viewId,"enter portal",a.portalId),o.setRender(!1),this.setWorldSwitchFreeze(!0),(0,y.v3_scale)(i,s.distance)),t=(0,y.v3_add)(t,(0,y.v3_scale)(n.normal.toArray(),.4)),i=this.specForPortal(a,t,r);if((0,c.Rx)("portal-enter",{portalId:a.portalId,transferData:i}),this.presenting){const{cardData:h,...d}=i;this.say("followMeToWorld",d)}return!0}}}}return!1}collide(e){let t=this.service("ThreeRenderManager").threeLayer("walk");if(!t)return e;let s=e.v;if(this.isFalling&&(s=[s[0],s[1]-this.actor.fallDistance,s[2]],this.isFalling=!1,s[1]<-15))return this.goHome(),{v:(0,y.v3_zero)(),q:(0,y.q_identity)()};var i=t.filter(e=>e.collider);return 0<i.length?(i=this.collideBVH(i,{v:s,q:e.q}),window.abc=i):e}keyDown(e){var t=this.wasdVelocity;let s;if(e.ctrlKey||e.altKey)switch(e.key){case"a":console.log("My avatar pawn",this),console.log("translation: ",this.actor.translation),console.log("rotation (euler):",(0,y.q_pitch)(this.actor.rotation),(0,y.q_yaw)(this.actor.rotation),(0,y.q_roll)(this.actor.rotation)),console.log("scale:",this.actor.scale);break;case"r":var i=this.service("ThreeRenderManager").renderer;console.log("Renderer",i),console.log("Scene polycount:",i.info.render.triangles),console.log("Active Drawcalls:",i.info.render.calls),console.log("Textures in Memory",i.info.memory.textures),console.log("Geometries in Memory",i.info.memory.geometries)}else switch(e.key){case"Tab":this.jumpToNote(e);break;case"w":case"W":case"a":case"A":case"d":case"D":case"s":case"S":switch(this.yawDirection=-2,this.wasdMap[e.key.toLowerCase()]=!0,e.key){case"w":case"W":s=t[2]===l?0:-l,this.wasdVelocity=[t[0],t[1],s];break;case"a":case"A":s=t[0]===l?0:-l,this.wasdVelocity=[s,t[1],t[2]];break;case"d":case"D":s=t[0]===-l?0:l,this.wasdVelocity=[s,t[1],t[2]];break;case"s":case"S":s=t[2]===-l?0:l,this.wasdVelocity=[t[0],t[1],s]}this.velocity=this.wasdVelocity,this.maybeLeavePresentation()}}keyUp(s){switch(s.key){case"w":case"W":case"a":case"A":case"d":case"D":case"s":case"S":this.yawDirection=-1,this.wasdMap[s.key.toLowerCase()]=!1;let e;e=this.wasdMap.a&&!this.wasdMap.d?-.01:!this.wasdMap.a&&this.wasdMap.d?.01:0;let t;t=this.wasdMap.w&&!this.wasdMap.s?-.01:!this.wasdMap.w&&this.wasdMap.s?.01:0,this.wasdVelocity=[e,0,t],this.velocity=this.wasdVelocity}}addSticky(e){if(e.shiftKey){const s=this.service("ThreeRenderManager");var t=this.pointerRaycast(e.xy,s.threeLayerUnion("pointer","walk")),t=this.pointerEvent(t,e);this.say("addSticky",t)}}stopFalling(){this.isFalling=!1}xy2yp(e){var t=this.service("ThreeRenderManager").camera.fov/2,s=window.innerHeight/2,i=window.innerWidth/2,t=t*Math.PI/180/s;return[t*(e[0]-i),t*(s-e[1])]}pointerDown(t){if(t.ctrlKey||t.altKey){const i=this.service("ThreeRenderManager");var s=this.pointerRaycast(t.xy,i.threeLayerUnion("pointer"));this.targetDistance=s.distance;let e=this.pointerEvent(s,t);e.lookNormal=this.actor.lookNormal;s=(0,y.GetPawn)(e.targetId);this.editPawn!==(s=s||null)?(this.editPawn&&(console.log("pointerDown clear old editPawn"),this.editPawn.unselectEdit(),this.editPawn=null,this.editPointerId=null),console.log("pointerDown set new editPawn",s),s&&(this.editPawn=s,this.editPointerId=t.id,this.editPawn.selectEdit(),this.buttonDown=t.button,e.normal||(e.normal=this.actor.lookNormal),this.p3eDown=e)):console.log("pointerDown in editMode")}else this.focusPawn||(this.dragWorld=this.xy2yp(t.xy),this.lookYaw=(0,y.q_yaw)(this._rotation))}pointerMove(t){if(this.editPawn)t.id===this.editPointerId&&(0===this.buttonDown?this.editPawn.dragPlane(this.setRayCast(t.xy),this.p3eDown):2==this.buttonDown&&this.editPawn.rotatePlane(this.setRayCast(t.xy),this.p3eDown));else if(!this.focusPawn&&this.isPointerDown){var t=this.xy2yp(t.xy),s=this.lookYaw+(this.dragWorld[0]-t[0])*this.yawDirection;let e=this.lookPitch+this.dragWorld[1]-t[1];e=1<e?1:e<-1?-1:e,this.dragWorld=t,this.lookTo(e,s)}}pointerUp(e){if(this.editPawn&&(this.editPawn.unselectEdit(),this.editPawn=null,this.editPointerId=null,this.p3eDown=null,this.buttonDown=null),this.firstResponders)for(var[t,s]of this.firstResponders)for(let e=s.length-1;0<=e;e--)s[e].pawn!==this&&s.splice(e,1)}pointerTap(e){this.editPawn&&(this.editPawn.unselectEdit(),this.editPawn.showControls({avatar:this.actor.id,distance:this.targetDistance}),this.editPawn=null,this.editPointerId=null)}pointerWheel(e){var t=this.lookOffset[2],e=(t+=Math.max(1,t)*e.deltaY/1e3,t=Math.min(100,Math.max(t,0)),this.lookOffset=[this.lookOffset[0],t,t],(11*this.lookPitch+Math.max(-t/2,-Math.PI/4))/12);this.lookTo(e,(0,y.q_yaw)(this._rotation),this.lookOffset)}fadeNearby(){var e,t,s=this.actor.service("PlayerManager"),i=s.presentationMode,r=(e,t)=>{e.shape.children.length&&e.lastOpacity!==t&&(e.lastOpacity=t,e.setOpacity(t))};for([e,t]of s.players){var a=(0,y.GetPawn)(t.id);if(this.actor.inWorld)if(t.follow)r(a,0);else if((a===this||t._playerId===i&&this.actor.follow)&&(0,y.v3_isZero)(t.lookOffset))r(a,0);else{var o=this.lookGlobal;let e=new g.THREE.Vector3(o[12],o[13],o[14]);o=t.global,o=new g.THREE.Vector3(o[12],o[13],o[14]);r(a,Math.min(Math.max((e.distanceToSquared(o)-.7)/10,0),1))}else r(a,1)}this.future(100).fadeNearby()}setOpacity(s){if(this.shape){let t=1!==s;this.shape.visible=this.actor.inWorld&&0!==s,this.shape.traverse(e=>{e.material&&e.material.opacity!==s&&(e.material.opacity=s,e.material.transparent=t,e.material.side=g.THREE.DoubleSide,e.material.needsUpdate=!0)})}}goHome(){this.say("goHome")}comeToMe(){var e=this.actor.service("PlayerManager");e.presentationMode?e.presentationMode===this.viewId&&this.say("stopPresentation"):this.say("comeToMe")}jumpToNote(t){let e=this.actor.queryCards({methodName:"filterNotes"},this),s;void 0===this.lastCardId?s=0:(s=e.findIndex(e=>e.id===this.lastCardId),t.shiftKey?s--:s++),(s=s>=e.length?0:s)<0&&(s=e.length-1);t=e[s];if(t){this.lastCardId=t.id;let e=(0,y.GetPawn)(t.id);var i=e.getJumpToPose?e.getJumpToPose():null;i&&(i={xyz:i[0],offset:i[1],look:!0,targetId:t.id,normal:e.hitNormal||[0,0,1]},this.say("goThere",i))}}filterNotes(e){return e._behaviorModules&&e._behaviorModules.includes("StickyNote")}loadFromFile(e,t,s){var i=this.actor.wellKnownModel("ModelRoot");let r=(new TextEncoder).encode(e),a=0;var o=Math.random();for(this.publish(i.id,"loadStart",o);a<r.length;){var n=r.slice(a,a+2880);this.publish(i.id,"loadOne",{key:o,buf:n}),a+=2880}e=s?this.dropPose(6):null;this.publish(i.id,"loadDone",{asScene:t,key:o,pose:e})}}},3654:(e,t,s)=>{"use strict";s.d(t,{Z4:()=>CardActor,Df:()=>CardPawn,q7:()=>MicroverseAppManager,X7:()=>VideoManager,Wh:()=>a});var u=s(4200),v=s(5679),t=s(2691),w=s(3782),p=s(4355);class DynamicTexture{constructor(e,t,s,i){(2048<e||2048<t)&&console.warn("large texture: "+e+"x"+t);var r=e=>2**Math.round(Math.log(e)/Math.LN2),a=r(e),r=r(t);a===e&&r===t||console.log("TDynamicTexture: "+e+"x"+t+" becomes "+a+"x"+r),this.canvas=document.createElement("canvas"),this.canvas.width=this.width=a,this.canvas.height=this.height=r,this.context=this.canvas.getContext("2d"),this.texture=new v.THREE.CanvasTexture(this.canvas),this.extractMipmapLevel=3,this.fontName="Arial",this.fontHeight=32,this.fillStyle=s||"black",this.clearStyle=i,this.setFont("normal 32px Arial"),this.align="left",this.scale=1}asMaterial(){return new v.THREE.MeshStandardMaterial({color:16777215,roughness:1,emissive:3355443,map:this.texture,transparent:!1})}getTexture(){return this.texture}getMiniTexture(){if(!this.miniTexture){var l=this.texture,h=this.extractMipmapLevel,d=2**h,c=this.width/d,d=this.height/d;let e=this.service("ThreeRenderManager").renderer,t=e.getContext(),s=t.createTexture();var u=t.RGBA,p=t.RGBA,f=t.UNSIGNED_BYTE;t.bindTexture(t.TEXTURE_2D,s);let i=v.THREE.WebGLUtils(t);t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,l.flipY),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,l.premultiplyAlpha),t.pixelStorei(t.UNPACK_ALIGNMENT,l.unpackAlignment),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,i.convert(l.wrapS)),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,i.convert(l.wrapT)),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,i.convert(l.magFilter)),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,i.convert(l.minFilter)),t.texImage2D(t.TEXTURE_2D,0,u,p,f,this.canvas),t.generateMipmap(t.TEXTURE_2D);l=t.createFramebuffer();t.bindFramebuffer(t.FRAMEBUFFER,l),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,s,h);let r;u=t.checkFramebufferStatus(t.FRAMEBUFFER),p=u===t.FRAMEBUFFER_COMPLETE;if(p?(r=new Uint8Array(c*d*4),t.readPixels(0,0,c,d,t.RGBA,t.UNSIGNED_BYTE,r)):console.log("frame buffer not ready; status="+u),t.deleteFramebuffer(l),t.deleteTexture(s),!p)return null;let a=document.createElement("canvas"),o=a.getContext("2d"),n=(a.width=c,a.height=d,o.createImageData(c,d));n.data.set(r),o.putImageData(n,0,0),this.miniTexture=new v.THREE.CanvasTexture(a),this.miniTexture.flipY=!1}return this.miniTexture}discardMiniTexture(){delete this.miniTexture}setFont(e){this.context.font=this.font=this.lastContextFont=e}setContextFont(e){e!==this.lastContextFont&&(this.context.font=this.lastContextFont=e)}setFillStyle(e){this.fillStyle=e}setAlign(e){this.align=e}doWithClip(e,t,s,i,r){let a=this.context;a.save(),a.beginPath(),a.rect(e,t,s,i),a.clip(),r(),a.restore(),this.lastContextFont=this.font}fill(e){this.context.save(),this.context.scale(1/this.scale,1/this.scale),this.fillRect(0,0,this.canvas.width,this.canvas.height,e),this.context.restore()}clear(){this.context.save(),this.context.scale(1/this.scale,1/this.scale),this.clearRect(0,0,this.canvas.width,this.canvas.height),this.texture.needsUpdate=!0,this.context.restore()}fillRect(e,t,s,i,r){this.context.fillStyle=r||this.fillStyle,this.context.fillRect(e,t,s,i),this.texture.needsUpdate=!0}clearRect(e,t,s,i){void 0!==this.clearStyle?(this.context.fillStyle=this.clearStyle,this.context.fillRect(e,t,s,i)):this.context.clearRect(e,t,s,i),this.texture.needsUpdate=!0}drawImage(...e){this.context.drawImage(...e),this.texture.needsUpdate=!0}drawText(e,t,s,i,r,a){if(!function isNumber(e){return!isNaN(parseFloat(e))&&isFinite(e)}(t))return this.drawTextCentered(e,s,i,r,a);this.setContextFont(r||this.font);let o=this.context;o.textAlign=this.align,a||(o.fillStyle="black",o.fillText(e,t+1,s+1)),o.fillStyle=i||this.fillStyle,o.fillText(e,t,s),this.texture.needsUpdate=!0}drawTextCentered(e,t,s,i,r){this.setContextFont(i||this.font);var i=this.context.measureText(e).width,a=this.fontHeight,i=(this.canvas.width-i)/2;"number"!=typeof t&&(t=(this.canvas.height+a)/2-2),r||(this.context.fillStyle="black",this.context.fillText(e,1+i,t+1)),this.context.fillStyle=s||this.fillStyle,this.context.fillText(e,i,t),this.texture.needsUpdate=!0}drawTextRight(e,t,s,i,r){this.setContextFont(i||this.font);var i=this.context.measureText(e).width+2,a=this.fontHeight,i=this.canvas.width-i;"number"!=typeof t&&(t=(this.canvas.height+a)/2-2),r||(this.context.fillStyle="black",this.context.fillText(e,1+i,t+1)),this.context.fillStyle=s||this.fillStyle,this.context.fillText(e,i,t),this.texture.needsUpdate=!0}drawTextLeft(e,t,s,i){this.setContextFont(i||this.font);i=this.fontHeight,t=t||(this.canvas.height+i)/2-2;this.context.fillStyle="black",this.context.fillText(e,3,t+1),this.context.fillStyle=s||this.fillStyle,this.context.fillText(e,2,t),this.texture.needsUpdate=!0}drawRect(e,t,s,i,r,a){this.context.beginPath(),this.context.lineWidth=a||"4",this.context.strokeStyle=r||"green",this.context.rect(e,t,s,i),this.context.stroke(),this.texture.needsUpdate=!0}drawLine(e,t,s,i,r,a){this.context.lineWidth=a||"1",this.context.strokeStyle=r||"white",this.context.beginPath(),this.context.moveTo(e,t),this.context.lineTo(s,i),this.context.stroke(),this.texture.needsUpdate=!0}drawPoly(t,e,s){this.context.lineWidth=s||"1",this.context.strokeStyle=e||"white",this.context.beginPath(),this.context.moveTo(t[0],t[1]);for(let e=2;e<t.length;e+=2)this.context.lineTo(t[e],t[e+1]);this.context.stroke(),this.texture.needsUpdate=!0}drawPath(e){this.context.stroke(e),this.texture.needsUpdate=!0}drawImage(e,t,s,i,r){this.context.drawImage(e,t,s,i,r),this.texture.needsUpdate=!0}changed(){this.texture.needsUpdate=!0,this.mipmapTexture.dispose(),this.mipmapTexture=null}setScale(e){this.scale=e,this.context.scale(e,e)}}var i=s(6946),n=s(4072);const r=v.THREE_MESH_BVH["MeshBVH"],a=["translation","scale","rotation","layers","parent","behaviorModules","multiuser","name","noSave"];class CardActor extends(0,u.mix)(u.Actor).with(u.AM_Smoothed,t.w9,i.Xl){static okayToIgnore(){return["$local","$global","$rigidBody"]}init(e){let{cardOptions:t,cardData:s}=this.separateOptions(e);t.layers||(t.layers=["pointer"]),this.scriptListeners=new Map,super.init(t),this._cardData=s,this.noSave=e.noSave,this.createShape(s),this.listen("selectEdit",this.saySelectEdit),this.listen("unselectEdit",this.sayUnselectEdit),this.listen("showControls",this.showControls),this.listen("setCardData",this.setCardData),this.listen("setAnimationClipIndex",this.setAnimationClipIndex)}separateOptions(t){let s={},i={};return Object.keys(t).forEach(e=>{0<=a.indexOf(e)?s[e]=t[e]:i[e]=t[e]}),{cardOptions:s,cardData:i}}updateOptions(e){var{cardOptions:t,cardData:s}=this.separateOptions(e);this.updateBehaviors(e),this.set({...t}),this.set({cardData:s}),this.say("updateShape",e)}addBehaviorModule(e){let t;if(this._behaviorModules){if(this._behaviorModules.includes(e))return;t=[...this._behaviorModules,e]}else t=[e];this.updateBehaviors({behaviorModules:t})}removeBehaviorModule(e){let t;!this._behaviorModules||(e=this._behaviorModules.indexOf(e))<0||((t=[...this._behaviorModules]).splice(e,1),this.updateBehaviors({behaviorModules:t}))}updateBehaviors(l){if(l.behaviorModules){let s=this.behaviorManager,i=[],r=[],a=(l.behaviorModules.forEach(e=>{let t=s.modules.get(e);t?(t.actorBehaviors&&i.push(...t.actorBehaviors.values()),t.pawnBehaviors&&r.push(...t.pawnBehaviors.values())):console.error(`unknown module ${e} is specified for update`)}),[]),o=[],n=[];this._behaviorModules&&this._behaviorModules.forEach(e=>{let t=s.modules.get(e);t.actorBehaviors&&a.push(...t.actorBehaviors.values()),t.pawnBehaviors&&o.push(...t.pawnBehaviors.values()),t.systemModule&&l.behaviorModules.includes(t.externalName)&&(n.push(t.externalName),t.actorBehaviors&&i.push(...t.actorBehaviors.values()),t.pawnBehaviors&&r.push(...t.pawnBehaviors.values()))}),a.forEach(e=>{i.includes(e)||s.modelUnuse(this,e)}),o.forEach(e=>{r.includes(e)||s.viewUnuse(this,e)}),i.forEach(e=>{a.includes(e)||s.modelUse(this,e)}),r.forEach(e=>{o.includes(e)||s.viewUse(this,e)}),this._behaviorModules=[...n,...l.behaviorModules]}}addLayer(e){this._layers&&this._layers.includes(e)||this.set({layers:[...this._layers||[],e]})}removeLayer(t){this._layers.includes(t)&&(this._layers=this._layers.filter(e=>e!==t))}setCardData(e){e={...this._cardData,...e};this.set({cardData:e})}createShape(e){var t=e.type;"text"===t?this.subscribe(this.id,"changed","textChanged"):"code"===t?(this.subscribe(this.id,"changed","textChanged"),this.subscribe(this.id,"text","codeAccepted")):"3d"===t||"3D"===t?void 0!==this._cardData.animationClipIndex&&void 0===this._cardData.animationStartTime&&(this._cardData.animationStartTime=this.now()):"2d"!==t&&"2D"!==t&&"lighting"!==t&&"object"!==t&&console.log("unknown type for a card: ",e.type)}get pawn(){return CardPawn}get layers(){return this._layers}get isCard(){return!0}get name(){return this._name||"Card"}get color(){return this._color||16777215}uv2xy(e){return[this._cardData.textureWidth*e[0],this._cardData.textureHeight*(1-e[1])]}textChanged(){this._cardData.runs=this.content.runs,this.publish(this.sessionId,"triggerPersist")}sayDeck(e,t){if(this._parent)return this.publish(this._parent.id,e,t);this.publish(this.id,e,t)}listenDeck(e,t){if(this._parent)return this.subscribe(this._parent.id,e,t);this.subscribe(this.id,e,t)}rotateBy(e){e=3===e.length?(0,u.q_euler)(...e):e,e=(0,u.q_multiply)(this.rotation,e);this.rotateTo(e)}translateBy(e){var e=Array.isArray(e)?e:[0,0,e],t=this.translation;this.translateTo([t[0]+e[0],t[1]+e[1],t[2]+e[2]])}forwardBy(e){var e=Array.isArray(e)?e:[0,0,e],e=(0,u.v3_rotate)(e,this.rotation),t=this.translation;this.translateTo([t[0]+e[0],t[1]+e[1],t[2]+e[2]])}scaleBy(e){var e=Array.isArray(e)?e:[e,e,e],t=this.scale;this.scaleTo([t[0]+e[0],t[1]+e[1],t[2]+e[2]])}nop(){}duplicate(){let e=new n.H(CardActor),t=e.collectCardData(this);delete t.parent;var s=this.translation;t.translation=[s[0]+2,s[1],s[2]],this.createCard(t)}saveCard(e){this.say("saveCard",e)}allChildrenMap(t){return t=t||new Map,this.noSave||t.set(this.id,this),this.children&&this.children.forEach(e=>e.allChildrenMap(t)),t}showControls(t){let e=this.service("ActorManager").actors.get(t.avatar);t=t.distance||6,t=Math.min(.7*t,4);if(e){t=e.dropPose(t,[1,1,0]);if(this.behaviorManager.modules.get("PropertySheet")){let e=this.createCard({name:"property panel",behaviorModules:["PropertySheet"],translation:t.translation,rotation:t.rotation,type:"object",fullBright:!0,color:16777215,frameColor:6710886,width:3,height:3.2,cornerRadius:.02,depth:.02,noSave:!0,target:this.id});e.call("PropertySheet$PropertySheetActor","setObject",this)}}}setBehaviors(e){let s=[];e.forEach(e=>{var{label:e,selected:t}=e;this.behaviorManager.modules.get(e)&&t&&s.push(e)}),this.updateBehaviors({behaviorModules:s})}setAnimationClipIndex(e){void 0===this._cardData.animationClipIndex&&(this._cardData.animationClipIndex=e,void 0===this._cardData.animationStartTime&&(this._cardData.animationStartTime=this.now()),this.say("animationStateChanged"))}intrinsicProperties(){return a}saySelectEdit(){this.say("doSelectEdit")}sayUnselectEdit(){this.say("doUnselectEdit")}collectCardData(){let e=new n.H(CardActor);return e.collectCardData(this,!0)}static load(e,t,s){let i,c;if(Array.isArray(e)?i=e:(i=e.array,c=e.nameMap),"1"!==s)return[];{let l=t.service("MicroverseAppManager"),h=t.service("BehaviorModelManager"),d=new Map;return i.map(({id:e,card:t})=>{let s,i={...t},r;var a,o;"code"===i.type?(i.behaviorModule&&([a,o]=i.behaviorModule.split("."),r=h.lookup(a,o)),a=[{text:r?r.code:""}],i={backgroundColor:13421772,textScale:i.textScale||.002,...i,runs:a},s=p.T0):t.className?(s=l.get(t.className),delete i.className):s=CardActor,t.parent&&"object"!=typeof t.parent&&(o=d.get(t.parent),i.parent=o),Array.isArray(t.rotation)&&3===t.rotation.length&&(i.rotation=(0,u.q_euler)(...t.rotation)),Array.isArray(t.dataRotation)&&3===t.dataRotation.length&&(i.dataRotation=(0,u.q_euler)(...t.dataRotation)),i.targetURL&&!i.portalURL&&(i.portalURL=i.targetURL,delete i.targetURL),c&&i.behaviorModules&&(i.behaviorModules=i.behaviorModules.map(e=>c.get(e)||e)),"string"==typeof i.parent&&(console.log("encountered parent as string",i.parent),delete i.parent);let n=s.create(i);return e&&d.set(e,n),"code"===i.type&&r&&n.subscribe(r.id,"setCode","loadAndReset"),n})}}get rigidBody(){return this.call("Rapier$RapierActor","getRigidBody")}setPhysicsWorld(e){return this._physicsWorld=e}get physicsWorld(){var e=this.service("PhysicsManager");return e.globalWorld||this._physicsWorld||(this._parent?this._parent._physicsWorld:void 0)}collisionEvent(e,t,s){return this.call(this.collisionEventHandlerBehavior,this.collisionEventHandlerMethod,e,t,s)}}CardActor.register("CardActor");class CardPawn extends(0,u.mix)(u.Pawn).with(u.PM_Smoothed,v.PM_ThreeVisible,t.vJ,i.AH){constructor(e){super(e),this.addToLayers(...e.layers),this.addEventListener("pointerDoubleDown","onPointerDoubleDown"),this.listen("doSelectEdit",this.doSelectEdit),this.listen("doUnselectEdit",this.doUnselectEdit),this.listen("cardDataSet",this.cardDataUpdated),this.listen("updateShape",this.updateShape),this.listen("layersSet",this.updateLayers),this.listen("saveCard",this.saveCard),this.listen("animationStateChanged",this.tryStartAnimation),this.subscribe(this.id,"3dModelLoaded",this.tryStartAnimation),this.constructCard()}sayDeck(e,t){void 0!==this.actor._parent?this.publish(this.actor._parent.id,e,t):this.publish(this.actor.id,e,t)}listenDeck(e,t){void 0!==this.actor._parent?this.subscribe(this.actor._parent.id,e,t):this.subscribe(this.actor.id,e,t)}constructCard(){this.shape=new v.THREE.Group,this.shape.name=this.actor.name,this.setRenderObject(this.shape),this.constructShape(this.actor._cardData)}constructShape(e){var t=e.type;"3d"===t||"3D"===t?this.construct3D(e):"2d"===t||"2D"===t?(this.isFlat=!0,this.construct2D(e)):"text"!==t&&"code"!==t||(this.isFlat=!0)}destroy(){var e=this.actor._cardData;let t=this.service("AssetManager").assetManager;e.dataLocation&&t.revoke(e.dataLocation,this.id),e.textureLocation&&t.revoke(e.textureLocation,this.id),super.destroy()}ensureColliderObject(){if(!this.colliderObject){let e=new v.THREE.Group;this.setColliderObject(e),e.collider=!0}}cleanupColliderObject(){this.colliderObject&&(this.colliderObject.children.forEach(e=>{this.colliderObject.remove(e)}),this.colliderObject.geometry&&this.colliderObject.geometry.dispose(),delete this.colliderObject)}updateLayers(){let e=this.layers(),t=[];e.forEach(e=>{this.actor.layers.includes(e)||t.push(e)}),0<t.length&&this.removeFromLayers(...t);var s=this.actor._layers;s&&this.addToLayers(...s)}cleanupShape(e){this.updateLayers(),delete this.isFlat,this.placeholder&&(this.placeholder.children.forEach(e=>{e.geometry.dispose(),e.material.dispose()}),this.shape.remove(this.placeholder),delete this.placeholder),delete this.video,this.texture&&(this.texture.dispose(),delete this.texture),this.objectURL&&(URL.revokeObjectURL(this.objectURL),delete this.objectURL),this.material&&this.material.dispose(),delete this.name,delete this.properties2D,delete this.animationSpec,this.cleanupColliderObject(),this.shape&&(this.shape.traverse(e=>{e!==this.shape&&(e.geometry&&e.geometry.dispose(),e.material&&(e.material.dispose?e.material.dispose():e.material.forEach(e=>e.dispose())))}),this.shape.children.forEach(e=>this.shape.remove(e)))}updateShape(e){this.cleanupShape(e),this.constructShape(this.actor._cardData)}construct3D(s){let i=s.dataLocation,r=s.modelType;if(s.placeholder){var t=s.placeholderSize||[40,1,40],a=s.placeholderColor||8421504,o=s.placeholderOffset||[0,-1.7,0];const d=(new v.THREE.TextureLoader).load("./assets/images/grid.png");d.wrapS=v.THREE.RepeatWrapping,d.wrapT=v.THREE.RepeatWrapping,d.repeat.set(t[0],t[2]);t=new v.THREE.BoxGeometry(...t),a=new v.THREE.MeshStandardMaterial({map:d,color:a,side:v.THREE.FrontSide});let e=new v.THREE.Mesh(t,a);e.receiveShadow=!0,this.placeholder=e,this.placeholder.position.set(...o),this.placeholder.name="placeholder",0<=this.actor.layers.indexOf("walk")&&this.constructCollider(this.placeholder),this.shape.add(this.placeholder)}let n=this.actor.name,l=void 0===s.shadow||s.shadow,h=void 0!==s.singleSided&&s.singleSided;if(i){let t=this.service("AssetManager").assetManager;this.getBuffer(i).then(e=>(t.setCache(i,e,this.id),t.load(e,r,v.THREE))).then(e=>{(0,w.bR)(e,l,h,v.THREE),this.setupObj(e,s),this.setupAnimation(e),e.updateMatrixWorld(!0),s.placeholder&&(console.log("delete collider for placeholder"),t.revoke(i,this.id),this.cleanupColliderObject(),this.shape.remove(this.placeholder)),0<=this.actor.layers.indexOf("walk")&&this.constructCollider(e),this.shape.add(e),n&&(e.name=n),Array.isArray(e.material)&&(e.material.dispose=arrayDispose),this.publish(this.id,"3dModelLoaded")})}}construct2D(t){let s=t.dataLocation,r=t.textureLocation;var e=t.textureType;let i,a=void 0!==t.depth?t.depth:.05,o=void 0!==t.width?t.width:1,n=void 0!==t.height?t.height:1,l=void 0!==t.textureWidth?t.textureWidth:512,h=void 0!==t.textureHeight?t.textureHeight:512;var d=t.name||this.id;let c=t.color,u=t.frameColor||6710886,p=void 0!==t.fullBright&&t.fullBright,f=void 0===t.shadow||t.shadow,m=void 0!==t.cornerRadius?t.cornerRadius:0;if(this.properties2D={depth:a,width:o,height:n,textureWidth:l,textureHeight:h,name:d,color:c,frameColor:u,fullBright:p,shadow:f,cornerRadius:m},"video"===e){this.video=document.createElement("video"),this.video.autoplay=!0,this.video.muted=!0,this.video.loop=!0,this.video.width=l,this.video.height=h,this.getBuffer(r).then(e=>{e=URL.createObjectURL(new Blob([e],{type:"video/mp4"}));this.video.src=e,this.objectURL=e}),this.video.loop=!0;let e=this.service("VideoManager");e.add(this.video),this.texture=new v.THREE.VideoTexture(this.video),i=Promise.resolve({width:this.video.width,height:this.video.height,texture:this.texture})}else"image"===e?i=this.getBuffer(r).then(e=>{if(e.texture)return this.texture=e.texture,Promise.resolve(e);let s=URL.createObjectURL(new Blob([e]));return this.objectURL=s,new Promise((t,e)=>{this.texture=(new v.THREE.TextureLoader).load(s,e=>{URL.revokeObjectURL(s),t({width:e.image.width,height:e.image.height,texture:e})},null,e)})}):"canvas"===e?(this.canvas=document.createElement("canvas"),this.canvas.id=d,this.canvas.width=l,this.canvas.height=h,this.texture=new v.THREE.CanvasTexture(this.canvas),i=Promise.resolve({width:l,height:h,texture:this.texture})):"dynamic"===e&&(this.dynamic=new DynamicTexture(l,h,t.fillStyle,t.clearStyle),this.texture=this.dynamic.texture,i=Promise.resolve({width:l,height:h,texture:this.texture}));i=i||Promise.resolve(void 0);let y={texture:this.texture,color:c,frameColor:u,fullBright:p,shadow:f,depth:a},g=this.service("AssetManager").assetManager;return s?this.getBuffer(s).then(e=>(g.setCache(s,e,this.id),g.load(e,"svg",v.THREE,y))).then(e=>((0,w.bp)(e,a,f,v.THREE),e)).then(e=>{this.texture&&(0,w.iF)(e,this.texture),t.dataTranslation&&e.position.set(...t.dataTranslation),e.name="2d",Array.isArray(e.material)&&(e.material.dispose=arrayDispose),this.objectCreated(e),this.shape.add(e)}):i.then(e=>{e&&e.texture&&(l=e.width,h=e.height,t=1/Math.max(l,h),o=l*t,n=h*t,r&&g.setCache(r,e,this.id),this.properties2D={...this.properties2D,width:o,height:n,textureWidth:l,textureHeight:h});var t=this.roundedCornerGeometry(o,n,a,m);let s=this.makePlaneMaterial(a,c||16777215,u,p),i=(this.texture&&(s[0].map=this.texture),this.material=s,new v.THREE.Mesh(t,s));i.castShadow=f,i.name="2d",this.objectCreated(i),this.shape.add(i)})}constructCollider(t){let i=[];this.ensureColliderObject();let s;try{t.traverse(t=>{if(t.geometry){let e=t.geometry.clone();e.applyMatrix4(t.matrixWorld);for(const s in e.attributes)"position"!==s&&e.deleteAttribute(s);e.index?i.push(e):console.warn("skipping a geometry in the model that is not indexed")}});let e=window.THREE.BufferGeometryUtils;(s=e.mergeBufferGeometries(i,!1)).boundsTree=new r(s,{lazyGeneration:!1})}catch(e){return console.error("failed to build the BVH collider for:",t),void console.error(e)}let e=new v.THREE.Mesh(s);e.material.wireframe=!0,e.material.opacity=.5,e.matrixWorld=t.matrixWorld.clone(),e.updateMatrixWorld(!0),e.visible=!1,this.colliderObject.add(e)}setupObj(e,t){t.dataScale&&e.scale.set(...t.dataScale),t.dataTranslation&&e.position.set(...t.dataTranslation),t.dataRotation&&(t=3===t.dataRotation.length?(0,u.q_euler)(...t.dataRotation):t.dataRotation,e.quaternion.set(...t))}setupAnimation(e){e._croquetAnimation&&(e=e._croquetAnimation,this.animationSpec=e,void 0===this.actor._cardData.animationClipIndex&&0<e.animations.length&&this.say("setAnimationClipIndex",0))}objectCreated(){}roundedCornerGeometry(e,i,t,s){var r=i/2,a=e/2,o=t/2,s=void 0===s?0:s;let n=new v.THREE.Shape,l=(n.moveTo(-r,-a+s),n.lineTo(-r,a-s),n.quadraticCurveTo(-r,a,-r+s,a),n.lineTo(r-s,a),n.quadraticCurveTo(r,a,r,a-s),n.lineTo(r,-a+s),n.quadraticCurveTo(r,-a,r-s,-a),n.lineTo(-r+s,-a),n.quadraticCurveTo(-r,-a,-r,-a+s),new v.THREE.LineCurve3(new v.THREE.Vector3(0,0,o),new v.THREE.Vector3(0,0,-o))),h=(l.arcLengthDivisions=3,new v.THREE.ExtrudeGeometry(n,{extrudePath:l}));h.parameters.width=e,h.parameters.height=i,h.parameters.depth=t;var s=new v.THREE.Box3(new v.THREE.Vector3(-r,-a,-o),new v.THREE.Vector3(r,a,o)),d=h.getAttribute("uv").array,i=(e=s).max.x-e.min.x,e=e.max.y-e.min.y;if(i&&e){let t=1,s=1;i<e?s=e/i:e<i&&(t=i/e);for(let e=0;e<d.length;e+=2)d[e]=d[e]*t+.5,d[e+1]=d[e+1]*s+.5}return h}makePlaneMaterial(e,t,s,i){this.material&&this.material.dispose();let r;return r=i?new v.THREE.MeshBasicMaterial({color:t,side:v.THREE.FrontSide,toneMapped:!1}):new v.THREE.MeshPhongMaterial({color:t,side:v.THREE.FrontSide}),0<e&&(i=new v.THREE.MeshPhongMaterial({color:s,side:v.THREE.FrontSide}),r=[r,i]),this.material=r,Array.isArray(this.material)&&(this.material.dispose=arrayDispose),r}isDataId(e){return!(e.startsWith("http://")||e.startsWith("https://")||e.startsWith(".")||e.startsWith("/"))}getBuffer(e){let t=this.service("AssetManager").assetManager;var s=t.getCache(e);return s?Promise.resolve(s):this.isDataId(e)?(s=u.Data.fromId(e),u.Data.fetch(this.sessionId,s)):fetch(e).then(e=>e.arrayBuffer()).then(e=>new Uint8Array(e))}cardDataUpdated(l){if(this.didPropertyChange(l,["type","dataLocation","dataRotation","dataScale"]))return this.updateShape();if("2d"===l.v.type){let n=this.shape.children.find(e=>"2d"===e.name);if(n&&n.children&&0!==n.children.length&&(n=n.children[0],this.didPropertyChange(l,["depth","width","height","color","frameColor","cornerRadius","fullBright"]))){let{depth:e,width:t,height:s,color:i,frameColor:r,cornerRadius:a,fullBright:o}=l.v;e=void 0!==e?e:.05,t=void 0!==t?t:1,s=void 0!==s?s:1,a=void 0!==a?a:0,o=void 0!==o&&o;var h=this.makePlaneMaterial(e,i||16777215,r||6710886,o);this.didPropertyChange(l,["depth","width","height","cornerRadius"])&&(l=this.roundedCornerGeometry(t,s,e,a),n.geometry=l),n.material=h}}}didPropertyChange({o:t,v:s},e){return Array.isArray(e)?e.some(e=>t[e]!==s[e]):t[e]!==s[e]}uv2xy(e){return this.actor.uv2xy(e)}onPointerDoubleDown(e){var t;e.targetId&&((t=this.getJumpToPose?this.getJumpToPose():null)&&(e.xyz=t[0],e.offset=t[1],e.look=!0),this.publish(e.avatarId,"goThere",e))}showControls(e){this.say("showControls",e)}getJumpToPose(){if(!this.isFlat)return null;var e=this.renderObject.localToWorld(new v.THREE.Vector3).toArray(),t=this.service("ThreeRenderManager"),s=t.camera.aspect,i=t.canvas.width,t=t.canvas.height,r=t/2*Math.sqrt(3),a=this.renderObject.matrix,o=new v.THREE.Vector3(0,0,0);try{let e=new v.THREE.Vector3(0,0,0),t=(e.setFromMatrixScale(a),new v.THREE.Matrix4);t.makeScale(e.x,e.y,e.z),this.renderObject.matrix=t,(new v.THREE.Box3).setFromObject(this.renderObject).getSize(o)}finally{this.renderObject.matrix=a}return[e,1.1*(o.x/o.y<s?o.y*r/t:o.x*r/i)]}verticalNorm(e){let t=[...e];return(t[1]=0,u.v3_sqrMag)(t)<.001&&(t[0]=0,t[1]=e[1],t[2]=0),(0,u.v3_normalize)(t)}dragPlane(e,t){this._plane||(i=t.normal||t.lookNormal,i=this.verticalNorm(i),r=(0,u.v3_dot)(t.xyz,i),this._plane=new v.THREE.Plane(new v.THREE.Vector3(...i),-r),this._parentInvert=this._parent?(0,u.m4_invert)(this._parent.global):(0,u.m4_identity)(),this.startDrag=(0,u.v3_transform)(t.xyz,this._parentInvert),this._startTranslation=this._translation);let s=new v.THREE.Vector3;e.ray.intersectPlane(this._plane,s);var i=s.toArray(),r=(0,u.v3_transform)(i,this._parentInvert),t=(0,u.v3_sub)(r,this.startDrag);this.set({translation:(0,u.v3_add)(this._startTranslation,t)})}rotatePlane(e,t){if(!this._plane){let e=[...t.lookNormal];e[1]=0,e=(0,u.v3_normalize)(e);var s=(0,u.v3_dot)(t.xyz,e);this._plane=new v.THREE.Plane(new v.THREE.Vector3(...e),-s),this.startDrag=t.xyz,this.baseRotation=this._rotation,this.rotAngle=0}let i=new v.THREE.Vector3;e.ray.intersectPlane(this._plane,i);s=i.toArray();let r=(0,u.v3_sub)(this.startDrag,s),a=(r[1]=0,u.v3_magnitude)(r);(0,u.v3_cross)(t.lookNormal,r)[1]<0&&(a=-a);e=(0,u.q_euler)(0,a,0);this.set({rotation:(0,u.q_multiply)(this.baseRotation,e)})}tryStartAnimation(){void 0===this.actor._cardData.animationClipIndex||this.animationRunning||(this.animationRunning=!0,this.runAnimation())}runAnimation(){if(this.animationRunning){let i=this.animationSpec;if(i){this.future(50).runAnimation();var r=this.actor._cardData.animationClipIndex;if(void 0!==r&&!(r<0)){var a=this.now(),o=this.actor._cardData.animationStartTime;let{mixer:e,lastTime:t,lastAnimationClipIndex:s}=i;if(r!==s){e.stopAllAction();var n=i.animations[r];if(!n)return;e.clipAction(n).play(),i.lastAnimationClipIndex=r}n=(a-o)/1e3;e.update(n-t),i.lastTime=n}}}}selectEdit(){this.say("selectEdit")}unselectEdit(){this.say("unselectEdit"),delete this._plane}doSelectEdit(){console.log("doSelectEdit"),this.renderObject&&this.addWire(this.renderObject)}doUnselectEdit(){console.log("doUnselectEdit"),this.renderObject&&this.removeWire(this.renderObject)}nop(){}addWire(e){let r=[],a=[];e.traverse(s=>{if(s.geometry){var i=new v.THREE.EdgesGeometry(s.geometry);let e=new v.THREE.LineSegments(i,new v.THREE.LineBasicMaterial({color:4521796}));e.raycast=function(){},a.push(e);i=s.material;let t;(t=Array.isArray(i)?i:[i]).forEach(e=>{var t=e.color;t&&!e._oldColor&&(t=.5*(.299*(e._oldColor=t).r+.587*t.g+.114*t.b),e.color=new v.THREE.Color(t,t,t))}),r.push(s)}});for(let t=0;t<a.length;t++){let e=a[t];e.type="_lineHighlight",r[t].add(e)}}removeWire(e){let s=[],t;e.traverse(e=>{"_lineHighlight"===e.type?s.push(e):e.geometry&&((t=Array.isArray(e.material)?e.material:[e.material]).dispose=arrayDispose,t.forEach(e=>{e._oldColor&&(e.color=e._oldColor,delete e._oldColor)}))});for(let t=0;t<s.length;t++){let e=s[t];e.removeFromParent(),e.geometry.dispose(),e.material.dispose()}}saveCard(a){if(a.viewId===this.viewId){a=this.actor.allChildrenMap();let e=new n.H(CardActor),t={},s=e.collectData(a),i=(delete s[0].card.parent,t.cards=s,[]);s.forEach(e=>{e.card.behaviorModules&&i.push(...e.card.behaviorModules)});var a=this.actor.behaviorManager.save(i),a=(t.behaviorModules=a,u.Constants.UserRapier&&(t.useRapier=!0),e.stringify(t)),o=this.actor._name||"card",a={name:o,version:"1",data:JSON.parse(a)};let r=document.createElement("a");a="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(a,null,4));r.setAttribute("href",a),r.setAttribute("download",o+".vrse"),r.click()}}}class MicroverseAppManager extends u.ModelService{init(e){super.init("MicroverseAppManager")}add(e){}set(e,t){}get(e){try{return this.constructor.classFromID(e)}catch(e){}return null}delete(e){}}MicroverseAppManager.register("MicroverseAppManager");class VideoManager extends u.ViewService{constructor(e){super(e||"VideoManager"),this.videos=[],this.handler=()=>this.videoStart(),document.addEventListener("click",this.handler)}add(e){this.videos.indexOf(e)<0&&this.videos.push(e)}videoStart(){this.videos.forEach(e=>e.play()),this.handler&&(document.removeEventListener("click",this.handler),delete this.handler)}}function arrayDispose(){Array.isArray(this)?this.forEach(e=>e.dispose()):this.dispose()}},6946:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.d(__webpack_exports__,{AH:()=>PM_Code,IL:()=>BehaviorModelManager,Un:()=>CodeLibrary,Xl:()=>AM_Code,ui:()=>BehaviorViewManager});var _croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(4200),_ThreeRender_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(5679),_physics_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(6590);const{ViewService,ModelService,GetPawn,Model,Constants}=_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__;let isProxy=Symbol("isProxy");function newProxy(t,r,e,s){return t[isProxy]?t:new Proxy(t,{get(e,i){return i===isProxy||("_target"===i?t:"_behavior"===i?s:r&&r.hasOwnProperty(i)?new Proxy(r[i],{apply:function(e,t,s){return r[i].apply(t,s)}}):e[i])}})}const AM_Code=e=>class extends e{init(e){super.init(e),this.scriptListeners=new Map,this.behaviorManager=this.service("BehaviorModelManager"),e.behaviorModules&&e.behaviorModules.forEach(e=>{var s=this.behaviorManager.modules.get(e);if(s){let{actorBehaviors:e,pawnBehaviors:t}=s;if(e)for(var i of e.values())this.behaviorManager.modelUse(this,i);if(t)for(var r of t.values())this.behaviorManager.viewUse(this,r)}else console.error(`unknown module ${e} is specified`)})}destroy(){if(this[isProxy])return this._target.destroy();this._behaviorModules&&this._behaviorModules.forEach(e=>{var s=this.behaviorManager.modules.get(e);if(s){let{actorBehaviors:e,pawnBehaviors:t}=s;if(e)for(var i of e.values())this.behaviorManager.modelUnuse(this,i);if(t)for(var r of t.values())this.behaviorManager.viewUnuse(this,r)}else console.error(`unknown module ${e} is being torn down`)}),super.destroy()}future(e){if(!this[isProxy])return super.future(e);var t=this._behavior.$behaviorName,s=this._behavior.module.name;return this.futureWithBehavior(e,s,t)}futureWithBehavior(s,r,a){let o=(e,t)=>super.future(s,e,...t),n=this.behaviorManager,l=this.call;return new Proxy(this,{get(e,t){var s=n.lookup(r,a),s="call"===t?l:s.$behavior[t];let i="call"===t?"call":r+`$${a}.`+t;if("function"==typeof s)return new Proxy(s,{apply(e,t,s){return o(i,s)}});throw Error("Tried to call "+t+"() on future of "+a+" which is not a function")}})}call(e,t,...s){let i;var r=e.split("$");1<r.length&&(i=r[0],e=r[1]),!i&&this[isProxy]&&(i=this._behavior.module.externalName);let a=this.behaviorManager.lookup(i,e);if(a)return a.invoke(this[isProxy]?this._target:this,t,...s);throw new Error(`epxander named ${e} not found`)}listen(e,t){return this.scriptSubscribe(this.id,e,t)}subscribe(e,t,s){return this.scriptSubscribe(e,t,s)}scriptSubscribe(e,t,s){if("function"==typeof s&&!this[isProxy])return super.subscribe(e,t,s);let i,r;var a=(s="function"==typeof s?s.name:s).indexOf("$"),a=(1<=a&&(r=s.slice(0,a),s=s.slice(a+1)),s.indexOf(".")),a=(1<=a&&(i=s.slice(0,a),s=s.slice(a+1)),this._behavior);!r&&a&&(r=a.module.externalName),!i&&a&&(i=a.$behaviorName);let o;a=e+":"+t+(o=i?""+r+(r?"$":"")+i+(i?".":"")+s:s);this.scriptListeners&&this.scriptListeners.get(a)||(this.scriptListeners&&this.scriptListeners.set(a,o),super.subscribe(e,t,o))}codeAccepted(s){var i=/^class[\s]+([\S]+)/.exec(s.text.trim());if(i){let e=this._cardData.behaviorModule;var[r,a]=e.split(".");if(i[1]!==a)throw new Error("changing the behavior name not supported");i=this.behaviorManager.moduleDefs.get(r);if(!i)throw new Error("module no longer exists");let t={name:i.name,systemModule:i.systemModule,location:i.location,actorBehaviors:new Map([...i.actorBehaviors]),pawnBehaviors:new Map([...i.pawnBehaviors])};if(t.actorBehaviors.get(a)){if(t.actorBehaviors.get(a)===s.text)return;t.actorBehaviors.set(a,s.text)}else if(t.pawnBehaviors.get(a)){if(t.pawnBehaviors.get(a)===s.text)return;t.pawnBehaviors.set(a,s.text)}console.log("codeAccepted"),this.behaviorManager.loadLibraries([t])}else console.log("code does not begin with the keyword class and name")}createCard(e){e.parent&&e.parent[isProxy]&&(e={...e,parent:e.parent._target});let t=this[isProxy]?this._target:this;e=t.constructor.load([{card:e}],this.wellKnownModel("ModelRoot"),"1")[0];return this.publish(this.sessionId,"triggerPersist"),e}queryCards(t,s){let e=[...this.service("ActorManager").actors].filter(e=>e[1].isCard).map(e=>e[1]);return t&&(t.moduleName&&t.methodName?e=e.filter(e=>s.call(t.moduleName,t.methodName,e)):t.methodName&&(e=e.filter(e=>s[t.methodName].call(s,e)))),e}},PM_Code=e=>class extends e{constructor(e){super(e),this.scriptListeners=new Map;let r=this.actor.behaviorManager;this.subscribe(e.id,"callSetup","callSetup"),this.subscribe(e.id,"callTeardown","callTeardown"),e._behaviorModules&&e._behaviorModules.forEach(e=>{var t=r.modules.get(e);let s=(t||{})["pawnBehaviors"];if(s)for(var i of s.values())i&&i.ensureBehavior(),i.$behavior.setup&&this.future(0).callSetup(t.externalName+"$"+i.$behaviorName)})}actorCall(e,t,...s){let i=this.actor;var r=this._behavior.module.externalName;return i.call(r+"$"+e,t,...s)}call(e,t,...s){let i;var r=e.split("$");1<r.length&&(i=r[0],e=r[1]),!i&&this[isProxy]&&(i=this._behavior.module.externalName);let a=this.actor.behaviorManager.lookup(i,e);if(a)return a.invoke(this[isProxy]?this._target:this,t,...s);throw new Error(`epxander named ${e} not found`)}destroy(){if(this[isProxy])return this._target.destroy();this.actor._behaviorModules&&this.actor._behaviorModules.forEach(e=>{var t=this.actor.behaviorManager.modules.get(e);t||console.error(`unknown module ${e} is specified`);let s=t["pawnBehaviors"];if(s)for(var i of s.values())i.$behavior.teardown&&this.call(i.module.name+"$"+i.$behaviorName,"teardown")}),super.destroy()}callSetup(e){return this.call(e,"setup")}callTeardown(e){return this.call(e,"teardown")}scriptListen(e,t){return this.scriptSubscribe(this.actor.id,e,t)}subscribe(e,t,s){return this.scriptSubscribe(e,t,s)}scriptSubscribe(e,t,s){if("function"==typeof s&&!this[isProxy])return super.subscribe(e,t,s);let i,r;"string"==typeof t?i=t:(i=t.event,r=t.handling);let a,o;t=(s="function"==typeof s?s.name:s).indexOf("$"),1<=t&&(o=s.slice(0,t),s=s.slice(t+1)),t=s.indexOf("."),1<=t&&(a=s.slice(0,t),s=s.slice(t+1)),t=this._behavior;!o&&t&&(o=t.module.externalName),!a&&t&&(a=t.$behaviorName);let n;n=a?""+o+(o?"$":"")+a+(a?".":"")+s:s;t=e+":"+i+n;if(this.scriptListeners&&this.scriptListeners.get(t)&&this.unsubscribe(e,i,n),this.scriptListeners&&this.scriptListeners.set(t,n),1<=n.indexOf(".")){let t=n.split(".");return super.subscribe(e,i,e=>this.call(t[0],t[1],e))}r?super.subscribe(e,{event:i,handling:r},n):super.subscribe(e,i,n)}update(t,s){super.update(t,s),this.updateRequests&&this.updateRequests.forEach(e=>{this.call(...e,t,s)})}addUpdateRequest(t){this.updateRequests||(this.updateRequests=[]),0<=this.updateRequests.findIndex(e=>e[0]===t[0]&&e[1]===t[1])||this.updateRequests.push(t)}removeUpdateRequest(t){var e=this.updateRequests.findIndex(e=>e[0]===t[0]&&e[1]===t[1]);e<0||this.updateRequests.splice(e,1)}};class ScriptingBehavior extends Model{static okayToIgnore(){return["$behavior","$behaviorName"]}init(e){this.systemBehavior=!!e.systemBehavior,this.module=e.module,this.name=e.name,this.type=e.type}setCode(string){if(string){let theSame=this.code===string,trimmed=(this.code=string,string.trim()),source;if(0!==trimmed.length){/^class[ \t]/.test(trimmed)&&(source=trimmed);let code=`return (${source})`,cls;try{const Microverse={..._croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__,..._ThreeRender_js__WEBPACK_IMPORTED_MODULE_1__,..._physics_js__WEBPACK_IMPORTED_MODULE_2__};cls=new Function("Worldcore","Microverse",code)(Microverse,Microverse)}catch(error){console.log("error occured while compiling:",source,error),eval(source)}"function"==typeof cls&&(this.$behavior=cls.prototype,this.$behaviorName=cls.name,theSame||this.publish(this.id,"setCode",string))}}else console.log("code is empty for ",this)}ensureBehavior(){var e;return this.$behavior||(e=this.code,this.setCode(e,!0)),this.$behavior}invoke(t,s,...i){this.ensureBehavior();var e=this.$behavior,r=this.$behaviorName;let a;t=newProxy(t,e,this.module,this);try{let e=t[s];if(!e)throw new Error(`a method named ${s} not found in `+(r||this));a=e.apply(t,i)}catch(e){console.error("an error occured in",r,s,e)}return a}}ScriptingBehavior.register("ScriptingBehavior");class ScriptingModule extends Model{init(e){super.init(e),this.name=e.name,this.systemModule=e.systemModule,this.location=e.location}}ScriptingModule.register("ScriptingModule");class BehaviorModelManager extends ModelService{init(e){super.init(e||"BehaviorModelManager"),this.moduleDefs=new Map,this.modules=new Map,this.behaviors=new Map,this.modelUses=new Map,this.viewUses=new Map,this.externalNames=new Map,this.loadCache=null,this.subscribe(this.id,"loadStart","loadStart"),this.subscribe(this.id,"loadOne","loadOne"),this.subscribe(this.id,"loadDone","loadDone")}createAvailableName(e,t){var s,i,r=this.moduleDefs.get(e);if(!r)return e;for([s,i]of this.moduleDefs)if(i.location===t&&i.name===e)return s;if(r.location===t)return e;var r=/([^0-9]+)([0-9]*)/.exec(e),a=r[1];let o=r[2];for(o=0===o.length?0:parseInt(o,10);;){var n=a+ ++o;if(!this.moduleDefs.get(n))return n}}lookup(e,t){if(!e)return null;let s=this.modules.get(e);return s?s.actorBehaviors.get(t)||s.pawnBehaviors.get(t):null}loadStart(e){this.key=e,this.loadCache=[]}loadOne(e){this.key&&e.key===this.key&&this.loadCache.push(e.buf)}loadDone(e){this.key&&this.key===e&&(e=this.loadCache,this.loadCache=[],this.key=null,this.loadAll(e))}loadAll(i){if(i){var e=i.reduce((e,t)=>e+t.length,0);let t=new Uint8Array(e),s=0;for(let e=0;e<i.length;e++)t.set(i[e],s),s+=i[e].length;e=new TextDecoder("utf-8").decode(t),e=JSON.parse(e);this.loadLibraries(e),this.publish(this.sessionId,"triggerPersist")}else console.log("inconsistent message")}loadLibraries(e){let d=[],c=new Map,a;Constants.UserBehaviorDirectory&&(a=Constants.UserBehaviorDirectory.slice("behaviors/".length));let o,t=(Constants.SystemBehaviorDirectory&&(o=Constants.SystemBehaviorDirectory.slice("behaviors/".length)),e.forEach(n=>{let{action:e,name:t,systemModule:l,location:h}=n;if(h){var s=h.lastIndexOf("/");let e=h.slice(0,s);if(a&&!e.startsWith(a)&&!e.startsWith(o))return}s=t;if(!e||"add"===e){let e={...n},a=(delete e.action,Array.isArray(e.actorBehaviors)&&(e.actorBehaviors=new Map(e.actorBehaviors)),Array.isArray(e.pawnBehaviors)&&(e.pawnBehaviors=new Map(e.pawnBehaviors)),t=this.createAvailableName(s,h),c.set(s,t),this.externalNames.set(h+"$"+n.name,t),this.moduleDefs.set(t,e),{actorBehaviors:new Map,pawnBehaviors:new Map}),o=this.modules.get(t);(o=o||ScriptingModule.create({name:e.name,systemModule:e.systemModule,location:h})).externalName=t,["actorBehaviors","pawnBehaviors"].forEach(t=>{var s,i;if(n[t])for([s,i]of n[t]){var r=this.externalNames.get(h+"$"+n.name);let e=this.lookup(r,s);e?e.code!==i&&(e.setCode(i),d.push(e)):((e=ScriptingBehavior.create({systemBehavior:l,module:o,name:s,type:t.slice(0,t.length-1)})).setCode(i),d.push(e)),a[t].set(s,e)}}),o.actorBehaviors=a.actorBehaviors,o.pawnBehaviors=a.pawnBehaviors,this.modules.set(o.externalName,o)}if("remove"===e)for(var[i,r]of this.modules)r.location===h&&(this.externalNameMap.delete(h),this.modules.delete(i),this.moduleDefs.delete(i))}),[]);return d.forEach(s=>{if(s.$behavior.setup)if("actorBehavior"===s.type){let e=this.modelUses.get(s),t=this.service("ActorManager");e&&e.forEach(e=>{e=t.get(e);e&&s.future(0).invoke(e,"setup")})}else"pawnBehavior"===s.type&&t.push([s.module.externalName,s.$behaviorName])}),this.publish(this.id,"callViewSetupAll",t),c}save(t){let e=[...this.moduleDefs].filter(([,e])=>!e.systemModule);return t&&(e=(e=e.filter(([e])=>t.includes(e))).map(([e,t])=>{let s={...t};function randomString(){return Math.floor(Math.random()*36**10).toString(36)}return s.location&&(s.location=randomString()+"/"+randomString()),[e,s]})),new Map([...e])}modelUse(e,t){var s=e.id;let i=this.modelUses.get(t);i||(i=[],this.modelUses.set(t,i)),i.indexOf(s)<0&&(i.push(s),t.ensureBehavior(),t.$behavior.setup&&t.future(0).invoke(e[isProxy]?e._target:e,"setup"))}modelUnuse(e,t){var s=e.id;let i=this.modelUses.get(t);!i||(s=i.indexOf(s))<0||(i.splice(s,1),t.$behavior&&t.$behavior.teardown&&t.future(0).invoke(e[isProxy]?e._target:e,"teardown"))}viewUse(e,t){var s=e.id;let i=this.viewUses.get(t);i||(i=[],this.viewUses.set(t,i)),i.indexOf(s)<0&&i.push(s),t.ensureBehavior(),t.$behavior.setup&&e.say("callSetup",t.module.externalName+"$"+t.$behaviorName)}viewUnuse(e,t){var s=e.id;let i=this.viewUses.get(t);!i||(s=i.indexOf(s))<0||(i.splice(s,1),t.$behavior&&t.$behavior.teardown&&e.say("callTeardown",t.module.externalName+"$"+t.$behaviorName))}}BehaviorModelManager.register("BehaviorModelManager");class BehaviorViewManager extends ViewService{constructor(e){super(e||"BehaviorViewManager"),this.url=null,this.socket=null,(window.BehaviorViewManager=this).model=this.wellKnownModel("BehaviorModelManager"),this.subscribe(this.model.id,"callViewSetupAll","callViewSetupAll")}setURL(e){if(this.socket)try{this.socket.onmessage=null,this.socket.close()}finally{this.socket=null}e&&(this.url=e,this.socket=new WebSocket(e),this.socket.onmessage=e=>this.load(e.data))}callViewSetupAll(e){e.forEach(e=>{let t=this.model.lookup(...e),s=this.model.viewUses.get(t);s&&s.forEach(e=>{e=GetPawn(e);e&&t.invoke(e,"setup")})})}load(e){let i;try{i=JSON.parse(e)}catch(e){return void console.error(e)}if(i&&Array.isArray(i)){let t=new Map,y=[],s=[],g=[],v=(window._alLResolvers||(window._allResolvers=new Map),Date.now()+"_"+Math.random().toString()),a=new Map;window._allResolvers.set(v,a),i.forEach(r=>{if("add"===r.action){t.set(r.name,r.systemModule);let i=Math.random().toString();var e=new Promise((e,t)=>{a.set(i,e);let s=document.createElement("script");g.push(s),s.type="module";e=URL.createObjectURL(new Blob([r.content],{type:"application/javascript"}));s.innerHTML=`
import * as data from "${e}";
let map = window._allResolvers.get("${v}");
if (map) {map.get("${i}")({data, key: ${v}, name: "${r.name}"});}
`,document.body.appendChild(s),y.push(e)}).catch(e=>(console.log(e),null));s.push(e)}}),Promise.all(s).then(async r=>{if(y.forEach(e=>URL.revokeObjectURL(e)),g.forEach(e=>e.remove()),0!==(r=r.filter(e=>e)).length){let e=[...window._allResolvers.keys()];var a=e.indexOf(v);if(window._allResolvers.delete(v),a===e.length-1){let i=new CodeLibrary,e=(r.forEach(e=>{var t=e.name.lastIndexOf("."),t=e.name.slice(0,t),s=e.name.startsWith("croquet");i.add(e.data.default,t,s)}),[]);var o,n,l=Math.random();for([o,n]of i.modules){var{actorBehaviors:h,pawnBehaviors:d,name:c,location:u,systemModule:p}=n;e.push({name:c,systemModule:p,location:u,actorBehaviors:[...h],pawnBehaviors:[...d]})}a=JSON.stringify(e);let t=(new TextEncoder).encode(a),s=0;this.publish(this.model.id,"loadStart",l);for(var f=8e4<t.length;s<t.length;){var m=t.slice(s,s+2880);this.publish(this.model.id,"loadOne",{key:l,buf:m}),s+=2880,f&&await new Promise(e=>{setTimeout(e,5)})}this.publish(this.model.id,"loadDone",l)}}})}else console.log("not an array")}}class CodeLibrary{constructor(){this.modules=new Map,this.functions=new Map,this.classes=new Map}add(e,n,l){e.modules&&e.modules.forEach(e=>{let{name:t,actorBehaviors:s,pawnBehaviors:i}=e,r=new Map,a=new Map;s&&s.forEach(e=>{r.set(e.name,e.toString())}),i&&i.forEach(e=>{a.set(e.name,e.toString())});var e=n+"$"+t,o=this.modules.get(e);o&&console.log(`a module ${t} is defined in ${n} and `+o.location),this.modules.set(e,{name:t,location:n,actorBehaviors:r,pawnBehaviors:a,systemModule:l})}),e.functions&&e.functions.forEach(e=>{var t=e.name,e=`return ${e.toString()};`;this.functions.set(t,e)}),e.classes&&e.classes.forEach(e=>{var t=e.name;this.classes.set(t,e)})}addModules(e){if(e)for(var[t,s]of e)this.modules.set(t,s)}get(e){return this.modules.get(e)}delete(e){this.modules.delete(e)}}},3917:(e,t,s)=>{"use strict";s.d(t,{G8:()=>addShellListener,QI:()=>function frameName(){return`frame["${a}",${r}${i?",primary":""}]`},Rx:()=>sendToShell,bq:()=>function removeShellListener(e){n.delete(e)},lp:()=>i});let i;const r=new URL(window.location.href).searchParams.get("portal"),a=new URL(window.location.href).searchParams.get("world")||"default";const o="croquet:microverse:";function sendToShell(e,t){window.parent.postMessage({message:o+e,...t},"*")}const n=new Set;function addShellListener(e){n.add(e)}window.addEventListener("message",t=>{if(t.source===window.parent){const e=t.data["message"];if("string"==typeof e&&e.startsWith(o)){const s=e.slice(o.length);n.forEach(e=>e(s,t.data))}}}),n.add((e,t)=>{"frame-type"===e&&(e=t["frameType"],t="primary"===e,i!==t&&(i=t,document.body.style.background="transparent",document.getElementById("hud").classList.toggle("primary-frame",i),i&&window.focus(),sendToShell("frame-ready",{frameType:e})))})},7112:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{"use strict";__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{startMicroverse:()=>startMicroverse});var _croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(4200),_ThreeRender_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(5679),_physics_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(6590),_text_text_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(4355),_card_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(3654),_avatar_js__WEBPACK_IMPORTED_MODULE_5__=__webpack_require__(6830),_frame_js__WEBPACK_IMPORTED_MODULE_6__=__webpack_require__(3917),_code_js__WEBPACK_IMPORTED_MODULE_7__=__webpack_require__(6946),_portal_js__WEBPACK_IMPORTED_MODULE_8__=__webpack_require__(1246),_worldSaver_js__WEBPACK_IMPORTED_MODULE_9__=__webpack_require__(4072),_apps_multiblaster_js__WEBPACK_IMPORTED_MODULE_10__=__webpack_require__(3128),jszip__WEBPACK_IMPORTED_MODULE_11__=__webpack_require__(5733),jszip__WEBPACK_IMPORTED_MODULE_11___default=__webpack_require__.n(jszip__WEBPACK_IMPORTED_MODULE_11__),fflate__WEBPACK_IMPORTED_MODULE_13__=__webpack_require__(3778),_wcAssetManager_js__WEBPACK_IMPORTED_MODULE_12__=__webpack_require__(9087);const defaultAvatarNames=["newwhite","madhatter","marchhare","queenofhearts","cheshirecat","alice"],defaultSystemBehaviorDirectory="behaviors/croquet",defaultSystemBehaviorModules=["avatarEvents.js","billboard.js","elected.js","menu.js","pdfview.js","propertySheet.js","rapier.js","scrollableArea.js","singleUser.js","stickyNote.js"];let AA=!0;const isSafari=-1!=navigator.userAgent.indexOf("Safari")&&-1==navigator.userAgent.indexOf("Chrome"),isFirefox=(isSafari&&(AA=!1),navigator.userAgent.includes("Firefox")),isMobile=(isFirefox&&(AA=!1),!!("ontouchstart"in window));function loadLoaders(){return window.JSZip=jszip__WEBPACK_IMPORTED_MODULE_11___default(),window.fflate=fflate__WEBPACK_IMPORTED_MODULE_13__,window.THREE=_ThreeRender_js__WEBPACK_IMPORTED_MODULE_1__.THREE,Promise.resolve(_ThreeRender_js__WEBPACK_IMPORTED_MODULE_1__.THREE)}function basenames(){let e=window.location.pathname;var t=/([^/]+)\.html$/.exec(e);let s=new URL(window.location).searchParams.get("world");s=s||(t&&"index"!==t[1]?t[1]:"default");let i;return{basedir:i=t?e.slice(0,t.index):(t=e.lastIndexOf("/"),e.slice(0,t+1)),basename:s}}function loadInitialBehaviors(paths,directory){let library=_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.Library||new _code_js__WEBPACK_IMPORTED_MODULE_7__.Un;if(_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.Library=library,paths&&directory){let{basedir,_pathname}=basenames();if(!directory)throw new Error("directory argument has to be specified. It is a name for a sub directory name under the ./behaviors directory.");let isSystem=directory===_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.SystemBehaviorDirectory,promises=paths.map(path=>{if(isSystem){let modulePath=directory.split("/")[1]+"/"+path,code=`import('${basedir}behaviors/${modulePath}')`;return eval(code).then(e=>[modulePath,e])}{let code=`import('${basedir}${directory}/${path}')`;return eval(code).then(e=>{let t=directory.slice("behaviors".length);return[(""===(t="/"===t[0]?t.slice(1):t)?"":t+"/")+path,e]})}});return Promise.all(promises).then(e=>(e.forEach(e=>{let[t,s]=e;e=t.lastIndexOf("."),e=t.slice(0,e);library.add(s.default,e,isSystem)}),!0))}}isMobile&&(AA=!1),console.log("antialias is: ",AA,"mobile:",isMobile,"browser:",isFirefox?"Firefox":isSafari?"Safari":"Other Browser"),console.log("%cTHREE.REVISION:","color: #f00",_ThreeRender_js__WEBPACK_IMPORTED_MODULE_1__.THREE.REVISION);class MyPlayerManager extends _croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.PlayerManager{init(e){super.init(e),this.avatarCount=0,this.presentationMode=null,this.followers=new Set,this.subscribe("playerManager","create",this.playerCreated),this.subscribe("playerManager","destroy",this.playerDestroyed),this.subscribe("playerManager","enter",this.playerEnteredWorld),this.subscribe("playerManager","leave",this.playerLeftWorld)}get presenter(){return this.players.get(this.presentationMode)}createPlayer(e){var t=this.avatarCount%_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.AvatarNames.length,t=(this.avatarCount++,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.AvatarNames[t]);console.log((0,_frame_js__WEBPACK_IMPORTED_MODULE_6__.QI)(),"MyPlayerManager",this.avatarCount);let s={...e},i=(s.noSave=!0,s.type="3d",s.singleSided=!0,"string"==typeof t?(s.name=t,s.dataScale=[.3,.3,.3],s.dataRotation=(0,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.q_euler)(0,Math.PI,0),s.dataTranslation=[0,-.4,0],s.dataLocation=`./assets/avatars/${s.name}.zip`):s={...s,...t},this.service("BehaviorModelManager"));return i&&i.modules.get("AvatarEventHandler")&&(s.behaviorModules?s.behaviorModules=[...s.behaviorModules,"AvatarEventHandler"]:s.behaviorModules=["AvatarEventHandler"]),_avatar_js__WEBPACK_IMPORTED_MODULE_5__.b.create(s)}destroyPlayer(e){e.inWorld&&e.set({inWorld:!1}),super.destroyPlayer(e)}playerInWorldChanged(e){e.inWorld?this.publish("playerManager","enter",e):this.publish("playerManager","leave",e)}playersInWorld(){return[...this.players.values()].filter(e=>e.inWorld)}startPresentation(e,t=null){if(!this.presentationMode||this.presentationMode===e){this.presentationMode=e;for(const s of this.playersInWorld())t&&s.presenterToken!==t||(t&&s.playerId===e||delete s.presenterToken,this.followers.add(s.playerId));this.publish("playerManager","presentationStarted"),this.publish("playerManager","playerCountChanged")}}addFollower(e){this.followers.add(e)}stopPresentation(){this.presentationMode=null,this.publish("playerManager","presentationStopped"),this.publish("playerManager","playerCountChanged"),this.followers.clear()}leavePresentation(e){this.presentationMode!==e&&(this.followers.delete(e),this.publish("playerManager","playerCountChanged"))}continuePresenting(e,t){this.presentationMode?console.log((0,_frame_js__WEBPACK_IMPORTED_MODULE_6__.QI)(),"continuePresenting rejected due to presentation in progress"):(console.log((0,_frame_js__WEBPACK_IMPORTED_MODULE_6__.QI)(),"continuePresenting",e.id,t),e.presenterToken=t,this.startPresentation(e.playerId,t))}continueFollowing(e,t){this.presentationMode&&this.presenter.presenterToken===t?(console.log((0,_frame_js__WEBPACK_IMPORTED_MODULE_6__.QI)(),"continueFollowing",this.presenter.id,t),this.followers.add(e.playerId),e.presentationStarted(),this.publish("playerManager","playerCountChanged")):(e.presenterToken=t,console.log((0,_frame_js__WEBPACK_IMPORTED_MODULE_6__.QI)(),"continueFollowing: expected presenter not presenting",t))}playerEnteredWorld(e){console.log((0,_frame_js__WEBPACK_IMPORTED_MODULE_6__.QI)(),"playerEnteredWorld",e),this.publish("playerManager","playerCountChanged")}playerLeftWorld(e){console.log((0,_frame_js__WEBPACK_IMPORTED_MODULE_6__.QI)(),"playerLeftWorld",e),e.playerId===this.presentationMode&&this.stopPresentation(),delete e.presenterToken,this.followers.delete(e.playerId),this.publish("playerManager","playerCountChanged")}playerCreated(e){this.publish("playerManager","playerCountChanged")}playerDestroyed(e){this.publish("playerManager","playerCountChanged")}}MyPlayerManager.register("MyPlayerManager");class MyModelRoot extends _croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.ModelRoot{static modelServices(){return[MyPlayerManager,_card_js__WEBPACK_IMPORTED_MODULE_4__.q7,_code_js__WEBPACK_IMPORTED_MODULE_7__.IL,_text_text_js__WEBPACK_IMPORTED_MODULE_3__.NC,..._croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.UseRapier?[{service:_physics_js__WEBPACK_IMPORTED_MODULE_2__.RapierPhysicsManager,options:{useCollisionEventQueue:!0}}]:[]]}init(e,t){super.init(e);let s=this.service("MicroverseAppManager");if(s.add(_apps_multiblaster_js__WEBPACK_IMPORTED_MODULE_10__.q),s.add(_text_text_js__WEBPACK_IMPORTED_MODULE_3__.T0),s.add(_portal_js__WEBPACK_IMPORTED_MODULE_8__.Q),this.ensurePersistenceProps(),this.subscribe(this.sessionId,"triggerPersist","triggerPersist"),this.subscribe(this.id,"loadStart","loadStart"),this.subscribe(this.id,"loadOne","loadOne"),this.subscribe(this.id,"loadDone","loadDone"),t)return console.log("loading persistent data"),void this.loadPersistentData(t);this.loadBehaviorModules(_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.Library.modules,"1"),this.load(_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.DefaultCards,"1")}ensurePersistenceProps(){this.persistPeriod||(this.persistPeriod=6e4),void 0===this.lastPersistTime&&(this.lastPersistTime=0),void 0===this.persistRequested&&(this.persistRequested=!1)}loadPersistentData({version:s,data:i}){try{delete this.loadingPersistentDataErrored,this.loadingPersistentData=!0;let e=new _worldSaver_js__WEBPACK_IMPORTED_MODULE_9__.H(_card_js__WEBPACK_IMPORTED_MODULE_4__.Z4);var r,a,o=e.parse(JSON.stringify(i)),n=_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.Library;let t=new Map;for([r,a]of n.modules)a.systemModule&&t.set(r,a);this.loadBehaviorModules(t,s),this.loadBehaviorModules(o.behaviorModules,s),o.cards&&this.load(o.cards,s)}catch(e){console.error("error in loading persistent data",e),this.loadingPersistentDataErrored=!0}finally{delete this.loadingPersistentData}}savePersistentData(){this.loadingPersistentData||this.loadingPersistentDataErrored||(this.lastPersistTime=this.now(),this.persistSession(()=>this.saveData()))}saveData(){var e=this.sessionName||"Unknown";let t=new _worldSaver_js__WEBPACK_IMPORTED_MODULE_9__.H(_card_js__WEBPACK_IMPORTED_MODULE_4__.Z4);var s=t.save(this),s=t.stringify(s);return{name:e,version:"1",data:JSON.parse(s)}}loadBehaviorModules(t,e){if("1"!==e)return null;{let e=this.service("BehaviorModelManager");return e.loadLibraries([...t.values()])}}load(e,t){if("1"===t)return _card_js__WEBPACK_IMPORTED_MODULE_4__.Z4.load(e,this,t)}triggerPersist(){var e=this.now(),t=e-this.lastPersistTime,s=this.persistPeriod;t<s?this.persistRequested||(this.persistRequested=!0,this.future(s-t).triggerPersist()):(this.lastPersistTime=e,this.persistRequested=!1,this.savePersistentData())}loadStart(e){this.loadKey=e,this.loadBuffer=[]}loadOne(e){var{key:e,buf:t}=e;e===this.loadKey&&this.loadBuffer.push(t)}loadDone(r){var{key:r,asScene:a,pose:o}=r;if(r===this.loadKey){let i=this.loadBuffer;if(this.loadBuffer=[],this.loadKey=null,i){r=i.reduce((e,t)=>e+t.length,0);let t=new Uint8Array(r),s=0;for(let e=0;e<i.length;e++)t.set(i[e],s),s+=i[e].length;r=new TextDecoder("utf-8").decode(t);let e=JSON.parse(r);"1"===e.version&&(r=JSON.stringify(e.data),e.data=r,this.loadFromFile(e,a,o))}else console.log("inconsistent message")}}loadFromFile({version:t,data:s},i,r){try{let e=new _worldSaver_js__WEBPACK_IMPORTED_MODULE_9__.H(_card_js__WEBPACK_IMPORTED_MODULE_4__.Z4);var a=e.parse(s),o=this.loadBehaviorModules(a.behaviorModules,t);if(a.cards){let e=this.load({array:a.cards,nameMap:i?null:o},t);r&&e.forEach(e=>{e.parent||(e._translation=r.translation,e._rotation=r.rotation)})}}catch(e){console.error("error in loading persistent data",e)}}}MyModelRoot.register("MyModelRoot");class MyViewRoot extends _croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.ViewRoot{static viewServices(){return[_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.InputManager,{service:_ThreeRender_js__WEBPACK_IMPORTED_MODULE_1__.ThreeRenderManager,options:{useBVH:!0,antialias:AA}},_wcAssetManager_js__WEBPACK_IMPORTED_MODULE_12__.m,_text_text_js__WEBPACK_IMPORTED_MODULE_3__.WK,_text_text_js__WEBPACK_IMPORTED_MODULE_3__.Ax,_text_text_js__WEBPACK_IMPORTED_MODULE_3__.N2,_card_js__WEBPACK_IMPORTED_MODULE_4__.X7,_code_js__WEBPACK_IMPORTED_MODULE_7__.ui]}constructor(e){super(e);var t=this.service("ThreeRenderManager");const s=t.renderer;window.scene=t.scene,this.service("FontViewManager").setModel(e.service("FontModelManager")),s.toneMapping=_ThreeRender_js__WEBPACK_IMPORTED_MODULE_1__.THREE.ReinhardToneMapping,s.toneMappingExposure=2.5,s.shadowMap.enabled=!0,s.localClippingEnabled=!0}}function deleteParameter(e,t){const s=new URL(e,location.href);return s.searchParams.delete(t),s.toString()}function startWorld(e,t){let s={name:e.name||_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.App.autoSession(),password:e.password||_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.App.autoPassword(),model:MyModelRoot,view:MyViewRoot,tps:30,eventRateLimit:60,options:{world:t},...e,flags:["microverse"]};_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.App.sessionURL=deleteParameter(_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.App.sessionURL,"portal"),loadLoaders().then(()=>loadInitialBehaviors(_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.SystemBehaviorModules,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.SystemBehaviorDirectory)).then(()=>loadInitialBehaviors(_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.UserBehaviorModules,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.UserBehaviorDirectory)).then(()=>(0,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.StartWorldcore)(s)).then(()=>{var e=basenames()["basedir"];return fetch(e+"meta/version.txt")}).then(e=>(""+e.status).startsWith("2")?e.text():"(version not found)").then(e=>{console.log(`
Croquet Microverse
${e}
https://croquet.io`.trim())})}async function startMicroverse(){let{basedir,basename}=basenames();if(basename.endsWith(".vrse")){const response=await fetch(basename);if(!response.ok)throw Error("world not found: "+basename);const text=await response.text(),json=(new _worldSaver_js__WEBPACK_IMPORTED_MODULE_9__.H).parse(text);_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.AvatarNames=defaultAvatarNames,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.SystemBehaviorDirectory=defaultSystemBehaviorDirectory,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.SystemBehaviorModules=defaultSystemBehaviorModules,json.data.useRapier&&(_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.UseRapier=json.data.useRapier),_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.BehaviorModules=json.data.behaviormodules,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.DefaultCards=json.data.cards,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.Library=new _code_js__WEBPACK_IMPORTED_MODULE_7__.Un,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.Library.addModules(json.data.behaviorModules)}else{const worldModule=await eval(`import("${basedir}worlds/${basename}.js")`);_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.ModelRoot.evaluate(()=>worldModule.init(_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants)),_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.SystemBehaviorModules||(_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.SystemBehaviorDirectory=defaultSystemBehaviorDirectory,_croquet_worldcore_kernel__WEBPACK_IMPORTED_MODULE_0__.Constants.SystemBehaviorModules=defaultSystemBehaviorModules)}let apiKeysModule;try{apiKeysModule=await eval(`import('${basedir}apiKey.js')`);const{apiKey,appId}=apiKeysModule.default;if("string"!=typeof apiKey)throw Error("apiKey.js: apiKey must be a string");if("string"!=typeof appId)throw Error("apiKey.js: appId must be a string");if(!apiKey.match(/^[_a-z0-9]+$/i))throw Error(`invalid apiKey: "${apiKey}"`);if(!appId.match(/^[-_.a-z0-9]+$/i))throw Error(`invalid appId: "${appId}"`)}catch(error){if("TypeError"!==error.name)throw console.log(error),Error("Please make sure that you have created a valid apiKey.js (see croquet.io/keys)");console.warn("apiKey.js not found, using default key for local development. Please create a valid apiKey.js (see croquet.io/keys)"),apiKeysModule={default:{apiKey:"1kBmNnh69v93i5tOpj7bqqaJxjD3HJEucxd7egi7H",appId:"io.croquet.microverse.localdevdefault"}}}startWorld(apiKeysModule.default,basename)}},6590:(e,t,s)=>{"use strict";s.r(t),s.d(t,{RAPIER:()=>i,RapierPhysicsManager:()=>RapierPhysicsManager,RapierVersion:()=>function RapierVersion(){return i.version()}});t=s(4200);let i;class RapierPhysicsManager extends t.ModelService{static async asyncStart(){console.log("Starting Rapier physics!"),i=window.RAPIERModule||await s.e(87).then(s.bind(s,5087))}static types(){return i?{"RAPIER.World":{cls:i.World,write:e=>e.takeSnapshot(),read:e=>i.World.restoreSnapshot(e)},"RAPIER.EventQueue":{cls:i.EventQueue,write:e=>{},read:e=>new i.EventQueue(!0)}}:{}}init(e={}){super.init("RapierPhysicsManager"),e.useCollisionEventQueue&&(this.queue=new i.EventQueue(!0));var t=e.gravity||[0,-9.8,0],e=e.timeStep||50,t=new i.Vector3(...t);this.world=new i.World(t),this.timeStep=e,this.world.timestep=this.timeStep/1e3,this.rigidBodies=[],this.future(0).tick()}destroy(){super.destroy(),this.world.free(),this.world=null}pause(){this.isPaused=!0}resume(){this.isPaused=!1}tick(){this.isPaused||(this.world.step(this.queue),this.world.forEachActiveRigidBodyHandle(e=>{const t=this.rigidBodies[e];var e=t.rigidBody.translation(),s=t.rigidBody.rotation(),e=[e.x,e.y,e.z],s=[s.x,s.y,s.z,s.w];t.moveTo(e),t.say("translating",e),t.rotateTo(s)}),this.queue&&(this.contactEventHandler&&this.queue.drainContactEvents((e,t,s)=>{e=this.rigidBodies[e],t=this.rigidBodies[t];this.contactEventHandler.contactEvent(e,t,s)}),this.intersectionEventHandler&&this.queue.drainIntersectionEvents((e,t,s)=>{e=this.rigidBodies[e],t=this.rigidBodies[t];this.intersectionEventHandler.intersectionEvent(e,t,s)}))),this.future(this.timeStep).tick()}registerContactEventHandler(e){this.contactEventHandler=e}registerIntersectionEventHandler(e){this.intersectionEventHandler=e}}RapierPhysicsManager.register("RapierPhysicsManager")},1246:(e,t,s)=>{"use strict";s.d(t,{Q:()=>PortalActor});s(4200);var h=s(5679),t=s(3654),i=s(3917);class PortalActor extends t.Z4{init(e){super.init(e),this._isOpen=!0,this.addLayer("portal"),this._portalTime=this.now(),this.listen("isOpenSet",this.setIsOpen)}get isPortal(){return!0}get isOpen(){return this._isOpen}get portalTime(){return this._portalTime}get portalURL(){return this._cardData.portalURL}get sparkle(){return this._cardData.sparkle}get pawn(){return PortalPawn}setIsOpen(){this.isOpen?this.addLayer("portal"):this.removeLayer("portal")}}PortalActor.register("PortalActor");class PortalPawn extends t.Df{constructor(e){super(e),this.createPortalMaterials(),this.portalId=void 0,this.targetMatrix=new h.THREE.Matrix4,this.targetMatrixBefore=new h.THREE.Matrix4,this.actor.isOpen&&this.openPortal(),this.setGhostWorld({v:this.actor._ghostWorld}),this.listen("ghostWorldSet",this.setGhostWorld),this.listen("isOpenSet",this.setIsOpen),this.addEventListener("pointerDown",this.onPointerDown),this.addEventListener("keyDown",e=>{switch(e.key){case" ":this.enterPortal();break;case"G":case"g":this.say("_set",{ghostWorld:null===this.actor._ghostWorld?20:null})}}),this.shellListener=(e,t)=>this.receiveFromShell(e,t),(0,i.G8)(this.shellListener),this.subscribe("avatar",{event:"gatherPortalSpecs",handling:"immediate"},this.updatePortal)}destroy(){this.closePortal(),(0,i.bq)(this.shellListener),super.destroy()}get globalPlane(){return this._globalPlane||(this._globalPlane=new h.THREE.Plane,this._globalPlane.normal.set(0,0,1),this._globalPlane.applyMatrix4(this.shape.matrixWorld)),this._globalPlane}objectCreated(e,t){super.objectCreated(e,t),this.applyPortalMaterial(e),this.actor.sparkle&&this.addParticles()}createPortalMaterials(){this.portalMaterial=new h.THREE.ShaderMaterial({uniforms:{time:{value:0}},vertexShader:`
                #include <clipping_planes_pars_vertex>
                varying vec3 vUv;
                void main() {
                    #include <begin_vertex>             // transformed = position
                    #include <project_vertex>           // mvPosition and gl_Position
                    #include <clipping_planes_vertex>   // vClipPosition
                    vUv = transformed;
                }
            `,fragmentShader:`
                uniform float time;
                varying vec3 vUv;
                #include <clipping_planes_pars_fragment>
                void main() {
                    #include <clipping_planes_fragment>
                    float r = length(vUv.xy);
                    float angle = atan(vUv.y, vUv.x);
                    float v = sin(time * 30.0 - r * 1.0 + 5.0 * angle) + r - time * 2.0 + 2.0;
                    float alpha = clamp(v, 0.0, 1.0);
                    // gl_FragColor = vec4(0, 0, 0, alpha); // if we only care about alpha
                    gl_FragColor = vec4(alpha*0.3, alpha*0.3, alpha*0.3, alpha); // add some grey
                }
            `,clipping:!0})}applyPortalMaterial(e){var t;(e=(e=e||this.shape).material?e:e.children[0])&&(t=this.actor["isOpen"],Array.isArray(e.material)?(e.material[0]!==this.portalMaterial&&(this.originalMaterial=e.material[0]),e.material[0]=t?this.portalMaterial:this.originalMaterial):(e.material!==this.portalMaterial&&(this.originalMaterial=e.material),e.material=t?this.portalMaterial:this.originalMaterial))}addParticles(){if(!this.particleSystem){var t=.5*this.actor._cardData.width+.002,s=.5*this.actor._cardData.height+.002,e={pointTexture:{value:(new h.THREE.TextureLoader).load("./assets/images/spark.png")}},e=new h.THREE.ShaderMaterial({uniforms:e,vertexShader:`
                attribute float size;
                #include <clipping_planes_pars_vertex>
                void main() {
                    #include <begin_vertex>
                    #include <project_vertex>
                    mvPosition += vec4( 0.0, 0.0, 0.1, 0.0 ); // offset towards camera to avoid z clipping
                    #include <clipping_planes_vertex>
                    gl_PointSize = size * ( 20.0 / -mvPosition.z );
                }
            `,fragmentShader:`
                uniform sampler2D pointTexture;
                #include <clipping_planes_pars_fragment>
                void main() {
                    #include <clipping_planes_fragment>
                    gl_FragColor = texture2D( pointTexture, gl_PointCoord );
                }
            `,clipping:!0,blending:h.THREE.AdditiveBlending,depthWrite:!1,transparent:!0,vertexColors:!0});const o=[],n=[];for(let e=0;e<1e3;e++){var i=2*Math.random()-1,r=Math.random()<.5?1:-1,a=Math.random()<.5;o.push((a?i:r)*t),o.push((a?r:i)*s),o.push(0),n.push(20)}const l=new h.THREE.BufferGeometry;l.setAttribute("position",new h.THREE.Float32BufferAttribute(o,3)),l.setAttribute("size",new h.THREE.Float32BufferAttribute(n,1).setUsage(h.THREE.DynamicDrawUsage)),this.particleSystem=new h.THREE.Points(l,e),this.shape.add(this.particleSystem)}}removeParticles(){this.particleSystem&&(this.shape.remove(this.particleSystem),this.particleSystem=void 0)}get hitNormal(){return[0,0,-1]}update(e){super.update(e),this.updatePortalMaterial(),this.updateParticles()}updatePortal({callback:e,force:t}){this.updatePortalCamera(e,t)}updatePortalCamera(e,t){if(this.portalId){const{targetMatrix:s,targetMatrixBefore:i,portalId:r}=this,a=this.service("ThreeRenderManager")["camera"];if(a.updateMatrixWorld(!0),this.renderObject.updateMatrixWorld(!0),s.copy(this.renderObject.matrixWorld),s.invert(),s.multiply(a.matrixWorld),t||!i.equals(s)){const o=new h.THREE.Frustum;t=(new h.THREE.Matrix4).multiplyMatrices(a.projectionMatrix,a.matrixWorldInverse),t=(o.setFromProjectionMatrix(t),o.intersectsObject(this.renderObject.children[0])?s.elements:null);e({portalId:r,cameraMatrix:t}),i.copy(s)}}}updatePortalMaterial(){var e=this.actor["portalTime"],e=(this.extrapolatedNow()-e)/1e3;this.portalMaterial.uniforms.time.value=e}updateParticles(){if(this.actor.sparkle&&!this.particleSystem?this.addParticles():!this.actor.sparkle&&this.particleSystem&&this.removeParticles(),this.particleSystem){const e=this.particleSystem["geometry"],s=e.attributes.size.array;var t=Date.now()/100;for(let e=0;e<s.length;e++)s[e]=10*(1+Math.sin(.1*e+t));e.attributes.size.needsUpdate=!0}}updateShape(e){this.removeParticles(),super.updateShape(e),this.updateParticles()}cardDataUpdated(e){super.cardDataUpdated(e),this.didPropertyChange(e,"sparkle")&&this.updateParticles()}refreshDrawTransform(){super.refreshDrawTransform(),this._globalPlane=null}onPointerDown(){this.say("_set",{isOpen:!this.actor.isOpen,portalTime:this.now()})}openPortal(){var e=this.resolvePortalURL();(0,i.Rx)("portal-open",{portalURL:e,portalId:this.portalId})}closePortal(){(0,i.Rx)("portal-close",{portalId:this.portalId}),this.portalId=null,this.targetMatrixBefore.identity()}resolvePortalURL(){let e=this.actor.portalURL;const t=new URL(e,location.href),s=t.searchParams,i=new URLSearchParams(t.hash.slice(1));let r=s.get("q"),a=i.get("pw");if(!r||!a){const o=new URL(location.href);if(r||(r=o.searchParams.get("q"),a="",s.set("q",r)),!a){const n=new URLSearchParams(o.hash.slice(1));a=n.get("pw"),i.set("pw",a),t.hash=i.toString()}}return e=t.toString(),t.origin===location.origin&&(e=e.slice(location.origin.length),t.pathname===location.pathname&&(e=e.slice(location.pathname.length))),this.actor.portalURL!==e&&this.say("setCardData",{portalURL:e}),t.toString()}setIsOpen({v:e}){this.applyPortalMaterial(),e?this.openPortal():this.closePortal()}setGhostWorld({v:e}){let t=document.getElementById("ThreeCanvas"),s=document.getElementById("ghostSlider");"number"==typeof e&&i.lp?(s.style.display="block",s.oninput=()=>this.say("_set",{ghostWorld:+s.value}),t.style.filter=`opacity(${100-e}%) saturate(${100-e}%) contrast(${80+.2*e}%) blur(4px)`,s.value=e):(s.style.display="none",t.style.filter="")}receiveFromShell(e,{portalId:t}){switch(e){case"portal-opened":this.portalId=t;break;case"frame-type":this.setGhostWorld({v:this.actor._ghostWorld})}}}},4355:(u,e,t)=>{"use strict";t.d(e,{NC:()=>FontModelManager,Ax:()=>FontViewManager,WK:()=>KeyFocusManager,N2:()=>SyncedStateManager,T0:()=>TextFieldActor});var e=t(4200),g=t(5679),c=t(7194),s=t(3654),i=t(9902),r=t.n(i),i=JSON.parse('{"pages":["Roboto-msdf.png"],"chars":[{"id":41,"width":22,"height":53,"xoffset":0,"yoffset":-33.6943359375,"xadvance":14.6015625,"chnl":15,"x":0,"y":0,"page":0},{"id":40,"width":24,"height":53,"xoffset":0,"yoffset":-33.6943359375,"xadvance":14.35546875,"chnl":15,"x":0,"y":55,"page":0},{"id":93,"width":18,"height":51,"xoffset":0,"yoffset":-34.125,"xadvance":11.1357421875,"chnl":15,"x":0,"y":110,"page":0},{"id":91,"width":21,"height":51,"xoffset":0,"yoffset":-34.125,"xadvance":11.1357421875,"chnl":15,"x":0,"y":163,"page":0},{"id":125,"width":23,"height":50,"xoffset":0,"yoffset":-32.7509765625,"xadvance":14.2119140625,"chnl":15,"x":0,"y":216,"page":0},{"id":123,"width":24,"height":50,"xoffset":0,"yoffset":-32.7509765625,"xadvance":14.2119140625,"chnl":15,"x":0,"y":268,"page":0},{"id":106,"width":18,"height":49,"xoffset":0,"yoffset":-30.26953125,"xadvance":10.0283203125,"chnl":15,"x":0,"y":320,"page":0},{"id":36,"width":31,"height":49,"xoffset":0,"yoffset":-34.69921875,"xadvance":23.583984375,"chnl":15,"x":0,"y":371,"page":0},{"id":64,"width":46,"height":49,"xoffset":0,"yoffset":-29.3466796875,"xadvance":37.7138671875,"chnl":15,"x":0,"y":422,"page":0},{"id":87,"width":46,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":37.2626953125,"chnl":15,"x":48,"y":422,"page":0},{"id":124,"width":17,"height":45,"xoffset":0,"yoffset":-29.859375,"xadvance":10.2333984375,"chnl":15,"x":33,"y":371,"page":0},{"id":81,"width":36,"height":45,"xoffset":0,"yoffset":-30.26953125,"xadvance":28.875,"chnl":15,"x":52,"y":371,"page":0},{"id":109,"width":44,"height":33,"xoffset":0,"yoffset":-22.599609375,"xadvance":36.8115234375,"chnl":15,"x":0,"y":473,"page":0},{"id":77,"width":43,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":36.66796875,"chnl":15,"x":96,"y":422,"page":0},{"id":39,"width":15,"height":42,"xoffset":0,"yoffset":-31.5,"xadvance":7.3212890625,"chnl":15,"x":90,"y":371,"page":0},{"id":34,"width":21,"height":42,"xoffset":0,"yoffset":-31.5,"xadvance":13.4326171875,"chnl":15,"x":107,"y":371,"page":0},{"id":92,"width":27,"height":42,"xoffset":0,"yoffset":-29.859375,"xadvance":17.2265625,"chnl":15,"x":130,"y":371,"page":0},{"id":104,"width":30,"height":42,"xoffset":0,"yoffset":-31.5,"xadvance":23.1328125,"chnl":15,"x":159,"y":371,"page":0},{"id":47,"width":26,"height":42,"xoffset":0,"yoffset":-29.859375,"xadvance":17.30859375,"chnl":15,"x":191,"y":371,"page":0},{"id":108,"width":17,"height":42,"xoffset":0,"yoffset":-31.5,"xadvance":10.1923828125,"chnl":15,"x":219,"y":371,"page":0},{"id":98,"width":32,"height":42,"xoffset":0,"yoffset":-31.5,"xadvance":23.5634765625,"chnl":15,"x":238,"y":371,"page":0},{"id":107,"width":31,"height":42,"xoffset":0,"yoffset":-31.5,"xadvance":21.287109375,"chnl":15,"x":272,"y":371,"page":0},{"id":100,"width":31,"height":42,"xoffset":0,"yoffset":-31.5,"xadvance":23.6865234375,"chnl":15,"x":305,"y":371,"page":0},{"id":102,"width":25,"height":42,"xoffset":0,"yoffset":-31.9306640625,"xadvance":14.5810546875,"chnl":15,"x":338,"y":371,"page":0},{"id":48,"width":31,"height":41,"xoffset":0,"yoffset":-30.26953125,"xadvance":23.583984375,"chnl":15,"x":365,"y":371,"page":0},{"id":51,"width":31,"height":41,"xoffset":0,"yoffset":-30.26953125,"xadvance":23.583984375,"chnl":15,"x":398,"y":371,"page":0},{"id":83,"width":33,"height":41,"xoffset":0,"yoffset":-30.26953125,"xadvance":24.9169921875,"chnl":15,"x":431,"y":371,"page":0},{"id":56,"width":31,"height":41,"xoffset":0,"yoffset":-30.26953125,"xadvance":23.583984375,"chnl":15,"x":466,"y":371,"page":0},{"id":119,"width":41,"height":32,"xoffset":0,"yoffset":-22.189453125,"xadvance":31.5615234375,"chnl":15,"x":46,"y":473,"page":0},{"id":37,"width":39,"height":41,"xoffset":0,"yoffset":-30.2900390625,"xadvance":30.76171875,"chnl":15,"x":20,"y":320,"page":0},{"id":103,"width":31,"height":41,"xoffset":0,"yoffset":-22.599609375,"xadvance":23.5634765625,"chnl":15,"x":61,"y":320,"page":0},{"id":113,"width":31,"height":41,"xoffset":0,"yoffset":-22.599609375,"xadvance":23.87109375,"chnl":15,"x":94,"y":320,"page":0},{"id":96,"width":20,"height":41,"xoffset":0,"yoffset":-31.458984375,"xadvance":12.9814453125,"chnl":15,"x":127,"y":320,"page":0},{"id":38,"width":36,"height":41,"xoffset":0,"yoffset":-30.26953125,"xadvance":26.1064453125,"chnl":15,"x":149,"y":320,"page":0},{"id":121,"width":29,"height":41,"xoffset":0,"yoffset":-22.189453125,"xadvance":19.8720703125,"chnl":15,"x":187,"y":320,"page":0},{"id":67,"width":35,"height":41,"xoffset":0,"yoffset":-30.26953125,"xadvance":27.3369140625,"chnl":15,"x":218,"y":320,"page":0},{"id":79,"width":36,"height":41,"xoffset":0,"yoffset":-30.26953125,"xadvance":28.875,"chnl":15,"x":255,"y":320,"page":0},{"id":71,"width":36,"height":41,"xoffset":0,"yoffset":-30.26953125,"xadvance":28.6083984375,"chnl":15,"x":293,"y":320,"page":0},{"id":112,"width":32,"height":41,"xoffset":0,"yoffset":-22.599609375,"xadvance":23.5634765625,"chnl":15,"x":331,"y":320,"page":0},{"id":72,"width":36,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":29.94140625,"chnl":15,"x":141,"y":422,"page":0},{"id":73,"width":18,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":11.4228515625,"chnl":15,"x":179,"y":422,"page":0},{"id":74,"width":30,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":23.173828125,"chnl":15,"x":199,"y":422,"page":0},{"id":75,"width":36,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":26.33203125,"chnl":15,"x":231,"y":422,"page":0},{"id":76,"width":32,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":22.599609375,"chnl":15,"x":269,"y":422,"page":0},{"id":57,"width":31,"height":40,"xoffset":0,"yoffset":-30.26953125,"xadvance":23.583984375,"chnl":15,"x":303,"y":422,"page":0},{"id":78,"width":36,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":29.94140625,"chnl":15,"x":336,"y":422,"page":0},{"id":33,"width":18,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":10.8076171875,"chnl":15,"x":374,"y":422,"page":0},{"id":80,"width":35,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":26.49609375,"chnl":15,"x":394,"y":422,"page":0},{"id":42,"width":27,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":18.087890625,"chnl":15,"x":431,"y":422,"page":0},{"id":82,"width":35,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":25.8603515625,"chnl":15,"x":460,"y":422,"page":0},{"id":49,"width":25,"height":40,"xoffset":0,"yoffset":-30.0029296875,"xadvance":23.583984375,"chnl":15,"x":365,"y":320,"page":0},{"id":84,"width":34,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":25.060546875,"chnl":15,"x":392,"y":320,"page":0},{"id":85,"width":34,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":27.234375,"chnl":15,"x":428,"y":320,"page":0},{"id":86,"width":36,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":26.7216796875,"chnl":15,"x":464,"y":320,"page":0},{"id":50,"width":32,"height":40,"xoffset":0,"yoffset":-30.26953125,"xadvance":23.583984375,"chnl":15,"x":26,"y":268,"page":0},{"id":88,"width":35,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":26.33203125,"chnl":15,"x":60,"y":268,"page":0},{"id":89,"width":35,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":25.224609375,"chnl":15,"x":97,"y":268,"page":0},{"id":90,"width":34,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":25.142578125,"chnl":15,"x":134,"y":268,"page":0},{"id":105,"width":17,"height":40,"xoffset":0,"yoffset":-30.26953125,"xadvance":10.1923828125,"chnl":15,"x":170,"y":268,"page":0},{"id":52,"width":33,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":23.583984375,"chnl":15,"x":189,"y":268,"page":0},{"id":63,"width":28,"height":40,"xoffset":0,"yoffset":-30.26953125,"xadvance":19.8310546875,"chnl":15,"x":224,"y":268,"page":0},{"id":94,"width":26,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":17.5546875,"chnl":15,"x":254,"y":268,"page":0},{"id":53,"width":32,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":23.583984375,"chnl":15,"x":282,"y":268,"page":0},{"id":65,"width":37,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":27.3984375,"chnl":15,"x":316,"y":268,"page":0},{"id":66,"width":34,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":26.1474609375,"chnl":15,"x":355,"y":268,"page":0},{"id":54,"width":32,"height":40,"xoffset":0,"yoffset":-29.8798828125,"xadvance":23.583984375,"chnl":15,"x":391,"y":268,"page":0},{"id":68,"width":35,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":27.5419921875,"chnl":15,"x":425,"y":268,"page":0},{"id":55,"width":32,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":23.583984375,"chnl":15,"x":462,"y":268,"page":0},{"id":70,"width":32,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":23.21484375,"chnl":15,"x":25,"y":216,"page":0},{"id":35,"width":35,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":25.8603515625,"chnl":15,"x":59,"y":216,"page":0},{"id":69,"width":32,"height":40,"xoffset":0,"yoffset":-29.859375,"xadvance":23.87109375,"chnl":15,"x":96,"y":216,"page":0},{"id":116,"width":22,"height":38,"xoffset":0,"yoffset":-27.5625,"xadvance":13.7197265625,"chnl":15,"x":130,"y":216,"page":0},{"id":59,"width":17,"height":38,"xoffset":0,"yoffset":-22.39453125,"xadvance":8.8798828125,"chnl":15,"x":154,"y":216,"page":0},{"id":126,"width":36,"height":26,"xoffset":0,"yoffset":-16.447265625,"xadvance":28.5673828125,"chnl":15,"x":89,"y":473,"page":0},{"id":43,"width":32,"height":35,"xoffset":0,"yoffset":-24.732421875,"xadvance":23.8095703125,"chnl":15,"x":173,"y":216,"page":0},{"id":60,"width":28,"height":33,"xoffset":0,"yoffset":-22.517578125,"xadvance":21.3486328125,"chnl":15,"x":207,"y":216,"page":0},{"id":97,"width":31,"height":33,"xoffset":0,"yoffset":-22.599609375,"xadvance":22.845703125,"chnl":15,"x":237,"y":216,"page":0},{"id":101,"width":31,"height":33,"xoffset":0,"yoffset":-22.599609375,"xadvance":22.2509765625,"chnl":15,"x":270,"y":216,"page":0},{"id":110,"width":30,"height":33,"xoffset":0,"yoffset":-22.599609375,"xadvance":23.173828125,"chnl":15,"x":303,"y":216,"page":0},{"id":111,"width":32,"height":33,"xoffset":0,"yoffset":-22.599609375,"xadvance":23.953125,"chnl":15,"x":335,"y":216,"page":0},{"id":62,"width":30,"height":33,"xoffset":0,"yoffset":-22.5380859375,"xadvance":21.943359375,"chnl":15,"x":369,"y":216,"page":0},{"id":58,"width":17,"height":33,"xoffset":0,"yoffset":-22.39453125,"xadvance":10.171875,"chnl":15,"x":401,"y":216,"page":0},{"id":114,"width":24,"height":33,"xoffset":0,"yoffset":-22.599609375,"xadvance":14.2119140625,"chnl":15,"x":420,"y":216,"page":0},{"id":115,"width":30,"height":33,"xoffset":0,"yoffset":-22.599609375,"xadvance":21.65625,"chnl":15,"x":446,"y":216,"page":0},{"id":99,"width":31,"height":33,"xoffset":0,"yoffset":-22.599609375,"xadvance":21.984375,"chnl":15,"x":478,"y":216,"page":0},{"id":117,"width":30,"height":33,"xoffset":0,"yoffset":-22.189453125,"xadvance":23.1533203125,"chnl":15,"x":23,"y":163,"page":0},{"id":118,"width":30,"height":32,"xoffset":0,"yoffset":-22.189453125,"xadvance":20.34375,"chnl":15,"x":55,"y":163,"page":0},{"id":120,"width":30,"height":32,"xoffset":0,"yoffset":-22.189453125,"xadvance":20.8154296875,"chnl":15,"x":87,"y":163,"page":0},{"id":122,"width":29,"height":32,"xoffset":0,"yoffset":-22.189453125,"xadvance":20.8154296875,"chnl":15,"x":119,"y":163,"page":0},{"id":61,"width":30,"height":30,"xoffset":0,"yoffset":-19.9951171875,"xadvance":23.05078125,"chnl":15,"x":150,"y":163,"page":0},{"id":95,"width":29,"height":13,"xoffset":0,"yoffset":0,"xadvance":18.94921875,"chnl":15,"x":127,"y":473,"page":0},{"id":45,"width":21,"height":24,"xoffset":0,"yoffset":-14.232421875,"xadvance":11.5869140625,"chnl":15,"x":182,"y":163,"page":0},{"id":44,"width":16,"height":20,"xoffset":0,"yoffset":-4.4912109375,"xadvance":8.244140625,"chnl":15,"x":496,"y":268,"page":0},{"id":46,"width":18,"height":15,"xoffset":0,"yoffset":-4.2861328125,"xadvance":11.0537109375,"chnl":15,"x":23,"y":198,"page":0},{"id":32,"width":0,"height":0,"xoffset":0,"yoffset":0,"xadvance":10.3974609375,"chnl":15,"x":0,"y":508,"page":0}],"info":{"face":"Roboto","size":42,"bold":0,"italic":0,"charset":[" ","!","\\"","#","$","%","&","\'","(",")","*","+",",","-",".","/","0","1","2","3","4","5","6","7","8","9",":",";","<","=",">","?","@","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","[","\\\\","]","^","_","`","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","{","|","}","~"],"unicode":1,"stretchH":100,"smooth":1,"aa":1,"padding":[0,0,0,0],"spacing":[2,2]},"common":{"lineHeight":44.091796875,"base":38.96484375,"scaleW":512,"scaleH":512,"pages":1,"packed":0,"alphaChnl":0,"redChnl":0,"greenChnl":0,"blueChnl":0},"kernings":[{"first":32,"second":84,"amount":-0.8203125},{"first":34,"second":34,"amount":-2.1943359375},{"first":34,"second":39,"amount":-2.1943359375},{"first":34,"second":65,"amount":-2.4609375},{"first":34,"second":97,"amount":-1.025390625},{"first":34,"second":99,"amount":-1.2099609375},{"first":34,"second":100,"amount":-1.2099609375},{"first":34,"second":101,"amount":-1.2099609375},{"first":34,"second":103,"amount":-1.2099609375},{"first":34,"second":109,"amount":-0.41015625},{"first":34,"second":110,"amount":-0.41015625},{"first":34,"second":111,"amount":-1.2509765625},{"first":34,"second":112,"amount":-0.41015625},{"first":34,"second":113,"amount":-1.2099609375},{"first":34,"second":115,"amount":-1.640625},{"first":39,"second":34,"amount":-2.1943359375},{"first":39,"second":39,"amount":-2.1943359375},{"first":39,"second":65,"amount":-2.4609375},{"first":39,"second":97,"amount":-1.025390625},{"first":39,"second":99,"amount":-1.2099609375},{"first":39,"second":100,"amount":-1.2099609375},{"first":39,"second":101,"amount":-1.2099609375},{"first":39,"second":103,"amount":-1.2099609375},{"first":39,"second":109,"amount":-0.41015625},{"first":39,"second":110,"amount":-0.41015625},{"first":39,"second":111,"amount":-1.2509765625},{"first":39,"second":112,"amount":-0.41015625},{"first":39,"second":113,"amount":-1.2099609375},{"first":39,"second":115,"amount":-1.640625},{"first":40,"second":86,"amount":0.41015625},{"first":40,"second":87,"amount":0.369140625},{"first":40,"second":89,"amount":0.451171875},{"first":44,"second":34,"amount":-3.486328125},{"first":44,"second":39,"amount":-3.486328125},{"first":46,"second":34,"amount":-3.486328125},{"first":46,"second":39,"amount":-3.486328125},{"first":47,"second":47,"amount":-4.59375},{"first":65,"second":34,"amount":-2.4609375},{"first":65,"second":39,"amount":-2.4609375},{"first":65,"second":67,"amount":-0.2255859375},{"first":65,"second":71,"amount":-0.2255859375},{"first":65,"second":79,"amount":-0.2255859375},{"first":65,"second":81,"amount":-0.2255859375},{"first":65,"second":84,"amount":-2.6455078125},{"first":65,"second":85,"amount":-0.3486328125},{"first":65,"second":86,"amount":-1.7841796875},{"first":65,"second":87,"amount":-1.4150390625},{"first":65,"second":89,"amount":-1.927734375},{"first":65,"second":111,"amount":-0.24609375},{"first":65,"second":117,"amount":-0.2255859375},{"first":65,"second":118,"amount":-1.025390625},{"first":65,"second":121,"amount":-1.025390625},{"first":65,"second":122,"amount":0.24609375},{"first":66,"second":84,"amount":-0.5537109375},{"first":66,"second":86,"amount":-0.4921875},{"first":66,"second":89,"amount":-1.1279296875},{"first":67,"second":84,"amount":-0.5947265625},{"first":68,"second":44,"amount":-2.091796875},{"first":68,"second":46,"amount":-2.091796875},{"first":68,"second":65,"amount":-0.4306640625},{"first":68,"second":84,"amount":-0.5537109375},{"first":68,"second":86,"amount":-0.451171875},{"first":68,"second":88,"amount":-0.451171875},{"first":68,"second":89,"amount":-0.8818359375},{"first":68,"second":90,"amount":-0.4716796875},{"first":69,"second":84,"amount":0.41015625},{"first":69,"second":99,"amount":-0.3896484375},{"first":69,"second":100,"amount":-0.3896484375},{"first":69,"second":101,"amount":-0.3896484375},{"first":69,"second":103,"amount":-0.3896484375},{"first":69,"second":111,"amount":-0.3896484375},{"first":69,"second":113,"amount":-0.3896484375},{"first":69,"second":117,"amount":-0.3486328125},{"first":69,"second":118,"amount":-0.533203125},{"first":69,"second":121,"amount":-0.533203125},{"first":70,"second":44,"amount":-4.798828125},{"first":70,"second":46,"amount":-4.798828125},{"first":70,"second":65,"amount":-3.486328125},{"first":70,"second":74,"amount":-5.4140625},{"first":70,"second":84,"amount":0.41015625},{"first":70,"second":97,"amount":-0.697265625},{"first":70,"second":99,"amount":-0.4306640625},{"first":70,"second":100,"amount":-0.4306640625},{"first":70,"second":101,"amount":-0.4306640625},{"first":70,"second":103,"amount":-0.4306640625},{"first":70,"second":111,"amount":-0.4306640625},{"first":70,"second":113,"amount":-0.4306640625},{"first":70,"second":114,"amount":-0.533203125},{"first":70,"second":117,"amount":-0.451171875},{"first":70,"second":118,"amount":-0.4921875},{"first":70,"second":121,"amount":-0.4921875},{"first":72,"second":65,"amount":0.369140625},{"first":72,"second":84,"amount":-0.5947265625},{"first":72,"second":88,"amount":0.3486328125},{"first":72,"second":89,"amount":-0.57421875},{"first":73,"second":65,"amount":0.369140625},{"first":73,"second":84,"amount":-0.5947265625},{"first":73,"second":88,"amount":0.3486328125},{"first":73,"second":89,"amount":-0.57421875},{"first":74,"second":65,"amount":-0.451171875},{"first":75,"second":45,"amount":-1.3125},{"first":75,"second":67,"amount":-0.6357421875},{"first":75,"second":71,"amount":-0.6357421875},{"first":75,"second":79,"amount":-0.6357421875},{"first":75,"second":81,"amount":-0.6357421875},{"first":75,"second":99,"amount":-0.533203125},{"first":75,"second":100,"amount":-0.533203125},{"first":75,"second":101,"amount":-0.533203125},{"first":75,"second":103,"amount":-0.533203125},{"first":75,"second":109,"amount":-0.4716796875},{"first":75,"second":110,"amount":-0.4716796875},{"first":75,"second":111,"amount":-0.5537109375},{"first":75,"second":112,"amount":-0.4716796875},{"first":75,"second":113,"amount":-0.533203125},{"first":75,"second":117,"amount":-0.4716796875},{"first":75,"second":118,"amount":-0.8203125},{"first":75,"second":121,"amount":-0.8203125},{"first":76,"second":34,"amount":-6.890625},{"first":76,"second":39,"amount":-6.890625},{"first":76,"second":65,"amount":0.3896484375},{"first":76,"second":67,"amount":-1.3330078125},{"first":76,"second":71,"amount":-1.3330078125},{"first":76,"second":79,"amount":-1.3330078125},{"first":76,"second":81,"amount":-1.3330078125},{"first":76,"second":84,"amount":-5.6396484375},{"first":76,"second":85,"amount":-1.107421875},{"first":76,"second":86,"amount":-3.5888671875},{"first":76,"second":87,"amount":-2.9326171875},{"first":76,"second":89,"amount":-4.9013671875},{"first":76,"second":117,"amount":-0.90234375},{"first":76,"second":118,"amount":-2.7275390625},{"first":76,"second":121,"amount":-2.7275390625},{"first":77,"second":65,"amount":0.369140625},{"first":77,"second":84,"amount":-0.5947265625},{"first":77,"second":88,"amount":0.3486328125},{"first":77,"second":89,"amount":-0.57421875},{"first":78,"second":65,"amount":0.369140625},{"first":78,"second":84,"amount":-0.5947265625},{"first":78,"second":88,"amount":0.3486328125},{"first":78,"second":89,"amount":-0.57421875},{"first":79,"second":44,"amount":-2.091796875},{"first":79,"second":46,"amount":-2.091796875},{"first":79,"second":65,"amount":-0.4306640625},{"first":79,"second":84,"amount":-0.5537109375},{"first":79,"second":86,"amount":-0.451171875},{"first":79,"second":88,"amount":-0.451171875},{"first":79,"second":89,"amount":-0.8818359375},{"first":79,"second":90,"amount":-0.4716796875},{"first":80,"second":44,"amount":-6.64453125},{"first":80,"second":46,"amount":-6.64453125},{"first":80,"second":65,"amount":-2.830078125},{"first":80,"second":74,"amount":-4.1015625},{"first":80,"second":88,"amount":-0.6357421875},{"first":80,"second":90,"amount":-0.533203125},{"first":80,"second":97,"amount":-0.2255859375},{"first":80,"second":99,"amount":-0.2666015625},{"first":80,"second":100,"amount":-0.2666015625},{"first":80,"second":101,"amount":-0.2666015625},{"first":80,"second":103,"amount":-0.2666015625},{"first":80,"second":111,"amount":-0.2666015625},{"first":80,"second":113,"amount":-0.2666015625},{"first":80,"second":118,"amount":0.3076171875},{"first":80,"second":121,"amount":0.3076171875},{"first":81,"second":84,"amount":-0.8818359375},{"first":81,"second":86,"amount":-0.57421875},{"first":81,"second":87,"amount":-0.41015625},{"first":81,"second":89,"amount":-0.7177734375},{"first":82,"second":84,"amount":-1.640625},{"first":82,"second":86,"amount":-0.3896484375},{"first":82,"second":89,"amount":-0.984375},{"first":84,"second":44,"amount":-4.470703125},{"first":84,"second":45,"amount":-4.7578125},{"first":84,"second":46,"amount":-4.470703125},{"first":84,"second":65,"amount":-1.6201171875},{"first":84,"second":67,"amount":-0.57421875},{"first":84,"second":71,"amount":-0.57421875},{"first":84,"second":74,"amount":-4.921875},{"first":84,"second":79,"amount":-0.57421875},{"first":84,"second":81,"amount":-0.57421875},{"first":84,"second":83,"amount":-0.328125},{"first":84,"second":84,"amount":0.328125},{"first":84,"second":86,"amount":0.328125},{"first":84,"second":87,"amount":0.3076171875},{"first":84,"second":89,"amount":0.328125},{"first":84,"second":97,"amount":-2.3173828125},{"first":84,"second":99,"amount":-2.0302734375},{"first":84,"second":100,"amount":-2.0302734375},{"first":84,"second":101,"amount":-2.0302734375},{"first":84,"second":103,"amount":-2.0302734375},{"first":84,"second":109,"amount":-2.2353515625},{"first":84,"second":110,"amount":-2.2353515625},{"first":84,"second":111,"amount":-2.0302734375},{"first":84,"second":112,"amount":-2.2353515625},{"first":84,"second":113,"amount":-2.0302734375},{"first":84,"second":115,"amount":-2.37890625},{"first":84,"second":117,"amount":-1.9482421875},{"first":84,"second":118,"amount":-1.4765625},{"first":84,"second":120,"amount":-1.5791015625},{"first":84,"second":121,"amount":-1.4765625},{"first":84,"second":122,"amount":-1.23046875},{"first":85,"second":65,"amount":-0.451171875},{"first":86,"second":44,"amount":-4.6142578125},{"first":86,"second":45,"amount":-0.7587890625},{"first":86,"second":46,"amount":-4.6142578125},{"first":86,"second":65,"amount":-1.5380859375},{"first":86,"second":67,"amount":-0.2666015625},{"first":86,"second":71,"amount":-0.2666015625},{"first":86,"second":79,"amount":-0.2666015625},{"first":86,"second":81,"amount":-0.2666015625},{"first":86,"second":97,"amount":-0.943359375},{"first":86,"second":99,"amount":-0.90234375},{"first":86,"second":100,"amount":-0.90234375},{"first":86,"second":101,"amount":-0.90234375},{"first":86,"second":103,"amount":-0.90234375},{"first":86,"second":111,"amount":-0.943359375},{"first":86,"second":113,"amount":-0.90234375},{"first":86,"second":117,"amount":-0.57421875},{"first":86,"second":118,"amount":-0.2255859375},{"first":86,"second":121,"amount":-0.2255859375},{"first":87,"second":44,"amount":-2.5224609375},{"first":87,"second":45,"amount":-1.23046875},{"first":87,"second":46,"amount":-2.5224609375},{"first":87,"second":65,"amount":-0.8818359375},{"first":87,"second":84,"amount":0.287109375},{"first":87,"second":97,"amount":-0.6767578125},{"first":87,"second":99,"amount":-0.6357421875},{"first":87,"second":100,"amount":-0.6357421875},{"first":87,"second":101,"amount":-0.6357421875},{"first":87,"second":103,"amount":-0.6357421875},{"first":87,"second":111,"amount":-0.6357421875},{"first":87,"second":113,"amount":-0.6357421875},{"first":87,"second":117,"amount":-0.3896484375},{"first":88,"second":45,"amount":-0.943359375},{"first":88,"second":67,"amount":-0.5126953125},{"first":88,"second":71,"amount":-0.5126953125},{"first":88,"second":79,"amount":-0.5126953125},{"first":88,"second":81,"amount":-0.5126953125},{"first":88,"second":86,"amount":0.287109375},{"first":88,"second":99,"amount":-0.533203125},{"first":88,"second":100,"amount":-0.533203125},{"first":88,"second":101,"amount":-0.533203125},{"first":88,"second":103,"amount":-0.533203125},{"first":88,"second":111,"amount":-0.4306640625},{"first":88,"second":113,"amount":-0.533203125},{"first":88,"second":117,"amount":-0.4306640625},{"first":88,"second":118,"amount":-0.6357421875},{"first":88,"second":121,"amount":-0.6357421875},{"first":89,"second":44,"amount":-4.3271484375},{"first":89,"second":45,"amount":-1.06640625},{"first":89,"second":46,"amount":-4.3271484375},{"first":89,"second":65,"amount":-1.927734375},{"first":89,"second":67,"amount":-0.5947265625},{"first":89,"second":71,"amount":-0.5947265625},{"first":89,"second":74,"amount":-1.96875},{"first":89,"second":79,"amount":-0.5947265625},{"first":89,"second":81,"amount":-0.5947265625},{"first":89,"second":83,"amount":-0.328125},{"first":89,"second":84,"amount":0.3486328125},{"first":89,"second":85,"amount":-1.96875},{"first":89,"second":86,"amount":0.369140625},{"first":89,"second":87,"amount":0.3486328125},{"first":89,"second":88,"amount":0.2666015625},{"first":89,"second":89,"amount":0.369140625},{"first":89,"second":97,"amount":-1.4970703125},{"first":89,"second":99,"amount":-1.3330078125},{"first":89,"second":100,"amount":-1.3330078125},{"first":89,"second":101,"amount":-1.3330078125},{"first":89,"second":103,"amount":-1.3330078125},{"first":89,"second":109,"amount":-0.8203125},{"first":89,"second":110,"amount":-0.8203125},{"first":89,"second":111,"amount":-1.3330078125},{"first":89,"second":112,"amount":-0.8203125},{"first":89,"second":113,"amount":-1.3330078125},{"first":89,"second":115,"amount":-1.189453125},{"first":89,"second":117,"amount":-0.7998046875},{"first":89,"second":118,"amount":-0.41015625},{"first":89,"second":120,"amount":-0.4716796875},{"first":89,"second":121,"amount":-0.41015625},{"first":89,"second":122,"amount":-0.615234375},{"first":90,"second":65,"amount":0.2666015625},{"first":90,"second":67,"amount":-0.533203125},{"first":90,"second":71,"amount":-0.533203125},{"first":90,"second":79,"amount":-0.533203125},{"first":90,"second":81,"amount":-0.533203125},{"first":90,"second":99,"amount":-0.4306640625},{"first":90,"second":100,"amount":-0.4306640625},{"first":90,"second":101,"amount":-0.4306640625},{"first":90,"second":103,"amount":-0.4306640625},{"first":90,"second":111,"amount":-0.4306640625},{"first":90,"second":113,"amount":-0.4306640625},{"first":90,"second":117,"amount":-0.3896484375},{"first":90,"second":118,"amount":-0.5537109375},{"first":90,"second":121,"amount":-0.5537109375},{"first":91,"second":74,"amount":-0.369140625},{"first":91,"second":85,"amount":-0.369140625},{"first":97,"second":34,"amount":-1.3740234375},{"first":97,"second":39,"amount":-1.3740234375},{"first":97,"second":118,"amount":-0.3076171875},{"first":97,"second":121,"amount":-0.3076171875},{"first":98,"second":34,"amount":-0.5947265625},{"first":98,"second":39,"amount":-0.5947265625},{"first":98,"second":118,"amount":-0.2255859375},{"first":98,"second":120,"amount":-0.3076171875},{"first":98,"second":121,"amount":-0.2255859375},{"first":98,"second":122,"amount":-0.3076171875},{"first":99,"second":34,"amount":-0.2255859375},{"first":99,"second":39,"amount":-0.2255859375},{"first":101,"second":34,"amount":-0.287109375},{"first":101,"second":39,"amount":-0.287109375},{"first":101,"second":118,"amount":-0.2666015625},{"first":101,"second":121,"amount":-0.2666015625},{"first":102,"second":34,"amount":0.328125},{"first":102,"second":39,"amount":0.328125},{"first":102,"second":41,"amount":0.41015625},{"first":102,"second":93,"amount":0.369140625},{"first":102,"second":99,"amount":-0.4921875},{"first":102,"second":100,"amount":-0.4921875},{"first":102,"second":101,"amount":-0.4921875},{"first":102,"second":103,"amount":-0.4921875},{"first":102,"second":113,"amount":-0.4921875},{"first":102,"second":125,"amount":0.3896484375},{"first":104,"second":34,"amount":-2.1328125},{"first":104,"second":39,"amount":-2.1328125},{"first":107,"second":99,"amount":-0.41015625},{"first":107,"second":100,"amount":-0.41015625},{"first":107,"second":101,"amount":-0.41015625},{"first":107,"second":103,"amount":-0.41015625},{"first":107,"second":113,"amount":-0.41015625},{"first":109,"second":34,"amount":-2.1328125},{"first":109,"second":39,"amount":-2.1328125},{"first":110,"second":34,"amount":-2.1328125},{"first":110,"second":39,"amount":-2.1328125},{"first":111,"second":34,"amount":-2.7890625},{"first":111,"second":39,"amount":-2.7890625},{"first":111,"second":118,"amount":-0.3076171875},{"first":111,"second":120,"amount":-0.4306640625},{"first":111,"second":121,"amount":-0.3076171875},{"first":111,"second":122,"amount":-0.328125},{"first":112,"second":34,"amount":-0.5947265625},{"first":112,"second":39,"amount":-0.5947265625},{"first":112,"second":118,"amount":-0.2255859375},{"first":112,"second":120,"amount":-0.3076171875},{"first":112,"second":121,"amount":-0.2255859375},{"first":112,"second":122,"amount":-0.3076171875},{"first":114,"second":34,"amount":0.328125},{"first":114,"second":39,"amount":0.328125},{"first":114,"second":44,"amount":-2.5224609375},{"first":114,"second":46,"amount":-2.5224609375},{"first":114,"second":97,"amount":-0.8203125},{"first":114,"second":99,"amount":-0.3896484375},{"first":114,"second":100,"amount":-0.3896484375},{"first":114,"second":101,"amount":-0.3896484375},{"first":114,"second":103,"amount":-0.3896484375},{"first":114,"second":111,"amount":-0.41015625},{"first":114,"second":113,"amount":-0.3896484375},{"first":114,"second":118,"amount":0.369140625},{"first":114,"second":121,"amount":0.369140625},{"first":116,"second":111,"amount":-0.41015625},{"first":118,"second":34,"amount":0.3076171875},{"first":118,"second":39,"amount":0.3076171875},{"first":118,"second":44,"amount":-2.1943359375},{"first":118,"second":46,"amount":-2.1943359375},{"first":118,"second":97,"amount":-0.3076171875},{"first":118,"second":99,"amount":-0.2666015625},{"first":118,"second":100,"amount":-0.2666015625},{"first":118,"second":101,"amount":-0.2666015625},{"first":118,"second":103,"amount":-0.2666015625},{"first":118,"second":111,"amount":-0.3076171875},{"first":118,"second":113,"amount":-0.2666015625},{"first":119,"second":44,"amount":-2.54296875},{"first":119,"second":46,"amount":-2.54296875},{"first":120,"second":99,"amount":-0.41015625},{"first":120,"second":100,"amount":-0.41015625},{"first":120,"second":101,"amount":-0.41015625},{"first":120,"second":103,"amount":-0.41015625},{"first":120,"second":111,"amount":-0.41015625},{"first":120,"second":113,"amount":-0.41015625},{"first":121,"second":34,"amount":0.3076171875},{"first":121,"second":39,"amount":0.3076171875},{"first":121,"second":44,"amount":-2.1943359375},{"first":121,"second":46,"amount":-2.1943359375},{"first":121,"second":97,"amount":-0.3076171875},{"first":121,"second":99,"amount":-0.2666015625},{"first":121,"second":100,"amount":-0.2666015625},{"first":121,"second":101,"amount":-0.2666015625},{"first":121,"second":103,"amount":-0.2666015625},{"first":121,"second":111,"amount":-0.3076171875},{"first":121,"second":113,"amount":-0.2666015625},{"first":122,"second":99,"amount":-0.328125},{"first":122,"second":100,"amount":-0.328125},{"first":122,"second":101,"amount":-0.328125},{"first":122,"second":103,"amount":-0.328125},{"first":122,"second":111,"amount":-0.328125},{"first":122,"second":113,"amount":-0.328125},{"first":123,"second":74,"amount":-0.41015625},{"first":123,"second":85,"amount":-0.41015625}]}'),a=t.t(i,2);const v=String.fromCharCode(26);function isNewline(e){return!!/[\n\r]/.test(e)}function equalStyle(e,t,s,i){return!e&&!t||(e?t?(e.font||s)===(t.font||s)&&(e.size||i)===(t.size||i)&&e.color===t.color&&!!e.bold==!!t.bold&&!!e.italic==!!t.italic:e.font===s&&e.size===i&&!e.color&&!e.bold&&!e.italic:t.font===s&&t.size===i&&!t.color&&!t.bold&&!t.italic)}class MetricCache{constructor(){this.cache=[new Map],this.maxMaps=4,this.limit=256}makeKey(e,t,s){t={font:t,size:s,style:e.style,styles:e.styles,text:e.text};return JSON.stringify(t)}lookup(t){for(let e=0;e<this.cache.length;e++){var s=this.cache[e].get(t);if(s)return{...s}}return null}update(e,t){let s=this.cache[this.cache.length-1];s.set(e,t),s.size>=this.limit&&(this.cache.length===this.maxMaps&&(e=Math.floor(Math.random()*this.cache.length),this.cache.splice(e,1)),this.cache.push(new Map))}}const o=new class MSDFFontRegistry{constructor(){this.layouts=new Map}hasLayout(e){return this.layouts.get(e)}addLayout(e,t){return this.layouts.set(e,t),t}measureText(e,t,s){let i=this.layouts.get(t);return i?i.measureText(e.text):{ascent:36,height:50,descent:14,width:20*e.text.length}}getInfo(e,t){e=this.layouts.get(e);let s;return(s=e?e._opt.font:s)?s:{common:{lineHeight:t}}}};class Measurer{constructor(){this.cache=new MetricCache}measureText(e,t,s){var i=this.cache.makeKey(e,t,s);let r=this.cache.lookup(i);return r||(r=o.measureText(e,t,s),this.cache.update(i,r)),r}lineHeight(e,t){e=o.getInfo(e,t);return e.common?e.common.lineHeight:e.atlas.size}}class Wrap{splitWords(e,i,r){var t,a=e=>!!/[ \f\n\r\t\v\u00A0\u2028\u2029]/.test(e),o=(e,t,s)=>{s&&1<s.length?l.push(Object.assign(e,{styles:s})):s&&1===s.length?l.push(Object.assign(e,{style:s[0].style})):t?l.push(Object.assign(e,{style:t})):l.push(e)},n=(e,t)=>{if(!e)return[t];let s=e[e.length-1];return equalStyle(s.style,t.style,i,r)?s.end=t.end:e.push(t),e};let l=[],h,d=0,c="",u=null,p,f;for(let i=0;i<e.length-1;i++){void 0===h&&(h=!a(e[0].text[0]));var m,y,g=e[i];let t=g.text,s=(p=g.style,h=h||!a(t[0]),0);for(let e=0;e<t.length;e++)0===d&&0===i&&0===e||(h?a(t[e])&&(f=t.slice(s,e),m=0<c.length&&0===f.length,0<c.length&&(0<f.length&&(y={start:c.length,end:c.length+f.length,style:p},u=n(u,y)),f=c+f,c=""),o({start:d,end:d+f.length,text:f},m?null:p,u),d+=f.length,s=e,h=!1,u=null):(0<e&&(o({start:d,end:d+1,text:t[e-1],style:p,styles:u}),d+=1,s+=1),a(t[e])||(h=!0)));1===(f=t.slice(s,t.length)).length&&a(f)?(o({start:d,end:d+1,text:f,style:p,styles:u}),d+=1):(g={start:c.length,end:c.length+f.length,style:p},u=n(u,g),c+=f)}let s=d;return 0<c.length&&(s=d+c.length,t={start:d,end:s,text:c},u&&1===u.length&&equalStyle(p,u[0].style,i,r)?o(t,p):o(t,null,u)),o({start:s,end:s+1,text:v}),l}mergeRect(e,t){return e?t?{width:e.width+t.width,height:Math.max(e.height,t.height),ascent:Math.max(e.ascent,t.ascent)}:e:t}wrap(e,t,s,i,r,a){var o=t-(a=a||{left:0,top:0,right:0,bottom:0}).left-a.right;let n=[],l=0,h=0,d=[],c=a.left,u=a.top;var p=this.splitWords(e,i,r),f=()=>{0!==n.length&&(n.forEach(e=>{e.ascent=h}),d.push(n),n=[],c=a.left,u+=l,l=0,h=0)};for(let t=0;t<p.length-1;t++){var m=p[t];let e;isNewline(m.text)?(e=s.measureText(m,i,r),t===p.length-1?f():(l=Math.max(l,e.height),h=Math.max(h,e.ascent)),e.left=c,e.top=u,Object.assign(m,e),n.push(m),f(),l=0,h=0):(e=s.measureText(m,i,r),l=Math.max(l,e.height),h=Math.max(h,e.ascent),e.width+c>o&&f(),e.left=c,e.top=u,Object.assign(m,e),c+=e.width,n.push(m))}f();t=p[p.length-1];let y=s.measureText(t,i,r);return l=Math.max(l,y.height),h=Math.max(h,y.ascent),y.left=a.left,y.top=u,Object.assign(t,y),n.push(t),f(),[d,p]}}function maybeSelectCommentOrLine(e){var t,s=e.selection,{row:i,column:r}=s.lead,a=e.selectionOrLineString();s.isEmpty()&&(-1===(t=a.indexOf("//"))||r<t||0<t&&0<=":\"'".indexOf(a[t-1])?e.selectLine(i):s.range={start:{row:i,column:t+2},end:{row:i,column:a.length}})}function doEval(e,t,s,i){t=t||(e.selection.isEmpty()?e.lineRange():e.selection.range),i||e.textInRange(t)}Object.assign({},{"clipboard copy":{doc:"placeholder for native copy",exec:e=>!1},"clipboard cut":{doc:"placeholder for native cut",exec:e=>!1},"clipboard paste":{doc:"placeholder for native paste",exec:e=>!1}},{doit:{doc:"Evaluates the selected code or the current line and report the result",exec:async(e,t,s=1)=>{maybeSelectCommentOrLine(e);let i,r;try{t=Object.assign({},t,{inspect:!0,inspectDepth:s}),i=await doEval(e,void 0),r=i.isError?i.value:null}catch(e){r=e}return r&&console.log("**"+r),i}},printit:{doc:"Evaluates selected code or the current line and inserts the result in a printed representation",exec:async(e,t)=>{maybeSelectCommentOrLine(e);let s,i;try{t=Object.assign({},t,{asString:!0}),s=await doEval(e,void 0),i=s.isError?s.value:null}catch(e){i=e}return e.selection.collapseToEnd(),e.insertTextAndSelect(i?String(i)+(i.stack?"\n"+i.stack:""):String(s.value)),s}}});function GA(e){return/^[0-9]+$/.test(e)}let n=[[""],["shift"],["alt"],["alt","shift"],["ctrl"],["ctrl","shift"],["ctrl","alt"],["ctrl","alt","shift"],["meta"],["meta","shift"],["meta","alt"],["meta","alt","shift"],["meta","ctrl"],["meta","ctrl","shift"],["meta","ctrl","alt"],["meta","shift","alt","shift"]],l={shift:1,alt:2,option:2,control:4,ctrl:4,super:8,win:8,meta:8,command:8,cmd:8};function cap(e){return e[0].toUpperCase()+e.slice(1)}function eventToKeyCombo(e,t,s){let i=s.key,r=s.keyIdentifier;if(0<=["ArrowLeft","ArrowRight","ArrowUp","ArrowDown"].indexOf(s.key))return s.key;if(0<=[10,13,8,46].indexOf(s.keyCode))return s.key;if(0===e||1===e)return null;if(!i&&r&&(i=function decodeKeyIdentifier(e,t){let s=e,i=s&&s.replace(/u\+?([\d\w]{4})/gi,(e,t)=>String.fromCharCode(parseInt(t,16)));return" "===(i="Command"!==i&&"Cmd"!==i?i:"Meta")&&(i="Space"),i=8===t?"Backspace":i}(r,s.which||s.keyCode),s.key=i=i[s.shiftKey?"toUpperCase":"toLowerCase"](),function isModifier(e){return!GA(e)&&(e=e.replace(/-$/,"").toLowerCase(),l[e])}(i)))return cap(i[0]);let a=n[e],o=(s.code&&(i=function identifyKeyFromCode(e){let t=e.code;if("string"!=typeof t)return null;if(t.startsWith("Key"))return t.slice(3);if(t.startsWith("Numpad"))return t;if(t.startsWith("Digit"))return t.slice(5);if(t.startsWith("Arrow"))return t.slice(5);if(t.match(/^F[0-9]{1-2}$/))return t;switch(t){case"Insert":case"Home":case"PageUp":case"PageDown":return t;case"Period":return".";case"Comma":return",";case"Help":return"Insert";case"Equal":return"=";case"Backslash":case"IntlBackslash":return"\\";case"Minus":return"-";case"BracketRight":return"]";case"BracketLeft":return"[";case"Quote":return"'";case"Backquote":return"`";case"Semicolon":return";";default:return null}}(s)||i),a.map(cap).join("-"));return t||(o+=i?"-"+i:""),o}function canonicalizeKeyboardEvent(s){let i=0,r={keyCombo:"",key:"",shiftKey:!1,altKey:!1,ctrlKey:!1,metaKey:!1,altGraphKey:!1,isFunctionKey:!1,isModified:!1,onlyModifiers:!1,onlyShiftModifier:null,type:s.type,keyCode:s.keyCode};Object.keys(l).forEach(e=>{var t=e+"Key";s[t]&&(i|=l[e],r[t]=!0)}),l[s.key.toLowerCase()]&&(r.onlyModifiers=!0);var e=eventToKeyCombo(i,r.onlyModifiers,s);if(!e)return null;if(0===i||1===i)return r.keyCombo=e,r.key=s.key,1===i&&(r.onlyShiftModifier=!0,r.isModified=!0),r;if(1<i&&(r.isModified=!0),r.onlyModifiers)return r.keyCombo=e,r.key=s.key,r.onlyModifiers=!0,r;var t=function canonicalizeFunctionKey(e){switch(e=e.toLowerCase()){case"space":e="space";break;case"esc":e="escape";break;case"return":e="enter";break;case"arrowleft":e="left";break;case"arrowright":e="right";break;case"arrowup":e="up";break;case"arrowdown":e="down"}return["backspace","tab","enter","pause","escape"," ","pageup","pagedown","end","home","left","up","right","down","print","insert","delete","numpad0","numpad1","numpad2","numpad3","numpad4","numpad5","numpad6","numpad7","numpad8","numpad9","numpadenter","f1","f2","f3","f4","f5","f6","f7","f8","f9","f10","f11","f12","numlock","scrolllock"].includes(e)?cap(e):""}(s.key);if(t)r.isFunctionKey=!0,r.key=t;else{if(!r.isModified)return null;r.onlyShiftModifier?r.key=s.key:r.key=s.key[0].toUpperCase()+s.key.slice(1)}return r.keyCombo=e,r}let h=0;function runLength(e){return e.map(e=>e.text).reduce((e,t)=>t.length+e,0)}class Doc{constructor(e){this.runs=[],this.intervals=[],this.selections={},this.defaultFont=e.defaultFont||"Roboto",this.defaultSize=e.defaultSize||10}load(e){this.canonicalize(e)}setDefault(e,t){this.defaultFont=e||this.defaultFont,this.defaultSize=t||this.defaultSize}doEvent(e){"insert"===e.type?this.doInsert(e.user,e.runs):"delete"===e.type?this.doDelete(e.user,e.backspace):"select"===e.type?this.doSelect(e.user,e.start,e.end,e.isBol):"setStyle"===e.type&&this.doSetStyle(e.user,e.style,e.merge)}doInsert(t,s){var i=this.ensureSelection(t),r=0<s.length&&"\n"===s[s.length-1].text;if(i.start===i.end){let[,e]=this.findRun(i.start);var a=this.intervals[e];a.end!==i.start&&a.start!==i.start?(this.splitRunAt(e,i.start-a.start),e+=1):a.end===i.start&&(e+=1),this.runs.splice(e,0,...s),this.canonicalize(this.runs,a.start),this.updateSelectionsInsert(t,i.start,runLength(s),r)}else this.doDelete(t,!0),this.doInsert(t,s)}doDelete(e,t){var s=this.ensureSelection(e);let i,r;var a=this.length();if(s.start===s.end){if(!t&&s.start===a||t&&0===s.start)return;r=t?(i=s.start-1,s.end):(i=s.start,s.end+1)}else i=s.start,r=s.end;let[,o]=this.findRun(i);a=this.intervals[o];a.end!==i&&(this.splitRunAt(o,i-a.start),o+=1);let[,n]=this.findRun(r);t=this.intervals[n],s=r-t.start;r!==t.end&&0!=s?(this.splitRunAt(n,s),n+=1):r===t.end&&(n+=1),this.runs.splice(o,n-o),this.canonicalize(this.runs),this.updateSelectionsDelete(e,i,r)}doSelect(e,t,s,i){this.selections[e.id]={start:t,end:s,isBol:i,color:e.color}}doSetStyle(a,o,n){a=this.selections[a.id];if(a.start!==a.end){var l,h=a.start,d=a.end;let[e,t]=this.findRun(h),s=this.intervals[t],i=(s.start!==h&&this.splitRunAt(t,h-s.start),[e,t]=this.findRun(d),(s=this.intervals[t]).end!==d&&this.splitRunAt(t,d-s.start),h),r=0;for(;i<d&&r<1e4;)r++,[e,t]=this.findRun(i),(s=this.intervals[t]).end<=d&&(l=n?{...e.style,...o}:{...o},e.style=l,i=s.end);this.canonicalize(this.runs)}}length(){return this.intervals[this.intervals.length-1].end-1}copyRun(e){if(!e)return e;let t={};return t.text=e.text,e.style&&(t.style=e.style),t}canonicalize(e){let t=[],s=[],i=0;var r,a,o=()=>{t.push({text:v}),s.push({start:i,end:i+1})};if(0===e.length)return o(),this.runs=t,void(this.intervals=s);let n=this.copyRun(e[0]),l=1,h=this.copyRun(e[l]);for(;h&&h.text!==v;)equalStyle(n.style,h.style)?n.text+=h.text:(r=i+n.text.length,a={start:i,end:r},i=r,t.push(n),s.push(a),n=h),l++,h=this.copyRun(e[l]);var d=i+n.text.length,c={start:i,end:d};t.push(n),s.push(c),i=d,t[t.length-1].text!==v&&o(),this.runs=t,this.intervals=s}styleAt(e){var[e]=this.findRun(e);return e.style}save(e,t){var s=this.runs,i=this.intervals,e=void 0!==e?e:0,t=void 0!==t?t:this.length();let r,a,o,n,l,h,d;if([r,a]=this.findRun(e),[o,n]=this.findRun(t),a===n)return d=i[a],[h=this.copyRun({text:r.text.slice(e-d.start,t-d.start)})];let c=[];l=r,d=i[a],h=this.copyRun({text:l.text.slice(e-d.start)},!0),c.push(h);for(let e=a+1;e<=n-1;e++)h=this.copyRun(s[e]),c.push(h);return d=i[n],(h=this.copyRun({text:o.text.slice(0,t-d.start)})).text!==v&&c.push(h),c}plainText(e,t){return this.save(e,t).map(e=>e.text).join("")}splitRunAt(e,t){let s=this.runs[e];var i=this.intervals[e],r=this.copyRun({text:s.text.slice(0,t),style:s.style}),a=this.copyRun({text:s.text.slice(t,s.text.length),style:s.style});this.runs.splice(e,1,r,a),r={start:i.start,end:i.start+t},a={start:i.start+t,end:i.end},this.intervals.splice(e,1,r,a)}findRun(t){var s=this.runs,i=this.intervals;let r;for(let e=0;e<s.length;e++)if((r=i[e]).start<=t&&t<r.end)return[s[e],e];return t===r.end?[s[s.length-1],s.length-1]:[null,null]}updateSelectionsInsert(e,t,s,i){for(var r in this.selections){var a=this.selections[r];r===e.id?this.selections[r]={start:t+s,end:t+s,isBol:i,color:e.color}:t<a.start?this.selections[r]={start:a.start+s,end:a.end+s,isBol:i,color:a.color}:a.start<t&&t<a.end&&(this.selections[r]={start:a.start,end:a.end+s,isBol:i,color:a.color})}}updateSelectionsDelete(e,t,s){var i,r=s-t;for(i in this.selections){var a=this.selections[i],[a]=(i===e.id?this.selections[i]={start:t,end:t,color:e.color}:s<=a.start?this.selections[i]={start:a.start-r,end:a.end-r,color:a.color}:a.end<=t||(t<=a.start&&a.end<=s?this.selections[i]={start:t,end:t,color:a.color}:t<a.start&&s<a.end?this.selections[i]={start:t,end:a.end-r,color:a.color}:a.start<=t&&s<a.end?this.selections[i]={start:a.start,end:a.end-r,color:a.color}:a.start<=t&&t<a.end&&(this.selections[i]={start:a.start,end:t,color:a.color})),this.findRun(this.selections[i].start-1));this.selections[i].isBol=a&&isNewline(a.text[a.text.length-1])}}setSelections(e){this.selections=JSON.parse(JSON.stringify(e))}getSelections(){return JSON.parse(JSON.stringify(this.selections))}ensureSelection(e){let t=this.selections[e.id];return t||(t={start:0,end:0,color:e.id},this.selections[e.id]=t),t}snapshotFrom(e,t,s){return{type:"snapshot",user:t,content:{runs:e.runs,selections:JSON.parse(JSON.stringify(e.selections))},timezone:s}}undoEvent(i,s,r){var a=s.queue,o=i.user;var n=function findLast(t,s){for(let e=t.length-1;0<=e;e--)if(t[e].user.id===s.user.id&&t[e].timezone===i.timezone&&"snapshot"!==t[e].type)return e;return-1}(a,i);if(!(n<0)){let e=a[n];var l=function findSnapshot(e,t){for(;0<=t;t--)if("snapshot"===e[t].type)return t;return-1}(a,n);if(!(l<0)){var h=a[l].content;r.load(h.runs),r.setSelections(h.selections);let t=[];for(let e=0;e<=l;e++)t.push(a[e]);for(let e=l+1;e<n;e++)r.doEvent(a[e]),t.push(a[e]);for(let e=n+1;e<a.length;e++)"snapshot"!==a[e].type&&(r.doEvent(a[e]),t.push(a[e]));s.timezone++,e.timezone=s.timezone,s.undoStacks[o.id]||(s.undoStacks[o.id]=[]),s.undoStacks[o.id].push(e),s.selections=r.getSelections(),s.runs=r.save(),s.queue=t}}return s.timezone}receiveEditEvents(e,s,t){let i=s.queue;var r,a=e[0].user;if(s.timezone%10==0&&i.push(this.snapshotFrom(s,a,s.timezone)),s.timezone++,0<i.length&&i[i.length-1].timezone>e[0].timezone+60)return[s.timezone,!1];let o=[],n={...s.selections},l=function findFirst(t,s){if(0!==t.length){if(t[i.length-1].timezone<s.timezone)return t.length;for(let e=t.length-1;0<=e;e--)if(t[e].timezone<s.timezone)return e+1}return 0}(i,e[0]);e.forEach(e=>{let t=e;if(0<=l)for(let e=l;e<i.length;e++)t=function transform(e,t){if("select"===e.type){if("insert"===t.type)return t.pos<=e.start?{...e,start:e.start+t.length,end:e.end+t.length}:e.start<=t.pos&&t.pos<=e.end?{...e,end:e.end+t.length}:e;if("delete"===t.type){if(e.end<=t.start)return e;if(t.start<=e.start&&e.end<=t.end)return{...e,start:t.start,end:t.start};if(t.end<=e.start)return e;if(e.start<=t.start&&e.end<t.end)return{...e,end:t.start};if(t.start<=e.start&&t.end<e.end)return{...e,start:t.start,end:e.end-t.end}}if("select"===t.type)return e}return e}(t,i[e]);t.timezone=s.timezone,o.push(t)}),i.push(...o),l=i.findIndex(e=>e.timezone>s.timezone-60);for(let e=i.length-1;0<=e;e--){var h=i[e];delete n[h.user.id]}for(r in n)delete s.selections[r],delete s.undoStacks[r];i.splice(0,l),t.setSelections(s.selections);let d=!1;return o.forEach(e=>{d=d||"insert"===e.type||"delete"===e.type,t.doEvent(e)}),s.runs=t.save(),s.selections=t.getSelections(),[s.timezone,d]}}class Warota{constructor(e,t){this.doc=t||new Doc,this._width=0,e.margins?this.margins=e.margins:this.margins=e.margins={left:0,top:0,right:0,bottom:0},this.options=e,this.scrollLeft=0,this.scrollTop=0,this.relativeScrollBarWidth=.02,this.showsScrollbar=e.showScrollBar,this.isScrollable=!0,this.resize(e.width,e.height),this.resizeToNumLinesOrFontSize(e),this.events=[],this.timezone=0}resetEvents(){this.events=[]}width(e){return void 0===e?this._width:(this._width=e,null)}setTimezone(e){this.timezone=e}resize(e,t){this.screenWidth=e,this.screenHeight=t}resizeToNumLinesOrFontSize(e){this.defaultMeasurer=new Measurer;var t=this.defaultMeasurer.lineHeight(e.font,e.fontSize),s=e.margins.top+e.margins.bottom,i=e.height-s,i=(e.fontSize?e.numLines=i/e.fontSize:(e.numLines||(e.numLines=10),e.fontSize=i/e.numLines),e.numLines*t),i=i+s*(e.fontSize/t),s=(this.pixelY=i)/this.screenHeight;this.pixelX=this.screenWidth*s,this.pixelX*this.relativeScrollBarWidth<=30&&(this.relativeScrollBarWidth=30/this.pixelX),this.width(this.pixelX*(1-(this.showsScrollbar?this.relativeScrollBarWidth:0))),this.lineHeight=t}resetMeasurer(){this.defaultMeasurer=new Measurer}layout(){(void 0===this.lastFontLoadedTimeChecked||this.lastFontLoadedTimeChecked<h)&&(this.resetMeasurer(),this.lastFontLoadedTimeChecked=h);var e=this.options||{},t=e.singleLine?Number.MAX_VALUE:this._width,s=this.margins.left+this.margins.right,i=this.margins.top+this.margins.bottom,[t,r]=(new Wrap).wrap(this.doc.runs,t,this.defaultMeasurer,this.doc.defaultFont,this.doc.defaultSize,this.options.margins);this.lines=t,this.words=r,this.hasLastEnter=!1,0<=this.lines.length-2&&(r=(r=this.lines[this.lines.length-2])[r.length-1],this.hasLastEnter=isNewline(r.text));let a;a=e.singleLine?t[0][t[0].length-1]:t[t.length-1][0],e.autoResize&&(this.newWidth=a.left+a.width+s,this.newHeight=a.top+a.height+i),this.docHeight=a.top+a.height}visibleBounds(){var e=this.docHeight;return{left:this.scrollLeft*this.pixelX,top:this.scrollTop*e,width:this.pixelX,height:this.pixelY}}visibleTextBounds(){var e=this.visibleBounds(),t=e.width*(1-(this.showsScrollbar?this.relativeScrollBarWidth:0)),s=e.height;return{l:e.left,t:e.top,w:t,h:e.height,b:e.top+s,r:e.left+t}}draw(i,e){let{left:t,top:r,width:a,height:o}=e;this.words.forEach(s=>{if(!(s.left+s.width<t||s.top>r+o||s.top+s.height<r||s.left>t+a))if(s.styles){let t=s.left;s.styles.forEach(e=>{i.fillStyle=e.style||{color:"black"},i.fillText(s.text.slice(e.start,e.end),t,s.top+s.ascent),t+=e.width})}else i.fillStyle=s.style||"black",i.fillText(s.text,s.left,s.top+s.ascent)})}drawSelections(t){for(var s in t.save(),this.doc.selections){s=this.doc.selections[s];if(s.end===s.start){t.fillStyle="barSelection "+s.color;var e=this.barRect(s);t.fillRect(e.left,e.top,e.width,e.height)}else{t.fillStyle="boxSelection "+s.color;let e=this.selectionRects(s);e.forEach(e=>{t.fillRect(e.left,e.top,e.width,e.height)})}}t.restore()}drawScrollbar(e){var{l:t,t:s,h:i,w:r}=this.scrollbarBounds();e.save(),e.fillStyle="scrollBar",e.fillRect(t,0,r,this.pixelY),e.fillStyle="scrollKnob",e.fillRect(t+3,s,r-6,i),e.restore()}scrollbarBounds(){var{pixelX:e,pixelY:t,scrollTop:s,relativeScrollBarWidth:i}=this,r=t/this.docHeight,i=e*(this.showsScrollbar?i:0);return{l:e-i,t:s*t,w:i,h:1<r?t-3:Math.max(t/100*5,t*r-6)}}scrollBy(e,t){this.setScroll(this.scrollLeft=e,this.scrollTop+t)}setScroll(e,t){var{pixelY:s,docHeight:i}=this;this.scrollTop=Math.max(0,Math.min(1-s/i,t))}findLine(s,e,i){let t=this.lines;if(void 0!==e&&void 0!==i){let e=t.findIndex(e=>{var t=e.reduce((e,t)=>Math.max(e,t.height),0),e=e[0];return e.top<=i&&i<e.top+t});return e<0&&(e=t.length-1),[t[e],e]}let r=t.findIndex(e=>{var t=e[0],e=e[e.length-1];return t.start<=s&&s<e.end});return r<0&&(r=t.length-1),[t[r],r]}findWord(s,i,r){if(void 0!==i&&void 0!==r){let[e]=this.findLine(s,i,r),t=e.findIndex(e=>e.left<=i&&i<e.left+e.width);return t<0&&(t=i<e[0].left?0:e.length-1),e[t]}let[e]=this.findLine(s,i,r),t=e.findIndex(e=>e.start<=s&&s<e.end);return t<0&&(t=i<e[0].left?0:e.length-1),e[t]}insert(e,t){e=Event.insert(e,t,this.timezone);this.events.push(e)}delete(e,t){e=Event.delete(e,t,this.timezone);this.events.push(e)}select(e,t,s,i){e=Event.select(e,t,s,i,this.timezone);this.lastSelect={start:t,end:s},this.events.push(e)}setStyle(e,t,s){e=Event.setStyle(e,t,s);this.events.push(e)}doEvent(e){this.doc.doEvent(e),this.layout()}positionFromIndex(e){let t=this.findWord(e);if(0===e&&t.text===v)return{left:0+((s=this.margins||{}).left||0),top:0+(s.top||0),width:0,height:t.height};var s=e-t.start;let i={...t};i.text=t.text.slice(0,s);e=this.defaultMeasurer.measureText(i,this.doc.defaultFont,this.doc.defaultSize),i.text=t.text.slice(0,1+s),s=this.defaultMeasurer.measureText(i,this.doc.defaultFont,this.doc.defaultSize);return{left:t.left+e.width,top:t.top,width:s.width-e.width,height:t.height}}indexFromPosition(e,t){let s=this.findWord(null,e,t),i=0;var r=e-s.left;if(r<0)return s.start;if(s.text===v)return s.start;if(isNewline(s.text))return s.start;let a={...s};for(let e=0;e<=s.text.length;e++){a.text=s.text.slice(0,0!==e?e:1);var o,n=((o=this.defaultMeasurer.measureText(a,this.doc.defaultFont,this.doc.defaultSize)).width-i)/2;if(i<=r&&r<i+n)return s.start+(0===e?0:e-1);if(i+n<=r&&r<o.width)return s.start+e;i=o.width}return s.end}isBol(e,t){var[t]=this.findLine(null,e,t);let s=t[0];if(e<s.left)return!0;if(s.text===v)return this.hasLastEnter;let i={...s};i.text=s.text.slice(0,1);t=this.defaultMeasurer.measureText(i,this.doc.defaultFont,this.doc.defaultSize).width/2;return e-s.left<t}changeLine(e,t,s){var[,i]=this.findLine(t);if(0<s&&i===this.lines.length-2)return this.hasLastEnter?this.lines[this.lines.length-1][0].start:t;t=this.positionFromIndex(t),i+=s;if(i<0)return 0;if(i>=this.lines.length)return this.lines[this.lines.length-1][0].start;s=this.lines[i];return 1!==s.length||1!==s[0].text.length||"\n"!==s[0].text&&"\r"!==s[0].text?this.indexFromPosition(t.left,s[0].top):s[0].start}lineHeightAt(e){if(0===this.doc.length())return this.defaultMeasurer.measureText({text:"x"},this.doc.defaultFont,this.doc.defaultSize).height;let[t]=this.findLine(e);return t.reduce((e,t)=>Math.max(t.height,e),0)}barRect(e){let t=e.start;if(0===t)return s=this.positionFromIndex(t),i=this.lineHeightAt(t),{left:s.left-1,top:s.top,width:2,height:i};if(t===this.doc.length()){if(e.isBol)return s=this.positionFromIndex(t),i=this.lineHeightAt(t),{left:s.left-1,top:s.top,width:2,height:i};var[s]=this.findLine(t-1),i=(t=s[s.length-1].end-1,this.positionFromIndex(t)),s=this.lineHeightAt(t);return{left:i.left+i.width-1,top:i.top,width:2,height:s}}i=this.positionFromIndex(t),s=this.lineHeightAt(t);return e.isBol,{left:i.left-1,top:i.top,width:2,height:s}}selectionRects(e){let{start:t,end:s}=e;var[e,i]=this.findLine(t);let[r,a]=this.findLine(s);if(void 0===e||void 0===r)return[];if(i===a)return e=this.positionFromIndex(t),l=this.positionFromIndex(s),h=this.lineHeightAt(t),[{left:e.left,top:e.top,width:l.left-e.left,height:h}];let o=[],n=this.positionFromIndex(t);var l=this.lineHeightAt(t),h=(s!==this.doc.length()||isNewline((e=this.findWord(s-1)).text[e.length-1])&&(s--,[h,e]=this.findLine(s),r=h,a=e),this.options.margins.right+this.options.margins.left),e=this.positionFromIndex(s);this.lineHeightAt(s);return o.push({left:n.left,top:n.top,width:this.width()-n.left-h,height:l}),2<=a-i&&(n=this.lines[i+1][0],o.push({left:this.options.margins.left,top:n.top,width:this.width()-h,height:e.top-n.top})),n=this.lines[a][0],l=this.lineHeightAt(s),o.push({left:this.options.margins.left,top:e.top,width:e.left-this.options.margins.left,height:l}),o}isScrollbarClick(e,t){if(!this.showsScrollbar)return!1;var s=this.relativeScrollBarWidth*this.pixelX;return this.pixelX-s-3<=e}mouseDown(e,t,s,i){this.isScrollbarClick(e,t)?this.scrollBarClick={type:"clicked",scrollBarVOffset:t-this.scrollbarBounds().t,scrollBarTopOnDown:this.scrollTop,realStartY:s,startX:e,startY:t}:(s=this.indexFromPosition(e,t),e=this.isBol(e,t),this.extendingSelection=null,this.selectDragStart=s,this.select(i,s,s,e)),this.keyboardX=null}mouseMove(s,i,e,r){if(null===this.selectDragStart)return this.scrollBarClick?({realStartY:a,scrollBarTopOnDown:t}=this.scrollBarClick,o=this.docHeight,e=(e-a)*Math.max(1,o/this.pixelY)/o+t,this.scrollBarClick.type="move",this.setScroll(0,e),"scrollChanged"):null;var t;{var a=this.indexFromPosition(s,i);let e,t;if(a||0===a){this.focusChar=a,t=this.selectDragStart>a?(this.extendingSelection="top",e=a,this.selectDragStart):(this.extendingSelection="bottom",e=this.selectDragStart,a);var o=this.lastSelect;if(o&&(o.start!==e||o.end!==t))return this.select(r,e,t),"selectionChanged"}return null}}mouseUp(e,t,s,i){this.scrollBarClick?(this.scrollBarClick.type,this.scrollBarClick=null,this.wasScrollBarClick=!0):this.wasScrollBarClick=!1,this.selectDragStart=null,this.keyboardX=null,this.lastSelect=null}backspace(e){this.delete(e,!0)}handleKey(e,t,s,i){let{start:r,end:a,isBol:o}=this.doc.selections[e.id]||{start:0,end:0,color:e.color};var n=this.doc.length();let l=!1,h,d;if(s){if(!this.keyboardSelect)switch(t){case 37:case 38:case 36:case 33:this.keyboardSelect=-1;break;case 39:case 40:case 35:case 34:this.keyboardSelect=1}}else this.keyboardSelect=0;let c=1===this.keyboardSelect?a:r;var u,p,f=c;let m,y=!1;switch(t){case 37:s||r===a?0<c&&c--:c=r,o=!1,y=!0;break;case 39:s||r===a?c<n&&([g,v]=this.findLine(c),h=g,d=v,c++):c=a,y=!0;break;case 40:var[g,v]=this.findLine(c);h=g,d=v,c=this.changeLine(e,c,1),m=f===c,y=!0;break;case 38:c=this.changeLine(e,c,-1),o=!1,y=!0;break;case 8:case 46:this.backspace(e),l=!0}if(y){switch(this.keyboardSelect){case 0:r=a=c;break;case-1:r=c;break;case 1:a=c}r===a&&(this.keyboardSelect=0),r>a&&(this.keyboardSelect=-this.keyboardSelect,p=a,a=r,r=p),h&&([u,p]=this.findLine(c),o=d!==p&&this.hasLastEnter||m),this.select(e,r,a,o),l=!0}return i&&65===t&&(this.select(e,0,n),window.editor=this,l=!0),l}selectionText(e){e=this.doc.selections[e.id];return e?this.doc.plainText(e.start,e.end):""}}class Event{static insert(e,t,s){return{type:"insert",user:e,runs:t,length:runLength(t),timezone:s}}static delete(e,t,s){return{type:"delete",backspace:t,user:e,timezone:s}}static select(e,t,s,i,r){return{type:"select",user:e,start:t,end:s,isBol:i,timezone:r}}static setStyle(e,t,s){return{type:"setStyle",user:e,style:t,merge:s}}}const d=new((0,c.y7)(g.THREE))({font:a});class KeyFocusManager extends e.ViewService{constructor(e){super(e||"KeyFocusManager"),this.setKeyboardInput(null),this.hiddenInput=document.querySelector("#hiddenInput"),this.copyElement=document.querySelector("#copyElement"),this.hiddenInput||(this.hiddenInput=document.createElement("input"),this.hiddenInput.id="hiddenInput",this.hiddenInput.style.setProperty("position","absolute"),this.hiddenInput.style.setProperty("left","-120px"),this.hiddenInput.style.setProperty("top","-120px"),this.hiddenInput.style.setProperty("transform","scale(0)"),this.hiddenInput.style.setProperty("width","100px"),this.hiddenInput.style.setProperty("height","100px"),document.body.appendChild(this.hiddenInput),this.hiddenInput.addEventListener("input",e=>{e.stopPropagation(),this.keyboardInput&&this.keyboardInput.input(e)},!0),this.hiddenInput.addEventListener("keydown",e=>{e.stopPropagation(),this.keyboardInput&&this.keyboardInput.keyDown(e)},!0),this.hiddenInput.addEventListener("copy",e=>{this.keyboardInput&&this.keyboardInput.copy(e)}),this.hiddenInput.addEventListener("paste",e=>{this.keyboardInput&&this.keyboardInput.paste(e)})),this.copyElement||(this.copyElement=document.createElement("input"),this.copyElement.id="copyElement",this.copyElement.style.setProperty("position","absolute"),this.copyElement.style.setProperty("left","-120px"),this.copyElement.style.setProperty("top","-120px"),this.copyElement.style.setProperty("transform","scale(0)"),this.copyElement.style.setProperty("width","100px"),this.copyElement.style.setProperty("height","100px"),document.body.appendChild(this.copyElement))}setKeyboardInput(e){this.hiddenInput&&!e&&this.hiddenInput.blur(),(this.keyboardInput=e)&&this.hiddenInput.focus()}destroy(){this.keyboardInput=null,this.hiddenInput=document.querySelector("#hiddenInput"),this.hiddenInput&&this.hiddenInput.remove(),super.destroy()}}class SyncedStateManager extends e.ViewService{constructor(e){super(e||"SyncedStateManager"),this.isSynced=!1,this.subscribe(this.viewId,"synced","synced")}synced(e){console.log("synced manager",e),this.isSynced=e}}class FontModelManager extends e.ModelService{static defaultFont(){return"Roboto"}init(e){super.init(e||"FontModelManager"),this.fonts=new Map;var{chars:e,common:t,info:s,kernings:i,pages:r}=a;this.askFont({name:s.face,font:{chars:e,common:t,info:s,kernings:i,pages:r}}),this.subscribe(this.id,"askFont",this.askFont),this.loading=new Map,this.subscribe(this.id,"fontLoadStart","fontLoadStart"),this.subscribe(this.id,"fontLoadOne","fontLoadOne"),this.subscribe(this.id,"fontLoadDone","fontLoadDone")}get(e){return this.fonts.get(e)}keys(){return this.fonts.keys()}askFont(e){e.font&&this.fonts.set(e.name,e.font),this.publish(this.id,"fontAsked",e.name)}fontLoadStart({key:e,name:t}){this.loading.set(e,{name:t,array:[]})}fontLoadOne({key:e,buf:t}){let s=this.loading.get(e);s?s.array.push(t):console.log("inconsistent message")}fontLoadDone(e){var r=this.loading.get(e);if(r){let t=r.array;var a=t.reduce((e,t)=>e+t.length,0);let s=new Uint8Array(a),i=0;for(let e=0;e<t.length;e++)s.set(t[e],i),i+=t[e].length;a=new TextDecoder("utf-8").decode(s),a=JSON.parse(a);this.askFont({name:r.name,font:a}),this.loading.delete(e)}else console.log("inconsistent message")}}FontModelManager.register("FontModelManager");class FontViewManager extends e.ViewService{constructor(e,t){super(t||"FontViewManager"),this.fonts=new Map,this.isLoading={},this.fudgeFactors=new Map,this.fudgeFactors.set("Roboto",{yoffset:30})}setModel(e){this.model=e;for(var[t,s]of this.model.fonts.entries())this.askFont(t,s)}get(e){return this.fonts.get(e)}askFont(d,t){if(this.fonts.get(d))return Promise.resolve(this.fonts.get(d));if(!this.isLoading[d]){let e="./assets/fonts",s=e+`/${d}.png`;this.isLoading[d]=t?Promise.resolve(t):new Promise((s,i)=>{r()(e+`/${d}.json`,(e,t)=>{e&&i(e),s(t)})}),this.isLoading[d]=this.isLoading[d].then(h=>{let t=new g.THREE.TextureLoader;return new Promise((l,e)=>{t.load(s,e=>{let t=new c.sP;var s=h.common?h.common.scaleW:h.atlas.width,i=h.common?h.common.scaleH:h.atlas.height;let r=new Image(s,i),a=document.createElement("canvas"),o=(a.width=s,a.height=i,a.getContext("2d"));o.drawImage(e.image,0,0);s=o.getImageData(0,0,a.width,a.height),i=t.process(h,s.data);o.putImageData(i,0,0);let n=new g.THREE.Texture(i);n.minFilter=g.THREE.LinearMipMapLinearFilter,n.magFilter=g.THREE.LinearFilter,n.generateMipmaps=!0,n.anisotropy=1,r.src=a.toDataURL("image/png"),r.onload=()=>{n.needsUpdate=!0},this.fonts.set(d,{font:h,texture:n}),delete this.isLoading[d],(this.model.fonts.get(d)?null:h)?this.sendLargeFont(d,h):this.publish(this.model.id,"askFont",{name:d}),l(this.fonts.get(d))},null,()=>{this.isLoading[d]=!1,e(new Error("failed to load font: "+d))})})})}return this.isLoading[d]}sendLargeFont(e,t){t=JSON.stringify(t);let s=(new TextEncoder).encode(t),i=0;var r=Math.random();for(this.publish(this.model.id,"fontLoadStart",{key:r,name:e});i<s.length;){var a=s.slice(i,i+2880);this.publish(this.model.id,"fontLoadOne",{key:r,buf:a}),i+=2880}this.publish(this.model.id,"fontLoadDone",r)}destroy(){this.fonts.forEach((e,t)=>{e.material&&(e.material.dispose(),e.material=null)})}}class TextFieldActor extends s.Z4{init(e){this.fonts=this.service("FontModelManager"),this.doc=new Doc({defaultFont:this.fonts.constructor.defaultFont(),defaultSize:10}),this.doc.load(e.runs||[]),this.content={runs:[],selections:{},undoStacks:{},timezone:0,queue:[],editable:!0},e.textScale||(e.textScale=.0025),super.init(e),this.subscribe(this.id,"load","loadAndReset"),this.subscribe(this.id,"editEvents","receiveEditEvents"),this.subscribe(this.id,"accept","publishAccept"),this.subscribe(this.id,"undoRequest","undoRequest"),this.subscribe(this.id,"setExtent","setExtent"),this.subscribe(this.sessionId,"view-exit","viewExit"),this.listen("dismiss","dismiss");var t=e.width/e.textScale,s=e.height/e.textScale;this.setExtent({width:t,height:s}),this.depth=e.depth||0,e.noDismissButton||this.setupDismissButton(),e.readOnly&&(s=((t=e.margins)&&void 0!==t.left?t.left:0)+(t&&void 0!==t.right?t.right:0),t=d.measureText(this.value),this.measurement={width:(t.width+s)*e.textScale,height:t.height*e.textScale})}get pawn(){return TextFieldPawn}static types(){return{"Warota.Doc":Doc}}load(e){let t;t="string"==typeof e?[{text:e}]:e,this.doc.load(t),this.publishChanged(),this.needsUpdate()}save(){return{runs:this.doc.runs,defaultFont:this.doc.defaultFont,defaultSize:this.doc.defaultSize}}setExtent(e){this.extent=e}loadAndReset(e){let t;t="string"==typeof e?[{text:e}]:e,this.content={runs:t,selections:{},undoStacks:{},timezone:0,queue:[],editable:!0},this.doc.load(t),this.publishAccept(),this.needsUpdate()}receiveEditEvents(e){var[,e]=this.doc.receiveEditEvents(e,this.content,this.doc);e&&this.publishChanged(),this.needsUpdate()}publishAccept(){this.publish(this.id,"text",{id:this.id,text:this.doc.plainText()})}publishChanged(){this.publish(this.id,"changed",{id:this.id})}viewExit(e){delete this.content.selections[e],this.needsUpdate()}needsUpdate(){this.say("screenUpdate",this.content.timezone)}undoRequest(t){let s;var i=this.content.queue;for(let e=i.length-1;0<=e;e--){var r=i[e];if(r.user.id===t.id&&"snapshot"!==r.type&&"select"!==r.type){s=i[e];break}}s&&(this.doc.undoEvent(s,this.content,this.doc),this.needsUpdate())}setDefault(e,t){return this.doc.setDefault(e,t)}styleAt(e){return this.doc.styleAt(e)}updateOptions(e){super.updateOptions(e);var t=e.width/e.textScale,s=e.height/e.textScale;this.setExtent({width:t,height:s}),this.dismissButton&&this.dismissButton.destroy(),e.noDismissButton||this.setupDismissButton()}get value(){return this.doc.plainText()}set value(e){return this.load(e)}setupDismissButton(){this.dismissButton=DismissButtonActor.create({type:"object",backgroundColor:this._cardData.backgroundColor,parent:this,translation:this.dismissButtonPosition(),noSave:!0,color:2236962}),this.subscribe(this.dismissButton.id,"dismiss","dismiss")}dismissButtonPosition(){return[this._cardData.width/2-.072,this._cardData.height/2-.072,.06]}dismiss(){this.destroy()}}TextFieldActor.register("TextFieldActor");class TextFieldPawn extends s.Df{constructor(e){super(e),this.addToLayers("pointer"),this.widgets={},this.setupEditor(),this.setupMesh(),this.fonts=this.service("FontViewManager"),this.listen("fontAsked","fontAsked"),this.listen("screenUpdate","screenUpdate"),this.setupFonts(),this.actor._cardData.readOnly||(this.addEventListener("pointerDown","onPointerDown"),this.addEventListener("pointerMove","onPointerMove"),this.addEventListener("pointerUp","onPointerUp"),this.addEventListener("keyDown","keyDown")),this.listen("cardDataSet","cardDataUpdated")}destroy(){["geometry","material","textGeometry","textMaterial"].forEach(e=>{this[e]&&this[e].dispose(),this[e]=null}),super.destroy()}textScale(){return this.actor._cardData.textScale}test(){}needsUpdate(){this.screenUpdate(this.warota.timezone)}randomColor(e){return`hsl(${Math.floor(parseInt(e,36)/(36**10/360))}, 40%, 40%)`}cardDataUpdated(e){var t,s,i;e.o.backgroundColor===e.v.backgroundColor&&e.o.frameColor===e.v.frameColor&&e.o.fullBright===e.v.fullBright||({depth:e,backgroundColor:t,frameColor:s,fullBright:i}=e.v,this.material=this.makePlaneMaterial(e,t,s,i),this.plane.material=this.material)}changeMaterial(e,t){this.textMaterial&&this.textMaterial.dispose();let s;if(this.fonts.get(e))return e=this.fonts.get(e).texture,this.textMaterial=new g.THREE.RawShaderMaterial((0,c.N8)({map:e,textureSize:e.image.width,side:g.THREE.BackSide,transparent:!0},g.THREE)),t&&((s=new g.THREE.Mesh(this.textGeometry,this.textMaterial)).name="text"),s}setupFonts(){var e=this.actor.doc.defaultFont;this.fontAsked(e).then(()=>{let e=Array.from(this.actor.fonts.keys());var t=e.map(e=>this.fonts.askFont(e));return Promise.all(t)}).then(()=>{this.warota.resetMeasurer(),this.needsUpdate()})}setupTextMesh(t,s,i){if(!this.textGeometry){let e=(0,c.aB)(g.THREE);this.textGeometry=new e({defaultColor:new g.THREE.Color(i)}),this.textMesh=this.changeMaterial(t,!0),this.plane.add(this.textMesh)}if(!o.hasLayout(t)){let e=(0,c.y7)(g.THREE);i=new e({font:s}),o.addLayout(t,i)}}setupScrollMesh(){var e=new g.THREE.PlaneGeometry(.1,5),t=new g.THREE.MeshBasicMaterial({color:16711680,side:g.THREE.DoubleSide}),e=(this.scrollMesh=new g.THREE.Mesh(e,t),this.scrollMesh.name="scroll",this.scrollMesh.position.set(2.5,0,.001),new g.THREE.PlaneGeometry(.1,.1)),t=new g.THREE.MeshBasicMaterial({color:65280,side:g.THREE.DoubleSide});this.scrollKnobMesh=new g.THREE.Mesh(e,t),this.scrollKnobMesh.name="scrollKnob",this.scrollKnobMesh.position.set(0,2.5,.001),this.scrollMesh.add(this.scrollKnobMesh),this.plane.add(this.scrollMesh)}updateMesh(t){var{fontName:t,drawnStrings:s}=t;if(this.fonts.get(t)){var i=this.fonts.get(t).font,r=this.fonts.fudgeFactors.get(t);let e=o.hasLayout(t);e&&(t=e.computeGlyphs({font:i,drawnStrings:s,fudgeFactor:r}),this.textMesh.scale.x=this.textScale(),this.textMesh.scale.y=-this.textScale(),this.textGeometry.update({font:i,glyphs:t}))}}updateShape(e){super.updateShape(e),["geometry","material","textGeometry","textMaterial"].forEach(e=>{this[e]&&this[e].dispose(),this[e]=null}),this.setupMesh(),this.setupFonts()}setupMesh(){let e=this.actor._cardData.depth,t=(void 0===e&&(e=.01),this.actor._cardData.cornerRadius),{backgroundColor:s,frameColor:i,fullBright:r}=(void 0===t&&(t=.05),this.actor._cardData);s=s||16777215,i=i||6710886,void 0===r&&(r=!1),0===e?this.geometry=new g.THREE.PlaneGeometry(0,0):this.geometry=this.roundedCornerGeometry(0,0,e,t);var a=this.makePlaneMaterial(e,s,i,r);this.material=a,this.plane=new g.THREE.Mesh(this.geometry,this.material),this.plane.castShadow=!0,this.plane.name=this.actor.name,this.shape.add(this.plane),this.clippingPlanes=[new g.THREE.Plane(new g.THREE.Vector3(0,1,0),0),new g.THREE.Plane(new g.THREE.Vector3(0,-1,0),0),new g.THREE.Plane(new g.THREE.Vector3(-1,0,0),0),new g.THREE.Plane(new g.THREE.Vector3(1,0,0),0)]}setupEditor(){var e=this.actor.doc.defaultFont,t=this.actor.doc.defaultSize,s=this.actor.extent,i=this.actor._cardData.autoResize,r=this.actor._cardData.singleLine,a=this.actor._cardData.margins,e={width:s.width,height:s.height,font:e,fontSize:t,autoResize:i,singleLine:r,margins:a};this.warota=new Warota(e,this.actor.doc),this.warota.width(s.width),this.options=e,this.user={id:this.viewId,color:this.randomColor(this.viewId)},this.selections={},this.subscribe(this.viewId,"synced","synced")}fontAsked(t){return this.fonts.askFont(t).then(e=>this.setupTextMesh(t,e.font,this.actor._cardData.color||0)).then(()=>(this.warota.resetMeasurer(),this.screenUpdate(this.warota.timezone)))}computeClippingPlanes(t){let s=[];var i=this.plane;if(Number.isNaN(i.matrixWorld.elements[0]))return[];for(let e=0;e<4;e++)s[e]=new g.THREE.Plane,s[e].copy(this.clippingPlanes[e]),s[e].constant=t[e],s[e].applyMatrix4(i.matrixWorld);return s}setWidth(e){this.publish(this.actor.id,"setWidth",e),this.width(e)}width(e){this.warota.width(e),this.screenUpdate(this.warota.timezone)}synced(e){this.isSynced=e,this.isSynced&&(this.warota.resetMeasurer(),this.screenUpdate(this.warota.timezone))}getSynced(){var e=this.service("SyncedStateManager");return(e||this).isSynced}accept(){this.publish(this.actor.id,"accept")}cookEvent(t){if(t.xyz){let e=new g.THREE.Vector3(...t.xyz);var t=this.renderObject.matrixWorld.clone().invert(),t=e.applyMatrix4(t),s=this.plane.geometry.parameters.width,i=this.plane.geometry.parameters.height;return{x:(s/2+t.x)/this.textScale(),y:(i/2-t.y)/this.textScale()}}}onPointerDown(t){if(!this.actor._cardData.readOnly){let e=this.service("KeyFocusManager");e.setKeyboardInput(this);t=this.cookEvent(t);t&&this.warota.mouseDown(t.x,t.y,t.y,this.user)}}onPointerMove(e){this.actor._cardData.readOnly||(e=this.cookEvent(e))&&(this.warota.mouseMove(Math.max(e.x,0),e.y,e.y,this.user),this.changed())}onPointerUp(e){this.actor._cardData.readOnly||(e=this.cookEvent(e))&&(this.warota.mouseUp(e.x,e.y,e.y,this.user),this.changed())}newCanonicalizeEvent(t){if("input"!==t.type||"insertText"!==t.inputType||t.isComposing)return null;{let e=this.service("KeyFocusManager");var s=e.hiddenInput.value;return{keyCombo:e.hiddenInput.value="",key:s,shiftKey:!1,altKey:!1,ctrlKey:!1,metaKey:!1,altGraphKey:!1,isFunctionKey:!1,isModified:!1,onlyModifiers:!1,onlyShiftModifier:null,type:t.type,keyCode:t.keyCode}}}eventFromField(){let e=this.service("KeyFocusManager");var t=e.hiddenInput.value;return{keyCombo:e.hiddenInput.value="",key:t,shiftKey:!1,altKey:!1,ctrlKey:!1,metaKey:!1,altGraphKey:!1,isFunctionKey:!1,isModified:!1,onlyModifiers:!1,onlyShiftModifier:null,type:"",keyCode:0}}simpleInput(e,t){var s=this.user,i=this.actor.content.selections[this.viewId],i=this.actor.styleAt(Math.max(i?i.start-1:0,0));return this.warota.insert(s,[{text:e,style:i}]),this.changed(!0),t.preventDefault(),!0}input(e){if(!this.actor._cardData.readOnly){var t=this.newCanonicalizeEvent(e);if(!t)return!1;var s=this.user,i=this.actor.content.selections[this.viewId],i=this.actor.styleAt(Math.max(i?i.start-1:0,0));return this.warota.insert(s,[{text:t.key,style:i}]),this.changed(!0),e.preventDefault(),!0}}keyDown(t){let s;if("Enter"===t.key){let e=this.service("KeyFocusManager").hiddenInput;s=""!==e.value?(e.value="",this.eventFromField()):canonicalizeKeyboardEvent(t)}else s=canonicalizeKeyboardEvent(t);var e=this.user;if(!s)return!0;if(s.onlyModifiers)return!0;if(["Meta-S","Ctrl-S","Alt-S"].includes(s.keyCombo))return this.accept(),t.preventDefault(),!0;if(["Meta-Z","Ctrl-Z","Alt-Z"].includes(s.keyCombo))return this.undo(),t.preventDefault(),!0;if(["Meta-C","Ctrl-C","Alt-C"].includes(s.keyCombo))return this.copy(),t.preventDefault(),!0;if(["Meta-X","Ctrl-X","Alt-X"].includes(s.keyCombo))return this.cut(),t.preventDefault(),!0;if(["Meta-V","Ctrl-V","Alt-V"].includes(s.keyCombo))return this.paste(),t.preventDefault(),!0;if(13===s.keyCode)return this.actor.enterToAccept?(t.preventDefault(),this.accept(),!0):this.simpleInput("\n",t);if(32===s.keyCode)return this.simpleInput(" ",t);if(9===s.keyCode)return this.simpleInput("\t",t);var i=this.warota.handleKey(e,s.keyCode,s.shiftKey,s.ctrlKey||s.metaKey);return i||s.ctrlKey||s.metaKey?(i&&(t.preventDefault(),this.changed(!0)),!1):(this.warota.insert(e,[{text:s.key}]),this.changed(!0),t.preventDefault(),!0)}copy(e){let i=navigator.userAgent.match(/ipad|iphone/i),r=this.warota.selectionText(this.user);(navigator.clipboard?navigator.clipboard.writeText(r).then(()=>!0,()=>!1):Promise.resolve(!1)).then(e=>{if(!e){let e=this.service("KeyFocusManager")["copyElement"];if(!i)return e.value=r,e.select(),e.setSelectionRange(0,99999),void document.execCommand("copy");let t=document.createRange(),s=(t.selectNodeContents(e),e.textContent=r,window.getSelection());s.removeAllRanges(),s.addRange(t),e.setSelectionRange(0,1e5),document.execCommand("copy")}})}cut(e){return this.copy(e),this.warota.insert(this.user,[{text:""}]),this.changed(!0),!0}paste(e){return(navigator.clipboard?navigator.clipboard.readText().then(e=>e,()=>null):Promise.resolve(null)).then(e=>{if(null!==e)return e;{let e=this.service("KeyFocusManager")["copyElement"];return e.focus(),e.textContent="",document.execCommand("paste"),e.textContent}}).then(e=>{this.warota.insert(this.user,[{text:e}]),this.changed(!0)})}undo(){this.publish(this.actor.id,"undoRequest",this.user)}changed(e){var t=this.warota.events;this.warota.resetEvents(),0<t.length&&(this.scrollNeeded=!this.singleLine&&e,this.publish(this.actor.id,"editEvents",t))}screenUpdate(e){this.warota.timezone=e,this.getSynced()&&(this.warota.layout(),this.showText(),this.setExtent(),this.showSelections(),this.scrollNeeded&&(this.scrollNeeded=!1,this.scrollSelectionToView()))}showText(){let t=[];for(let e=0;e<this.warota.words.length-1;e++){var s=this.warota.words[e],s={x:s.left,y:s.top,string:s.text,style:s.style&&s.style.color};t.push(s)}var e=this.actor.extent;this.updateMesh({fontName:this.warota.doc.defaultFont,extent:e,drawnStrings:t})}setStyle(e){this.warota.setStyle(this.user,e,!1),this.changed()}mergeStyle(e){this.warota.setStyle(this.user,e,!0),this.changed()}setExtent(){var e,t=this.actor.extent,s=this.actor.depth,i=this.actor._cardData.cornerRadius||.05,r=this.actor._cardData.autoResize;this.textMesh&&(e=(r?this.warota.newWidth:t.width)*this.textScale(),r=(r?this.warota.docHeight:t.height)*this.textScale(),e===this.plane.geometry.parameters.width&&r===this.plane.geometry.parameters.height&&s===this.plane.geometry.parameters.depth||(t=0===s?new g.THREE.PlaneGeometry(e,r):this.roundedCornerGeometry(e,r,s,i),this.plane.geometry=t,this.geometry.dispose(),this.geometry=t),this.textMesh.position.x=-e/2,this.textMesh.position.y=r/2,this.textMesh.position.z=s+.005,i={left:0,top:0,bottom:r/this.textScale(),right:e/this.textScale()},this.textMesh.material.uniforms.corners.value=new g.THREE.Vector4(i.left,i.top,i.right,i.bottom))}setTextRenderingBounds(e){this.textMesh.material.uniforms.corners.value=new g.THREE.Vector4(e.left,e.top,e.right,e.bottom)}ensureSelection(e){let t=this.selections[e];let i=this.actor.content.selections[e].color;if(i=i||"blue",!t){const r=new g.THREE.Mesh(new g.THREE.PlaneBufferGeometry(.1,.1),new g.THREE.MeshBasicMaterial({color:i}));r.onBeforeRender=this.selectionBeforeRender.bind(this),r.visible=!1,this.plane.add(r),r.name="caret";let s=[];for(let t=0;t<3;t++){let e=new g.THREE.Mesh(new g.THREE.PlaneBufferGeometry(0,0),new g.THREE.MeshBasicMaterial({color:i}));e.onBeforeRender=this.selectionBeforeRender.bind(this),e.visible=!1,e.name="box"+t,this.plane.add(e),s.push(e)}t={bar:r,boxes:s}}return this.selections[e]=t}showSelections(){var e,r=this.actor.depth||0;let t={};for(e in this.selections)t[e]=this.selections[e];var s,i,a=this.textScale();for(s in this.actor.content.selections){delete t[s];let i=this.ensureSelection(s);i.boxes.forEach(e=>e.visible=!1);var o=this.actor.content.selections[s],n=this.plane.geometry.parameters.width,l=this.plane.geometry.parameters.height;if(o.end===o.start){let e=i.bar,t=(e.visible=!0,this.warota.barRect(o));t.width=a<=.001?5:2;var h=new g.THREE.PlaneBufferGeometry(t.width*a,t.height*a);let s=e.geometry;e.geometry=h,s&&s.dispose();var h=-n/2+(t.left+6)*a,d=l/2-(t.top+t.height/2+4)*a;e.position.set(h,d,r+.001)}else{var c=this.warota.selectionRects(o),u=i.boxes;for(let t=0;t<3;t++){let e=u[t];var p,f,m,y=c[t];e.visible=!1,y&&(p=-n/2+(y.width/2+y.left+8)*a,f=l/2-(y.top+y.height/2+4)*a,m=y.width*a,y=y.height*a,m=new g.THREE.PlaneBufferGeometry(m,y,2,2),e.geometry=m,e.position.set(p,f,r+.001),e.visible=!0)}}}for(i in t)this.selections[i].bar.remove(),this.selections[i].boxes.forEach(e=>e.remove()),delete this.selections[i];this.publish(this.id,"selectionUpdated")}scrollSelectionToView(){}selectionBeforeRender(e,t,s,i,r,a){var o=this.computeClippingPlanes([2.5,2.5,2.5,2.5]);r.clippingPlanes=o}addWidget(e,t){this.widgets[e]&&this.removeWidget(e,t),this.widgets[e]=t,this.selectionPane.appendChild(t)}removeWidget(e,t){delete this.widgets[e],t.remove()}get hitNormal(){return[0,0,1]}}class DismissButtonActor extends s.Z4{init(e){super.init({...e,multiusser:!0})}get pawn(){return DismissButtonPawn}}DismissButtonActor.register("DismissButtonActor");class DismissButtonPawn extends s.Df{constructor(e){super(e),this.addToLayers("pointer"),this.back&&(this.shape.remove(this.back),this.shape.children=[]);var e=void 0!==this.actor._cardData.backgroundColor?this.actor._cardData.backgroundColor:13421772,t=void 0!==this.actor._cardData.color?this.actor._cardData.color:2236962,s=new g.THREE.BoxGeometry(.08,.08,1e-5),e=new g.THREE.MeshStandardMaterial({color:e,side:g.THREE.DoubleSide}),s=(this.back=new g.THREE.Mesh(s,e),new g.THREE.BoxGeometry(.07,.02,.001)),e=new g.THREE.MeshStandardMaterial({color:t,side:g.THREE.DoubleSide});let i=new g.THREE.Mesh(s,e);i.position.set(0,0,1e-5),this.back.add(i),this.shape.add(this.back),this.addEventListener("pointerDown","dismiss")}dismiss(e){this.publish(this.actor.id,"dismiss")}}},9087:(e,t,s)=>{"use strict";s.d(t,{m:()=>AssetManager});var i=s(3782);class AssetManager extends s(4200).ViewService{constructor(e){super(e||"AssetManager"),this.assetManager=new i.me}}},4072:(e,t,s)=>{"use strict";s.d(t,{H:()=>WorldSaver});var a=s(3654),o=s(4200);class WorldSaver{constructor(e){this.map=new Map,this.id=0,this.defaultClass=e}newId(){return(++this.id).toString().padStart(4,"0")}save(e){let t=[];for(var[s,i]of e.service("ActorManager").actors)i.isCard&&!i.noSave&&t.push(i);var r=this.topologicalSort(t),r=this.collectData(r);let a={behaviorModules:e.service("BehaviorModelManager").save(),cards:r};return o.Constants.UseRapier&&(a.useRapier=!0),a}topologicalSort(e){let t=new Map,s=[...e],i=new Map;for(;0<s.length;){var r=s.shift();if(!r._parent||t.get(r._parent.id))t.set(r.id,r);else{if(i.get(r))throw new Error("actors make a cycle");s.push(r),i.set(r,!0)}}return t}collectData(e){let t=[];for(var[s,i]of e){let e={id:this.newId()};this.map.set(i,e);i=this.collectCardData(i);e.card=i,t.push(e)}return t}collectCardData(s,i){let r={};if(s.constructor!==this.defaultClass&&(r.className=s.constructor.name),a.Wh.forEach(e=>{if(s["_"+e])if("parent"===e)if(i){var t=s[e];if(!t)throw new Error("undefined parent used");r[e]=t.id}else{t=this.map.get(s[e]);if(!t)throw new Error("undefined parent used");r[e]=t.id}else r[e]=s["_"+e]}),s._cardData){let e=Object.keys(s._cardData);e.sort(),e.forEach(e=>{r[e]=s._cardData[e]})}return r}stringifyInner(s,i){if(void 0!==s){if("number"==typeof s)return Number.isFinite(s)?""+s:"null";if("object"!=typeof s)return JSON.stringify(s);let t;if(Array.isArray(s)){t="[";for(let e=0;e<s.length;e++)0<e&&(t+=","),t+=this.stringifyInner(s[e],i)||"null";return t+"]"}if(null===s)return"null";if(i.has(s))throw new TypeError("Converting circular structure to JSON");var e;if(i.add(s),s.constructor===window.Map)return e={__map:!0,values:[...s]},this.stringifyInner(e,i);var r=Object.keys(s).sort();t="";for(let e=0;e<r.length;e++){var a=r[e],o=this.stringifyInner(s[a],i,t);o&&(""!==t&&(t+=","),t+=JSON.stringify(a)+":"+o)}return i.delete(s),"{"+t+"}"}}stringify(e){var t=new Set;return this.stringifyInner(e,t)}parse(e){return JSON.parse(e,(e,t)=>"object"==typeof t&&null!==t&&t.__map?new Map(t.values):t)}}},3700:()=>{}}]);