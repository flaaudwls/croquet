(globalThis.webpackChunk_croquet_microverse=globalThis.webpackChunk_croquet_microverse||[]).push([[506],{1478:(e,t,r)=>{"use strict";r.r(t),r.d(t,{startShell:()=>function startShell(){a=new Shell}});var s=r(4200);const o="croquet:microverse:";let a;class Shell{constructor(){var e=shellToCanonicalURL(location.href),e=(e!==location.href&&(console.log("shell: redirecting to canonical URL",e),location.href=e),console.log("shell: starting"),this.frames=new Map,this.portalData=new Map,this.awaitedFrameTypes={},this.awaitedRenders={},s.App.autoSession(),s.App.autoPassword(),this.primaryFrameId=this.addFrame(null,s.App.sessionURL)),t=frameToPortalURL(this.primaryFrame.src);window.history.replaceState({portalId:e},null,t),setTitle(t);const r=document.getElementById("hud"),a=(r.parentElement.removeChild(r),document.getElementById("shell-hud"));if(a.classList.toggle("is-shell",!0),window.addEventListener("message",e=>{if(e.data?.message?.startsWith?.(o)){var t,r,a=e.data.message.substring(o.length);for([t,{frame:r}]of this.frames)if(e.source===r.contentWindow)return void this.receiveFromPortal(t,r,a,e.data);console.warn(`shell: ignoring ${a} from removed frame`)}}),window.addEventListener("popstate",e=>{let t=e.state["portalId"],r=this.frameEntry(t)?.frame;if(!r){const o=frameToPortalURL(shellToCanonicalURL(location.href));for(var[a,{frame:s}]of this.frames)if(frameToPortalURL(s.src)===o){r=s,t=a;break}}r||location.reload();const o=frameToPortalURL(r.src);o===shellToCanonicalURL(location.href)?(this.activateFrame(t,!1),setTitle(o)):console.warn(`shell: popstate location=${location}
does not match portal-${t} frame.src=`+r.src)}),this.fullscreenBttn=document.getElementById("fullscreenBttn"),this.fullscreenBttn.onclick=e=>{e.stopPropagation(),e.preventDefault(),e.shiftKey?document.body.classList.toggle("tilt"):document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.body.requestFullscreen()},this.capturedPointers={},this.joystick=document.getElementById("joystick"),this.knob=document.getElementById("knob"),this.trackingknob=document.getElementById("trackingknob"),this.knobStyle=window.getComputedStyle(this.knob),window.onresize=()=>this.adjustJoystickKnob(),!document.head.querySelector("#joystick-css")){let e=document.createElement("link");e.rel="stylesheet",e.type="text/css",e.id="joystick-css",e.onload=()=>this.adjustJoystickKnob(),e.href="./assets/css/joystick.css",document.head.appendChild(e)}this.releaseHandler=e=>{for(var t in this.capturedPointers)this.trackingknob.releasePointerCapture(t);this.capturedPointers={},this.endMMotion(e)},this.trackingknob.onpointerdown=e=>{void 0!==e.pointerId&&(this.capturedPointers[e.pointerId]="hiddenKnob",this.trackingknob.setPointerCapture(e.pointerId)),this.startMMotion(e)},this.trackingknob.onpointermove=e=>this.updateMMotion(e),this.trackingknob.onpointerup=e=>this.releaseHandler(e),this.trackingknob.onpointercancel=e=>this.releaseHandler(e),this.trackingknob.onlostpointercapture=e=>this.releaseHandler(e)}adjustJoystickKnob(){var e=parseFloat(this.knobStyle.width)/2||30;this.trackingknob.style.transform="translate(0px, 0px)",this.knob.style.transform=`translate(${e}px, ${e}px)`}frameEntry(e){return this.frames.get(e)}frameFromId(e){return this.frameEntry(e)?.frame}portalId(e){for(var[t,{frame:r}]of this.frames)if(r===e)return t;return null}get primaryFrame(){return this.frameFromId(this.primaryFrameId)}addFrame(e,t){if(4<=this.frames.size)throw Error("shell: refusing to create more than 4 frames (this indicates a portal bug)");let r;for(;r=Math.random().toString(36).substring(2,15),this.frames.has(r););const a=document.createElement("iframe");a.src=portalToFrameURL(t,r),a.style.zIndex=-this.frames.size,a.style.setProperty("--tilt-z",-200*this.frames.size+"px");t={frame:a,owningFrame:e,ownedFrames:new Set};return e&&this.frameEntry(e)?.ownedFrames.add(r),this.frames.set(r,t),document.body.appendChild(a),this.sendFrameType(r),r}removeFrame(e){const t=this.frameEntry(e);if(t){const{frame:r,owningFrame:a,ownedFrames:s}=t;if(a&&(this.frameEntry(a)?.ownedFrames.delete(e),t.owningFrame=null),r!==this.primaryFrame){console.log("shell: removing frame "+e),r.remove(),this.frames.delete(e);for(const o of s.values())this.removeFrame(o);this.sortFrames(this.primaryFrame)}else console.log(`shell: primary frame ${e} is no longer owned`)}}sortFrames(r,a){var t=Array.from(this.frames.values()).map(e=>e.frame).sort((e,t)=>e===r?-1:t===r?1:e===a?-1:t===a?1:e.zIndex-t.zIndex);for(let e=0;e<t.length;e++){const s=t[e]["style"];s.zIndex=-e,s.display="",s.setProperty("--tilt-z",-200*e+"px")}}receiveFromPortal(t,e,r,a){switch(r){case"frame-ready":{var s=t===this.primaryFrameId?"primary":"secondary";if(a.frameType!==s)return void console.log(`ignoring ${t} frame-ready (${a.frameType}) when expecting `+s);const n=this.frameEntry(t);if(!n)return;n.isMicroverse=!0;break}case"avatar-ready":{s=t===this.primaryFrameId?"primary":"secondary";if(a.frameType!==s)return void console.log(`ignoring ${t} avatar-ready (${a.frameType}) when expecting `+s);const i=this.frameEntry(t);return void(i&&(i.isMicroverse=!0,clearInterval(i.frameTypeInterval),i.frameTypeInterval=null,this.awaitedFrameTypes[t]&&(delete this.awaitedFrameTypes[t],0===Object.keys(this.awaitedFrameTypes).length&&this.sendToPortal(this.primaryFrameId,"release-freeze"))))}case"portal-open":if(a.portalId){s=portalToFrameURL(a.portalURL,a.portalId);const l=this.frameEntry(a.portalId)?.frame;return void(l&&portalToFrameURL(l.src,a.portalId)!==s&&(console.warn("shell: portal-open",a.portalId,"replacing",l.src,"with",s),l.src=s))}let e=this.findFrame(a.portalURL,e=>!e.owningFrame);return e?(this.frameEntry(e).owningFrame=t,this.frameEntry(t).ownedFrames.add(e)):e=this.addFrame(t,a.portalURL),this.sendToPortal(t,"portal-opened",{portalId:e}),void(t===this.primaryFrameId&&this.sortFrames(this.primaryFrame,this.frameFromId(e)));case"portal-close":return void this.removeFrame(a.portalId);case"portal-update":return t!==this.primaryFrameId?void console.log(`ignoring ${t} portal-update because it's no longer primary`):(this.awaitedRenders={},a.portalSpecs.forEach(e=>{var{portalId:e,cameraMatrix:t}=e,r=(this.sendToPortal(e,"portal-camera-update",{cameraMatrix:t}),this.frameEntry(e));r&&!r.frameTypeInterval&&null!==t&&(this.awaitedRenders[e]=!0),this.portalData.set(e,t)}),void(!this.portalRenderTimeout&&Object.keys(this.awaitedRenders).length&&(this.portalRenderTimeout=setTimeout(()=>{console.log("shell: portal render timed out"),delete this.portalRenderTimeout,this.awaitedRenders={},this.manuallyRenderPrimaryFrame()},200))));case"portal-world-rendered":return void(this.portalRenderTimeout&&this.awaitedRenders[t]&&(delete this.awaitedRenders[t],0===Object.keys(this.awaitedRenders).length&&(clearTimeout(this.portalRenderTimeout),delete this.portalRenderTimeout,this.manuallyRenderPrimaryFrame())));case"primary-rendered":return void(t===this.primaryFrameId?this.pendingSortFrames&&this.pendingSortFrames&&(this.sortFrames(...this.pendingSortFrames),delete this.pendingSortFrames):console.warn("shell: ignoring primary-rendered from non-primary "+t));case"portal-enter":return void(t===this.primaryFrameId?this.activateFrame(a.portalId,!0,a.transferData):console.warn("shell: ignoring portal-enter from non-primary portal-"+t));case"world-enter":if(t===this.primaryFrameId){let e=this.findFrame(a.portalURL);e||(console.log("shell: world-enter creating frame for",a.portalURL),e=this.addFrame(this.primaryFrameId,a.portalURL)),this.activateFrame(e,!0,a.transferData)}else console.warn("shell: ignoring world-enter from non-primary portal-"+t);return;case"hud":var s=a.joystick,o=a.fullscreen;return void 0!==s&&this.joystick&&(s?this.joystick.style.removeProperty("display"):this.joystick.style.setProperty("display","none")),void(void 0!==o&&this.fullscreenBttn&&(o?this.fullscreenBttn.style.removeProperty("display"):this.fullscreenBttn.style.setProperty("display","none")));default:console.warn(`shell: received unknown command "${r}" from portal-`+t,a)}}manuallyRenderPrimaryFrame(){var e=!!this.pendingSortFrames;this.sendToPortal(this.primaryFrameId,"sync-render-now",{acknowledgeReceipt:e})}findFrame(e,t=null){e=portalToFrameURL(e,"");e:for(var[r,a]of this.frames)if(!t||t(a)){a=a["frame"];if(a.src===e)return r;const i=new URL(e,a.src);if(a.src===i.href)return r;const l=new URL(a.src);if(l.origin===i.origin&&l.pathname===i.pathname){for(var[s,o]of i.searchParams){var n=l.searchParams.get(s);if(l.searchParams.delete(s),("portal"!==s&&"anchor"!==s||o&&n)&&("debug"!==s&&n!==o))continue e}if(""===l.searchParams.toString()){const m=new URLSearchParams(i.hash.slice(1)),d=new URLSearchParams(l.hash.slice(1));if(m.sort(),d.sort(),m.toString()===d.toString())return r}}}return null}sendToPortal(e,t,r={}){const a=this.frameFromId(e);a?(r.message=o+t,a.contentWindow?.postMessage(r,"*")):console.warn(`shell: sending "${t}" to portal-${e} failed: portal not found`)}sendFrameType(r,e=null){var t=this.primaryFrameId&&this.primaryFrameId!==r?"secondary":"primary";const a=this.frameEntry(r);if(a.frameTypeArgs={frameType:t,spec:e},!a.frameTypeInterval){const s=Date.now();a.frameTypeInterval=setInterval(()=>{if(!this.frameEntry(r))return console.log('shell: abandoning "frame-type" send for removed portal-'+r),void clearInterval(a.frameTypeInterval);if(2e4<Date.now()-s&&!a.isMicroverse)return console.log('shell: abandoning "frame-type" send for timed-out portal-'+r),void clearInterval(a.frameTypeInterval);const e=a.frameTypeArgs;var t;"secondary"===e.frameType&&(t=this.portalData.get(r))&&(e.cameraMatrix=t),this.sendToPortal(r,"frame-type",e)},200)}}activateFrame(t,e=!0,r=null){var a=this.frameEntry(t);if(a.isMicroverse){var s=this.primaryFrameId;const i=this.primaryFrame;var o=this.frameFromId(t),n=frameToPortalURL(o.src);if(this.pendingSortFrames=[o,i],this.pendingSortTimeout&&clearTimeout(this.pendingSortTimeout),this.pendingSortTimeout=setTimeout(()=>{this.pendingSortFrames&&(console.warn("sorting frames after timeout"),this.sortFrames(...this.pendingSortFrames),delete this.pendingSortFrames)},2e3),r&&!r.crossingBackwards&&(i.style.display="none"),e)try{window.history.pushState({portalId:t},null,n)}catch(e){new URL(n,location.href).origin===window.location.origin&&console.error(e),window.history.pushState({portalId:t},null,function portalToShellURL(e){const t=new URL(e,location.href),r=new URL(location.href);for(var[a,s]of t.searchParams)r.searchParams.set(a,s);return t.search="",r.hash=t.hash,t.hash="",r.searchParams.set("canonical",t.href),r.toString()}(n))}setTitle(n),this.primaryFrameId=t,this.portalData.delete(t),this.awaitedRenders={},this.awaitedFrameTypes={},this.frameEntry(s).owningFrame?(console.log('shell: sending frame-type "secondary" to portal-'+s,{portalURL:n}),this.sendFrameType(s,{portalURL:n}),this.awaitedFrameTypes[s]=!0):(console.log("shell: removing unowned secondary frame "+s),this.removeFrame(s)),console.log('shell: sending frame-type "primary" to portal-'+t,r),this.primaryFrame.focus(),this.sendFrameType(t,r),this.awaitedFrameTypes[t]=!0,this.awaitedFramesTimeout&&clearTimeout(this.awaitedFramesTimeout),this.awaitedFramesTimeout=setTimeout(()=>{Object.keys(this.awaitedFrameTypes).length&&(console.warn("releasing freeze after timeout"),this.awaitedFrameTypes={},this.sendToPortal(this.primaryFrameId,"release-freeze"))},2e3),this.activeMMotion&&({dx:o,dy:e}=this.activeMMotion,this.sendToPortal(this.primaryFrameId,"motion-start",{dx:o,dy:e}))}else window.location.href=a.frame.src}startMMotion(e){e.preventDefault(),e.stopPropagation(),this.knobX=e.clientX,this.knobY=e.clientY,this.activeMMotion={dx:0,dy:0},this.sendToPortal(this.primaryFrameId,"motion-start")}endMMotion(e){e.preventDefault(),e.stopPropagation(),this.activeMMotion=null;e=parseFloat(this.knobStyle.width)/2;this.trackingknob.style.transform="translate(0px, 0px)",this.knob.style.transform=`translate(${e}px, ${e}px)`,this.sendToPortal(this.primaryFrameId,"motion-end")}updateMMotion(r){if(r.preventDefault(),r.stopPropagation(),this.activeMMotion){let e=r.clientX-this.knobX,t=r.clientY-this.knobY;var r=parseFloat(this.knobStyle.width)/2,a=parseFloat(this.knobStyle.left)/2,s=(this.sendToPortal(this.primaryFrameId,"motion-update",{dx:e,dy:t}),this.activeMMotion.dx=e,this.activeMMotion.dy=t,this.trackingknob.style.transform=`translate(${e}px, ${t}px)`,e**2+t**2);(r+a)**2<s&&(s=Math.sqrt(s),e=(r+a)*e/s,t=(r+a)*t/s),this.knob.style.transform=`translate(${r+e}px, ${r+t}px)`}}}function portalToFrameURL(e,t){const r=new URL(e,location.href);r.searchParams.set("portal",t);"default"===r.searchParams.get("world")&&r.searchParams.delete("world");e=r.pathname.split("/").pop(),"index.html"===e&&(r.pathname=r.pathname.slice(0,-10)),t=[...r.searchParams.entries()].sort((e,t)=>"world"===e[0]||"world"!==t[0]&&"portal"!==e[0]&&("portal"===t[0]||"q"!==e[0]&&("q"===t[0]||e[0]<t[0]))?-1:1);return r.search=new URLSearchParams(t).toString(),r.toString()}function frameToPortalURL(e){const t=new URL(e,location.href);t.searchParams.delete("portal");"default"===t.searchParams.get("world")&&t.searchParams.delete("world");e=t.pathname.split("/").pop();return"index.html"===e&&(t.pathname=t.pathname.slice(0,-10)),t.toString()}function shellToCanonicalURL(e){const t=new URL(e);var r=t.searchParams.get("canonical");if(!r)return e;t.searchParams.delete("canonical");const a=new URL(r);return a.search=t.search,a.hash=t.hash,a.toString()}function setTitle(e){e=e.startsWith(location.origin)?e.substr(location.origin.length+1):e.substr(e.indexOf("://")+3),document.title=e}},3700:()=>{}}]);